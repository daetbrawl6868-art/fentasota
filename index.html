<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>KVANT AI - Умный ассистент</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ============================================
   БАЗОВЫЕ СТИЛИ - APPLE COSMIC DESIGN SYSTEM
   ============================================ */

:root {
  /* Цветовая палитра */
  --color-black: #000000;
  --color-gray-950: #05050a;
  --color-gray-900: #0d0d14;
  --color-gray-850: #111118;
  --color-gray-800: #16161f;
  --color-gray-700: #1e1e2a;
  --color-gray-600: #2a2a38;
  --color-gray-500: #454560;
  --color-gray-400: #6060808;
  --color-gray-300: #8888aa;
  --color-gray-200: #aaaacc;
  --color-gray-100: #ccccee;
  --color-gray-50: #e8e8ff;
  
  /* Акцентные цвета - космические */
  --color-blue: #0a84ff;
  --color-blue-light: #5ac8fa;
  --color-blue-dark: #0055cc;
  --color-cyan: #32d8ff;
  --color-cyan-light: #64d2ff;
  --color-purple: #bf5af2;
  --color-purple-light: #d980fa;
  --color-indigo: #5e5ce6;
  --color-pink: #ff375f;
  
  /* Космические цвета (заменяем лесные) */
  --forest-dark-1: #03020d;
  --forest-dark-2: #050318;
  --forest-dark-3: #080522;
  --forest-dark-4: #0a072c;
  --forest-tree-1: rgba(10, 8, 35, 0.9);
  --forest-tree-2: rgba(15, 10, 45, 0.85);
  --forest-tree-3: rgba(20, 14, 55, 0.8);
  
  /* Стекло и прозрачность - темнее */
  --glass-ultra-thin: rgba(255, 255, 255, 0.015);
  --glass-thin: rgba(255, 255, 255, 0.03);
  --glass-regular: rgba(255, 255, 255, 0.05);
  --glass-medium: rgba(255, 255, 255, 0.075);
  --glass-thick: rgba(255, 255, 255, 0.11);
  --glass-ultra-thick: rgba(255, 255, 255, 0.16);
  
  /* Границы */
  --border-ultra-subtle: rgba(255, 255, 255, 0.04);
  --border-subtle: rgba(255, 255, 255, 0.08);
  --border-regular: rgba(255, 255, 255, 0.12);
  --border-medium: rgba(255, 255, 255, 0.18);
  --border-strong: rgba(255, 255, 255, 0.28);
  
  /* Тени */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.5);
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.5);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.5);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.6);
  --shadow-xl: 0 16px 32px rgba(0, 0, 0, 0.7);
  --shadow-2xl: 0 24px 48px rgba(0, 0, 0, 0.8);
  --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.3);
  
  /* Свечение - космическое */
  --glow-blue: 0 0 24px rgba(10, 132, 255, 0.45);
  --glow-blue-strong: 0 0 48px rgba(10, 132, 255, 0.7);
  --glow-cyan: 0 0 24px rgba(50, 216, 255, 0.45);
  --glow-purple: 0 0 24px rgba(191, 90, 242, 0.45);
  --glow-white: 0 0 20px rgba(255, 255, 255, 0.15);
  
  /* Размытие */
  --blur-sm: 10px;
  --blur-md: 20px;
  --blur-lg: 40px;
  --blur-xl: 60px;
  --blur-2xl: 80px;
  --blur-ultra: 120px;
  
  /* Радиусы */
  --radius-xs: 4px;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-2xl: 24px;
  --radius-3xl: 32px;
  --radius-full: 9999px;
  
  /* Размеры */
  --sidebar-width: 280px;
  --topbar-height: 64px;
  
  /* Типографика - Профессиональные шрифты */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
  
  /* Переходы - более естественные */
  --transition-fastest: 200ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-fast: 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-base: 450ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-smooth: 600ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-slowest: 800ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --transition-bounce: 650ms cubic-bezier(0.34, 1.45, 0.64, 1);
  --transition-elastic: 900ms cubic-bezier(0.34, 1.35, 0.64, 1);
  
  /* Z-index */
  --z-base: 0;
  --z-forest: 1;
  --z-content: 10;
  --z-sidebar: 100;
  --z-topbar: 200;
  --z-dropdown: 300;
  --z-modal: 400;
  --z-toast: 500;
  --z-tooltip: 600;
}

/* ============================================
   СВЕТЛАЯ ТЕМА - GLASSMORPHISM
   ============================================ */

body.light-theme {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #1d1d1f;
}

body.light-theme .forest-background {
  opacity: 0.15; /* Космос виден через стекло */
}

/* Стеклянные панели */
body.light-theme .sidebar {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-right: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 
    0 8px 32px rgba(31, 38, 135, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

body.light-theme .topbar {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 
    0 4px 24px rgba(31, 38, 135, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

/* Сообщения */
body.light-theme .message-bubble {
  background: rgba(255, 255, 255, 0.35);
  backdrop-filter: blur(10px) saturate(150%);
  -webkit-backdrop-filter: blur(10px) saturate(150%);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 4px 16px rgba(31, 38, 135, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
  color: #1d1d1f;
}

body.light-theme .message-bubble.user {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow: 
    0 8px 24px rgba(102, 126, 234, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  color: white;
}

/* Поле ввода */
body.light-theme .input-container {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 8px 32px rgba(31, 38, 135, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

body.light-theme .chat-input {
  color: #1d1d1f;
  background: transparent;
}

body.light-theme .chat-input::placeholder {
  color: rgba(29, 29, 31, 0.5);
}

/* Кнопки */
body.light-theme .btn-icon {
  color: #1d1d1f;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.light-theme .btn-icon:hover {
  background: rgba(255, 255, 255, 0.4);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(31, 38, 135, 0.15);
}

body.light-theme .btn-primary {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 
    0 8px 24px rgba(102, 126, 234, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

body.light-theme .btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 
    0 12px 32px rgba(102, 126, 234, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Модальные окна */
body.light-theme .modal-content {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(30px) saturate(180%);
  -webkit-backdrop-filter: blur(30px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 24px 64px rgba(31, 38, 135, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

body.light-theme .modal-header {
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.15);
}

body.light-theme .form-group label,
body.light-theme .modal-title {
  color: #1d1d1f;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
}

/* Формы */
body.light-theme .form-input,
body.light-theme .form-select,
body.light-theme .form-textarea {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #1d1d1f;
  box-shadow: inset 0 1px 3px rgba(31, 38, 135, 0.1);
}

body.light-theme .form-input:focus,
body.light-theme .form-select:focus,
body.light-theme .form-textarea:focus {
  background: rgba(255, 255, 255, 0.35);
  border-color: rgba(255, 255, 255, 0.5);
  box-shadow: 
    0 0 0 4px rgba(102, 126, 234, 0.15),
    inset 0 1px 3px rgba(31, 38, 135, 0.1);
}

/* Статистика */
body.light-theme .stats-card {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(15px) saturate(180%);
  -webkit-backdrop-filter: blur(15px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 8px 24px rgba(31, 38, 135, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

body.light-theme .stats-value {
  color: #1d1d1f;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
}

/* Чаты */
body.light-theme .chat-item {
  color: #1d1d1f;
  background: transparent;
  border-radius: 12px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body.light-theme .chat-item:hover {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(31, 38, 135, 0.1);
}

body.light-theme .chat-item.active {
  background: rgba(102, 126, 234, 0.2);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-left: 3px solid #667eea;
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
}

/* Светлая тема для страницы авторизации */
body.light-theme .auth-card {
  background: rgba(255,255,255,0.35);
  border: 2px solid rgba(255,255,255,0.5);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  box-shadow:
    inset 0 2px 0 rgba(255,255,255,0.8),
    inset 0 -2px 0 rgba(255,255,255,0.3),
    0 30px 80px rgba(102, 126, 234, 0.3),
    0 10px 40px rgba(118, 75, 162, 0.2);
}

body.light-theme .auth-card::before {
  background: conic-gradient(from 0deg,
    transparent 0deg,
    rgba(102, 126, 234, 0.5) 72deg,
    rgba(118, 75, 162, 0.6) 144deg,
    rgba(191, 90, 242, 0.4) 216deg,
    rgba(50, 216, 255, 0.4) 288deg,
    transparent 360deg
  );
  opacity: 0.9;
}

body.light-theme .auth-title {
  background: linear-gradient(135deg,
    #667eea 0%, 
    #764ba2 50%, 
    #667eea 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

body.light-theme .auth-subtitle {
  color: rgba(102, 126, 234, 0.7);
}

body.light-theme .auth-logo {
  background: rgba(255,255,255,0.3);
  border: 2px solid rgba(255,255,255,0.5);
  box-shadow:
    inset 0 2px 0 rgba(255,255,255,0.8),
    0 10px 40px rgba(102, 126, 234, 0.4);
}

body.light-theme .form-input {
  background: rgba(255,255,255,0.3);
  border: 2px solid rgba(255,255,255,0.4);
  color: #1d1d1f;
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.6),
    0 4px 12px rgba(102, 126, 234, 0.1);
}

body.light-theme .form-input::placeholder {
  color: rgba(29, 29, 31, 0.4);
}

body.light-theme .form-input:focus {
  background: rgba(255,255,255,0.4);
  border-color: rgba(102, 126, 234, 0.8);
  box-shadow:
    0 0 0 4px rgba(102, 126, 234, 0.2),
    inset 0 1px 0 rgba(255,255,255,0.8),
    0 4px 20px rgba(102, 126, 234, 0.3);
}

body.light-theme .input-icon {
  color: rgba(102, 126, 234, 0.6);
}

body.light-theme .form-input-wrap:focus-within .input-icon {
  color: rgba(102, 126, 234, 0.95);
}

body.light-theme .btn-google {
  background: rgba(255,255,255,0.35);
  border: 2px solid rgba(255,255,255,0.5);
  color: #1d1d1f;
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.8),
    0 4px 16px rgba(102, 126, 234, 0.2);
}

body.light-theme .btn-google:hover {
  background: rgba(255,255,255,0.5);
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.9),
    0 8px 24px rgba(102, 126, 234, 0.3);
}

body.light-theme .auth-divider {
  color: rgba(102, 126, 234, 0.6);
}

body.light-theme .auth-divider::before,
body.light-theme .auth-divider::after {
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(102, 126, 234, 0.2) 20%,
    rgba(102, 126, 234, 0.3) 50%,
    rgba(102, 126, 234, 0.2) 80%,
    transparent 100%
  );
}

body.light-theme .auth-tab {
  color: rgba(29, 29, 31, 0.6);
}

body.light-theme .auth-tab.active {
  color: #1d1d1f;
}

body.light-theme .auth-feature-pill {
  background: rgba(255,255,255,0.3);
  border: 1.5px solid rgba(255,255,255,0.4);
  color: rgba(102, 126, 234, 0.8);
}

body.light-theme .auth-feature-pill:hover {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.5);
  color: rgba(102, 126, 234, 0.95);
}

/* Тосты */
body.light-theme .toast {
  background: rgba(255, 255, 255, 0.35);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 8px 32px rgba(31, 38, 135, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
  color: #1d1d1f;
}

/* Переключатели */
body.light-theme .toggle-switch {
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

body.light-theme .toggle-checkbox:checked + .toggle-switch {
  background: linear-gradient(135deg, #667eea, #764ba2);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-tap-highlight-color: transparent;
}

html {
  height: 100%;
  height: -webkit-fill-available;
  font-size: 16px;
}

body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: var(--font-sans);
  background: #000000;
  color: white;
  font-size: 15px;
  line-height: 1.5;
  font-weight: 400;
  position: fixed;
  overscroll-behavior: none;
  letter-spacing: -0.01em;
}

/* ============================================
   КОСМИЧЕСКИЙ ФОН - РЕАЛИСТИЧНЫЙ
   ============================================ */

.forest-background {
  position: fixed;
  inset: 0;
  z-index: var(--z-forest);
  overflow: hidden;
  pointer-events: none;
}

/* Базовый градиент космоса */
.forest-sky {
  position: absolute;
  inset: 0;
  background: 
    radial-gradient(ellipse 180% 100% at 20% 0%, #0d0520 0%, transparent 60%),
    radial-gradient(ellipse 140% 80% at 80% 100%, #020514 0%, transparent 50%),
    radial-gradient(ellipse 200% 120% at 50% 50%, #060312 0%, #010109 60%, #000000 100%);
}

/* Млечный путь */
.forest-fog {
  position: absolute;
  inset: 0;
  background: 
    radial-gradient(ellipse 600px 1200px at 60% 50%,
      rgba(100, 80, 200, 0.08) 0%,
      rgba(80, 60, 180, 0.05) 30%,
      rgba(60, 40, 140, 0.03) 60%,
      transparent 80%
    ),
    radial-gradient(ellipse 400px 800px at 30% 70%,
      rgba(50, 216, 255, 0.05) 0%,
      rgba(10, 132, 255, 0.03) 40%,
      transparent 70%
    );
  transform: rotate(-25deg) scale(1.5);
  animation: milkyWayDrift 80s ease-in-out infinite;
}

@keyframes milkyWayDrift {
  0%, 100% { 
    opacity: 0.8;
    transform: rotate(-25deg) scale(1.5) translateX(0);
  }
  50% { 
    opacity: 1;
    transform: rotate(-25deg) scale(1.55) translateX(2%);
  }
}

/* Дальний слой звёзд — очень мелкие, много */
.forest-layer-far {
  position: absolute;
  inset: 0;
  animation: starsLayerDrift1 120s ease-in-out infinite;
}

/* Средний слой звёзд — среднего размера */
.forest-layer-mid {
  position: absolute;
  inset: 0;
  animation: starsLayerDrift2 90s ease-in-out infinite;
}

/* Ближний слой — туманности */
.forest-layer-near {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 800px 600px at 15% 20%, rgba(94, 92, 230, 0.12) 0%, rgba(94, 92, 230, 0.06) 40%, transparent 70%),
    radial-gradient(ellipse 600px 400px at 75% 65%, rgba(191, 90, 242, 0.10) 0%, rgba(100, 50, 200, 0.05) 50%, transparent 75%),
    radial-gradient(ellipse 700px 500px at 45% 85%, rgba(10, 132, 255, 0.08) 0%, rgba(50, 80, 200, 0.04) 50%, transparent 70%),
    radial-gradient(ellipse 500px 300px at 88% 15%, rgba(50, 216, 255, 0.09) 0%, transparent 60%);
  animation: nebulaFloat 50s ease-in-out infinite;
  filter: blur(30px);
}

@keyframes nebulaFloat {
  0%, 100% { 
    transform: scale(1) translate(0, 0) rotate(0deg); 
    opacity: 0.85; 
    filter: blur(35px) hue-rotate(0deg);
  }
  25% { 
    transform: scale(1.06) translate(-2%, 1.5%) rotate(3deg); 
    opacity: 1; 
    filter: blur(28px) hue-rotate(8deg);
  }
  50% { 
    transform: scale(1.03) translate(1.5%, -2%) rotate(-2deg); 
    opacity: 0.95; 
    filter: blur(32px) hue-rotate(12deg);
  }
  75% { 
    transform: scale(0.96) translate(-1%, 2%) rotate(4deg); 
    opacity: 0.80; 
    filter: blur(30px) hue-rotate(5deg);
  }
}

/* Самый ближний слой - яркие одиночные звёзды */
.forest-layer-closest {
  position: absolute;
  inset: 0;
  /* Яркие звезды с блеском */
  background-image:
    radial-gradient(circle 2px at 8% 12%, rgba(255,255,255,0.95) 0%, transparent 2px),
    radial-gradient(circle 1.5px at 22% 5%, rgba(200,220,255,0.9) 0%, transparent 1.5px),
    radial-gradient(circle 2.5px at 35% 18%, rgba(255,255,255,1) 0%, transparent 2.5px),
    radial-gradient(circle 1px at 48% 8%, rgba(180,200,255,0.85) 0%, transparent 1px),
    radial-gradient(circle 2px at 62% 22%, rgba(255,255,255,0.9) 0%, transparent 2px),
    radial-gradient(circle 1.5px at 77% 7%, rgba(220,240,255,0.95) 0%, transparent 1.5px),
    radial-gradient(circle 3px at 91% 15%, rgba(255,255,255,1) 0%, transparent 3px),
    radial-gradient(circle 1px at 14% 32%, rgba(200,220,255,0.8) 0%, transparent 1px),
    radial-gradient(circle 2px at 28% 42%, rgba(255,255,255,0.85) 0%, transparent 2px),
    radial-gradient(circle 1.5px at 55% 38%, rgba(230,240,255,0.9) 0%, transparent 1.5px),
    radial-gradient(circle 1px at 70% 45%, rgba(255,255,255,0.75) 0%, transparent 1px),
    radial-gradient(circle 2.5px at 84% 35%, rgba(200,220,255,0.95) 0%, transparent 2.5px),
    radial-gradient(circle 1px at 5% 55%, rgba(255,255,255,0.7) 0%, transparent 1px),
    radial-gradient(circle 2px at 40% 62%, rgba(230,245,255,0.85) 0%, transparent 2px),
    radial-gradient(circle 1.5px at 95% 52%, rgba(255,255,255,0.9) 0%, transparent 1.5px),
    radial-gradient(circle 1px at 18% 72%, rgba(200,220,255,0.75) 0%, transparent 1px),
    radial-gradient(circle 3px at 65% 68%, rgba(255,255,255,0.95) 0%, transparent 3px),
    radial-gradient(circle 1.5px at 87% 75%, rgba(220,235,255,0.85) 0%, transparent 1.5px),
    radial-gradient(circle 2px at 32% 82%, rgba(255,255,255,0.8) 0%, transparent 2px),
    radial-gradient(circle 1px at 52% 88%, rgba(200,220,255,0.7) 0%, transparent 1px),
    radial-gradient(circle 2px at 75% 90%, rgba(255,255,255,0.85) 0%, transparent 2px);
  animation: starsLayerDrift3 60s ease-in-out infinite;
}

/* Звёздные блики (крест) для ярких звёзд */
.forest-layer-closest::after {
  content: '';
  position: absolute;
  inset: 0;
  background-image:
    /* Блик яркой звезды - крест */
    linear-gradient(0deg, transparent 49.5%, rgba(255,255,255,0.25) 50%, transparent 50.5%) no-repeat 91% 15% / 40px 1px,
    linear-gradient(90deg, transparent 49.5%, rgba(255,255,255,0.25) 50%, transparent 50.5%) no-repeat 91% 15% / 1px 40px,
    linear-gradient(0deg, transparent 49.5%, rgba(255,255,255,0.2) 50%, transparent 50.5%) no-repeat 35% 18% / 30px 1px,
    linear-gradient(90deg, transparent 49.5%, rgba(255,255,255,0.2) 50%, transparent 50.5%) no-repeat 35% 18% / 1px 30px;
  pointer-events: none;
}

@keyframes starsLayerDrift1 {
  0%, 100% { opacity: 0.7; transform: translateX(0) translateY(0); }
  25% { opacity: 0.85; transform: translateX(-0.5%) translateY(-0.2%); }
  50% { opacity: 0.95; transform: translateX(-0.3%) translateY(0.3%); }
  75% { opacity: 0.8; transform: translateX(0.2%) translateY(0.1%); }
}
@keyframes starsLayerDrift2 {
  0%, 100% { opacity: 0.6; transform: translateX(0) translateY(0) scale(1); }
  33% { opacity: 0.75; transform: translateX(0.6%) translateY(-0.3%) scale(1.002); }
  66% { opacity: 0.85; transform: translateX(0.4%) translateY(0.4%) scale(1.004); }
}
@keyframes starsLayerDrift3 {
  0%, 100% { opacity: 0.85; transform: scale(1) rotate(0deg); }
  50% { opacity: 1; transform: scale(1.008) rotate(0.2deg); }
}

/* Аврора / Полярное сияние */
.aurora-strip {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 1200px 200px at 25% 55%,
      rgba(50, 200, 100, 0.06) 0%,
      rgba(40, 180, 120, 0.03) 50%,
      transparent 80%
    ),
    radial-gradient(ellipse 900px 150px at 70% 40%,
      rgba(100, 50, 220, 0.08) 0%,
      rgba(80, 40, 200, 0.04) 50%,
      transparent 75%
    ),
    radial-gradient(ellipse 600px 100px at 50% 50%,
      rgba(10, 132, 255, 0.06) 0%,
      transparent 70%
    );
  filter: blur(20px);
  animation: auroraFlow 20s ease-in-out infinite alternate;
  opacity: 0.7;
}

@keyframes auroraFlow {
  0% { transform: translateX(-4%) translateY(-2%) scaleY(0.7); opacity: 0.4; filter: blur(25px) hue-rotate(0deg); }
  25% { transform: translateX(1%) translateY(1%) scaleY(1.3); opacity: 0.75; filter: blur(18px) hue-rotate(10deg); }
  50% { transform: translateX(3%) translateY(-1%) scaleY(0.85); opacity: 0.85; filter: blur(22px) hue-rotate(15deg); }
  75% { transform: translateX(-1%) translateY(2%) scaleY(1.15); opacity: 0.6; filter: blur(20px) hue-rotate(5deg); }
  100% { transform: translateX(-4%) translateY(-2%) scaleY(0.7); opacity: 0.4; filter: blur(25px) hue-rotate(0deg); }
}

/* Звёздное небо — canvas рендеринг через JS */
.stars {
  position: absolute;
  inset: 0;
  /* Базовые мелкие звёзды через CSS */
  background-image:
    /* Слой 1 - очень мелкие звёзды */
    radial-gradient(0.5px 0.5px at 3% 7%, rgba(255,255,255,0.6) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 11% 4%, rgba(230,240,255,0.5) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 19% 9%, rgba(255,255,255,0.55) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 27% 3%, rgba(200,220,255,0.45) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 38% 6%, rgba(255,255,255,0.6) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 46% 2%, rgba(220,235,255,0.5) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 57% 8%, rgba(255,255,255,0.55) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 68% 5%, rgba(210,230,255,0.45) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 79% 10%, rgba(255,255,255,0.6) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 88% 3%, rgba(230,245,255,0.5) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 96% 7%, rgba(255,255,255,0.55) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 7% 17%, rgba(200,220,255,0.4) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 15% 22%, rgba(255,255,255,0.5) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 24% 15%, rgba(220,235,255,0.45) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 33% 25%, rgba(255,255,255,0.55) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 44% 19%, rgba(210,225,255,0.4) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 53% 28%, rgba(255,255,255,0.5) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 63% 13%, rgba(230,240,255,0.45) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 72% 20%, rgba(255,255,255,0.55) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 82% 16%, rgba(200,220,255,0.4) 0%, transparent 0.5px),
    radial-gradient(0.5px 0.5px at 92% 24%, rgba(255,255,255,0.5) 0%, transparent 0.5px),
    /* Слой 2 - мелкие звёзды */
    radial-gradient(1px 1px at 5% 40%, rgba(255,255,255,0.4) 0%, transparent 1px),
    radial-gradient(1px 1px at 13% 47%, rgba(220,240,255,0.35) 0%, transparent 1px),
    radial-gradient(1px 1px at 23% 35%, rgba(255,255,255,0.45) 0%, transparent 1px),
    radial-gradient(1px 1px at 34% 52%, rgba(200,225,255,0.3) 0%, transparent 1px),
    radial-gradient(1px 1px at 45% 43%, rgba(255,255,255,0.4) 0%, transparent 1px),
    radial-gradient(1px 1px at 58% 37%, rgba(230,245,255,0.35) 0%, transparent 1px),
    radial-gradient(1px 1px at 69% 48%, rgba(255,255,255,0.45) 0%, transparent 1px),
    radial-gradient(1px 1px at 78% 41%, rgba(210,230,255,0.3) 0%, transparent 1px),
    radial-gradient(1px 1px at 89% 55%, rgba(255,255,255,0.4) 0%, transparent 1px),
    radial-gradient(1px 1px at 97% 38%, rgba(220,240,255,0.35) 0%, transparent 1px),
    radial-gradient(1px 1px at 2% 62%, rgba(255,255,255,0.35) 0%, transparent 1px),
    radial-gradient(1px 1px at 17% 70%, rgba(200,220,255,0.3) 0%, transparent 1px),
    radial-gradient(1px 1px at 29% 65%, rgba(255,255,255,0.4) 0%, transparent 1px),
    radial-gradient(1px 1px at 41% 75%, rgba(220,240,255,0.25) 0%, transparent 1px),
    radial-gradient(1px 1px at 54% 68%, rgba(255,255,255,0.35) 0%, transparent 1px),
    radial-gradient(1px 1px at 67% 80%, rgba(210,230,255,0.3) 0%, transparent 1px),
    radial-gradient(1px 1px at 80% 72%, rgba(255,255,255,0.4) 0%, transparent 1px),
    radial-gradient(1px 1px at 93% 67%, rgba(230,245,255,0.25) 0%, transparent 1px);
  opacity: 1;
}

#star-canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

/* Туманности и космические орбы */
.light-orbs {
  position: absolute;
  inset: 0;
  background: 
    radial-gradient(ellipse 900px 600px at 8% 20%, rgba(94, 92, 230, 0.18) 0%, rgba(94, 92, 230, 0.08) 40%, transparent 65%),
    radial-gradient(ellipse 700px 500px at 90% 75%, rgba(191, 90, 242, 0.15) 0%, rgba(100, 30, 180, 0.07) 50%, transparent 70%),
    radial-gradient(ellipse 500px 400px at 50% 45%, rgba(10, 132, 255, 0.12) 0%, rgba(30, 60, 200, 0.06) 50%, transparent 75%),
    radial-gradient(ellipse 600px 300px at 75% 10%, rgba(50, 216, 255, 0.10) 0%, rgba(20, 100, 200, 0.05) 40%, transparent 65%),
    radial-gradient(ellipse 400px 500px at 20% 85%, rgba(255, 55, 95, 0.06) 0%, rgba(200, 40, 80, 0.03) 50%, transparent 70%);
  animation: cosmicOrbsFloat 30s ease-in-out infinite;
  filter: blur(2px);
}

@keyframes cosmicOrbsFloat {
  0%, 100% { 
    transform: translate(0, 0) scale(1);
    opacity: 0.85;
  }
  33% { 
    transform: translate(-2%, 1%) scale(1.04);
    opacity: 1;
  }
  66% { 
    transform: translate(1.5%, -1.5%) scale(0.97);
    opacity: 0.9;
  }
}

/* Текстура зерна */
.grain-texture {
  position: absolute;
  inset: 0;
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"><filter id="noiseFilter"><feTurbulence type="fractalNoise" baseFrequency="0.95" numOctaves="4" stitchTiles="stitch"/></filter><rect width="300" height="300" filter="url(%23noiseFilter)" opacity="0.03"/></svg>');
  opacity: 0.7;
  mix-blend-mode: overlay;
  animation: grainAnimation 8s steps(10) infinite;
}

@keyframes grainAnimation {
  0%, 100% { transform: translate(0, 0); }
  10% { transform: translate(-5%, -10%); }
  20% { transform: translate(-15%, 5%); }
  30% { transform: translate(7%, -25%); }
  40% { transform: translate(-5%, 25%); }
  50% { transform: translate(-25%, 10%); }
  60% { transform: translate(25%, 0%); }
  70% { transform: translate(5%, 15%); }
  80% { transform: translate(-10%, 10%); }
  90% { transform: translate(15%, -15%); }
}

/* Виньетка */
.vignette {
  position: absolute;
  inset: 0;
  background: 
    radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.65) 100%),
    linear-gradient(180deg, rgba(0,0,0,0.45) 0%, rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.35) 100%);
  pointer-events: none;
}

/* Дополнительный blur overlay поверх всего фона */
.bg-blur-overlay {
  position: absolute;
  inset: 0;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  background: rgba(0, 0, 3, 0.45);
  pointer-events: none;
  z-index: 2;
  opacity: 0.85;
}

/* Отключаем только grain-texture для оптимизации */
.grain-texture {
  display: none;
}

/* Упрощаем звёзды */
#star-canvas {
  opacity: 0.5;
}

/* Включаем слои космоса с уменьшенной opacity для эффекта стекла */
.forest-layer-closest {
  opacity: 0.6;
}

.forest-layer-near {
  opacity: 0.7;
}

/* Оптимизация анимаций - используем will-change */
.loading-atom,
.message-wrapper,
.chat-item {
  will-change: transform;
}

/* Отключаем blur на мобильных для производительности */
@media (max-width: 768px) {
  .sidebar,
  .topbar,
  .auth-card,
  .modal-content {
    backdrop-filter: blur(20px) !important;
    -webkit-backdrop-filter: blur(20px) !important;
  }
}

/* ============================================
   ЭКРАН ЗАГРУЗКИ
   ============================================ */

#loading-screen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, 
    rgba(3, 2, 16, 0.98) 0%,
    rgba(7, 5, 28, 0.96) 50%,
    rgba(10, 7, 35, 0.98) 100%
  );
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
              visibility 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

#loading-screen.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0;
  position: relative;
  z-index: 1;
}

/* Атом загрузки */
.loading-atom {
  width: 400px;
  height: 400px;
  position: relative;
  animation: atomBreath 3s ease-in-out infinite;
}

@keyframes atomBreath {
  0%, 100% { 
    transform: scale(1) rotate(0deg);
    filter: drop-shadow(0 0 60px rgba(10, 132, 255, 0.7)) drop-shadow(0 0 100px rgba(94, 92, 230, 0.4));
  }
  25% { 
    transform: scale(1.08) rotate(90deg);
    filter: drop-shadow(0 0 80px rgba(50, 216, 255, 0.9)) drop-shadow(0 0 120px rgba(191, 90, 242, 0.5));
  }
  50% { 
    transform: scale(1.12) rotate(180deg);
    filter: drop-shadow(0 0 100px rgba(10, 132, 255, 1)) drop-shadow(0 0 140px rgba(94, 92, 230, 0.7));
  }
  75% { 
    transform: scale(1.08) rotate(270deg);
    filter: drop-shadow(0 0 80px rgba(191, 90, 242, 0.9)) drop-shadow(0 0 120px rgba(50, 216, 255, 0.5));
  }
}

.loading-atom svg {
  width: 100%;
  height: 100%;
}

.orbit {
  opacity: 0;
  animation: orbitFadeIn 1s ease-out forwards;
}

.orbit-1 {
  animation-delay: 0.3s;
  transform-origin: center;
}

.orbit-2 {
  animation-delay: 0.6s;
  transform: rotate(60deg);
  transform-origin: center;
}

.orbit-3 {
  animation-delay: 0.9s;
  transform: rotate(120deg);
  transform-origin: center;
}

@keyframes orbitFadeIn {
  from {
    opacity: 0;
    stroke-dasharray: 1000;
    stroke-dashoffset: 1000;
  }
  to {
    opacity: 0.8;
    stroke-dasharray: 1000;
    stroke-dashoffset: 0;
  }
}

.electron-group {
  filter: drop-shadow(0 0 10px currentColor);
}

.nucleus-group {
  filter: drop-shadow(0 0 25px rgba(10, 132, 255, 0.9));
}

.energy-waves {
  animation: wavesPulse 4s ease-in-out infinite;
}

@keyframes wavesPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

/* Текст загрузки - скрываем все кроме атома */
.loading-text,
.loading-details,
.loading-progress,
.loading-particles {
  display: none;
}

/* Текст загрузки */
.loading-text {
  text-align: center;
  animation: textFadeIn 1s ease-out 0.8s both;
}

@keyframes textFadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.loading-title {
  font-size: 36px;
  font-weight: 900;
  letter-spacing: -0.02em;
  margin-bottom: 8px;
  background: linear-gradient(135deg,
    #fff 0%,
    rgba(90, 200, 250, 0.95) 40%,
    rgba(50, 216, 255, 0.88) 70%,
    rgba(191, 90, 242, 0.82) 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 40px rgba(10, 132, 255, 0.3);
}

.loading-subtitle {
  font-size: 14px;
  font-weight: 500;
  color: rgba(180, 200, 240, 0.6);
  letter-spacing: 0.05em;
  animation: subtitlePulse 2s ease-in-out infinite;
  transition: all 0.5s ease;
}

@keyframes subtitlePulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

/* Детальные этапы загрузки */
.loading-details {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 400px;
  animation: detailsFadeIn 0.8s ease-out 0.5s both;
}

@keyframes detailsFadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.loading-step {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 14px 18px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 14px;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0.4;
}

.loading-step.active {
  opacity: 1;
  background: rgba(10, 132, 255, 0.08);
  border-color: rgba(10, 132, 255, 0.3);
  box-shadow: 
    0 0 20px rgba(10, 132, 255, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  transform: translateX(8px);
}

.loading-step.completed {
  opacity: 0.7;
  background: rgba(16, 185, 129, 0.08);
  border-color: rgba(16, 185, 129, 0.3);
}

.step-icon {
  font-size: 24px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  flex-shrink: 0;
  transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.loading-step.active .step-icon {
  transform: scale(1.15) rotate(10deg);
  background: rgba(10, 132, 255, 0.15);
}

.loading-step.completed .step-icon {
  background: rgba(16, 185, 129, 0.15);
}

.step-info {
  flex: 1;
  min-width: 0;
}

.step-name {
  font-size: 14px;
  font-weight: 600;
  color: rgba(230, 240, 255, 0.9);
  margin-bottom: 3px;
  letter-spacing: -0.01em;
}

.step-status {
  font-size: 12px;
  font-weight: 500;
  color: rgba(160, 180, 220, 0.5);
  letter-spacing: 0.02em;
  transition: color 0.3s;
}

.loading-step.active .step-status {
  color: rgba(90, 200, 250, 0.8);
}

.loading-step.completed .step-status {
  color: rgba(16, 185, 129, 0.8);
}

.step-check {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  opacity: 0;
}

.loading-step.active .step-check {
  opacity: 0.3;
  border-color: rgba(10, 132, 255, 0.3);
}

.loading-step.completed .step-check {
  opacity: 1;
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.6);
  transform: scale(1.1);
}

.step-check svg {
  width: 14px;
  height: 14px;
  color: #10b981;
  stroke-width: 3;
  opacity: 0;
  transform: scale(0.5);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.loading-step.completed .step-check svg {
  opacity: 1;
  transform: scale(1);
}

/* Прогресс бар */
.loading-progress {
  width: 400px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  animation: progressFadeIn 1s ease-out 1s both;
}

@keyframes progressFadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  box-shadow: 
    inset 0 1px 3px rgba(0, 0, 0, 0.4),
    0 0 20px rgba(10, 132, 255, 0.1);
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,
    #0a84ff 0%,
    #5ac8fa 50%,
    #0a84ff 100%
  );
  background-size: 200% 100%;
  border-radius: 10px;
  animation: progressFill 2s ease-out forwards,
             progressShimmer 1.5s ease-in-out infinite;
  box-shadow: 
    0 0 20px rgba(10, 132, 255, 0.8),
    0 0 40px rgba(10, 132, 255, 0.4);
}

@keyframes progressFill {
  to { width: 100%; }
}

@keyframes progressShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.progress-glow {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg,
    transparent 0%,
    rgba(90, 200, 250, 0.6) 50%,
    transparent 100%
  );
  opacity: 0;
  animation: progressGlow 2s ease-in-out 0.5s forwards;
}

@keyframes progressGlow {
  0%, 100% { opacity: 0; transform: translateX(-100%); }
  50% { opacity: 1; transform: translateX(100%); }
}

.loading-percentage {
  text-align: center;
  font-size: 14px;
  font-weight: 700;
  color: rgba(90, 200, 250, 0.8);
  letter-spacing: 0.1em;
}

/* Частицы загрузки */
.loading-particles {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
}

.loading-particles .particle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: radial-gradient(circle,
    rgba(10, 132, 255, 1) 0%,
    rgba(10, 132, 255, 0) 70%
  );
  border-radius: 50%;
  opacity: 0;
  animation: particleFloat 3s ease-in-out infinite;
}

.loading-particles .particle:nth-child(1) {
  left: 10%; animation-delay: 0s;
}
.loading-particles .particle:nth-child(2) {
  left: 25%; animation-delay: 0.4s;
}
.loading-particles .particle:nth-child(3) {
  left: 40%; animation-delay: 0.8s;
}
.loading-particles .particle:nth-child(4) {
  left: 55%; animation-delay: 1.2s;
}
.loading-particles .particle:nth-child(5) {
  left: 70%; animation-delay: 1.6s;
}
.loading-particles .particle:nth-child(6) {
  left: 85%; animation-delay: 2s;
}
.loading-particles .particle:nth-child(7) {
  left: 20%; animation-delay: 2.4s;
}
.loading-particles .particle:nth-child(8) {
  left: 60%; animation-delay: 2.8s;
}
.loading-particles .particle:nth-child(9) {
  left: 15%; animation-delay: 0.6s;
}
.loading-particles .particle:nth-child(10) {
  left: 50%; animation-delay: 1.4s;
}
.loading-particles .particle:nth-child(11) {
  left: 75%; animation-delay: 2.2s;
}
.loading-particles .particle:nth-child(12) {
  left: 35%; animation-delay: 3s;
}

@keyframes particleFloat {
  0% {
    bottom: -10px;
    opacity: 0;
    transform: translateX(0) scale(0.5);
  }
  10% {
    opacity: 1;
  }
  90% {
    opacity: 0.8;
  }
  100% {
    bottom: 110%;
    opacity: 0;
    transform: translateX(20px) scale(1.2);
  }
}

/* ============================================
   ЭКРАН АВТОРИЗАЦИИ — УЛЬТРА СТЕКЛО
   ============================================ */

#auth-screen {
  position: fixed; inset: 0;
  z-index: var(--z-modal);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  transition: opacity 0.7s cubic-bezier(0.4,0,0.2,1), visibility 0.7s;
  overflow: hidden;
}
#auth-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

/* Ambient glow blobs */
#auth-screen::before {
  content: '';
  position: absolute; width: 700px; height: 700px;
  left: 50%; top: 40%; transform: translate(-50%, -50%);
  background: radial-gradient(circle, rgba(94,92,230,0.13) 0%, rgba(10,132,255,0.08) 45%, transparent 70%);
  filter: blur(90px);
  animation: blobDrift1 14s ease-in-out infinite alternate;
  pointer-events: none;
}
#auth-screen::after {
  content: '';
  position: absolute; width: 500px; height: 500px;
  right: 5%; bottom: 5%;
  background: radial-gradient(circle, rgba(191,90,242,0.11) 0%, rgba(50,216,255,0.06) 55%, transparent 75%);
  filter: blur(70px);
  animation: blobDrift2 18s ease-in-out infinite alternate;
  pointer-events: none;
}
@keyframes blobDrift1 {
  0%   { transform: translate(-55%, -55%) scale(1);    }
  100% { transform: translate(-45%, -47%) scale(1.12); }
}
@keyframes blobDrift2 {
  0%   { transform: scale(1) rotate(0deg);   }
  100% { transform: scale(1.15) rotate(25deg); }
}

@keyframes authFadeUp {
  from { opacity: 0; transform: translateY(32px) scale(0.96); filter: blur(4px); }
  to   { opacity: 1; transform: translateY(0)    scale(1);    filter: blur(0);   }
}
@keyframes authSlideUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0);    }
}
@keyframes authFadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}

/* ─── CONTAINER ─── */
.auth-container {
  display: flex; flex-direction: column; align-items: center;
  gap: 12px; position: relative; width: 100%; max-width: 420px; z-index: 1;
}

/* particles */
.auth-particles { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.auth-particle {
  position: absolute; border-radius: 50%;
  animation: particleRise linear infinite;
}
@keyframes particleRise {
  0%   { transform: translateY(105vh) scale(0.2); opacity: 0;   }
  7%   { opacity: 1; }
  93%  { opacity: 0.4; }
  100% { transform: translateY(-30px)  scale(1);   opacity: 0; }
}

/* ─── GLASS CARD ─── */
.auth-card {
  position: relative; 
  width: 100%;
  background: linear-gradient(
    145deg,
    rgba(15, 23, 42, 0.6) 0%,
    rgba(30, 41, 59, 0.4) 100%
  );
  border: 1px solid rgba(148, 163, 184, 0.1);
  border-radius: 24px;
  padding: 48px 40px;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  box-shadow:
    0 25px 50px -12px rgba(0, 0, 0, 0.6),
    0 0 0 1px rgba(148, 163, 184, 0.05),
    inset 0 1px 0 0 rgba(148, 163, 184, 0.1);
  overflow: hidden;
  animation: authFadeUp 0.6s cubic-bezier(0.16,1,0.3,1) both;
  transform-style: preserve-3d;
}

/* Тонкий градиентный блик сверху */
.auth-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100px;
  background: linear-gradient(
    180deg,
    rgba(99, 102, 241, 0.1) 0%,
    transparent 100%
  );
  pointer-events: none;
}

/* Убираем текстуру для максимального стекла */
.auth-card::after {
  display: none;
}

/* Убираем shine line */
.auth-card-shine {
  display: none;
}

/* Логотип тоже стеклянный */
.auth-logo {
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.02);
  border: none;
  border-radius: 28px;
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow:
    0 12px 52px rgba(10,132,255,0.3);
  position: relative; overflow: visible;
}

.auth-logo::before {
  display: none;
}

.auth-logo::after {
  display: none;
}

/* ─── HEADER ─── */
.auth-header {
  text-align: center; margin-bottom: 24px; position: relative; z-index: 1;
  animation: authSlideUp 0.75s 0.08s cubic-bezier(0.16,1,0.3,1) both;
}

.auth-logo-container {
  width: 76px; height: 76px; margin: 0 auto 18px;
  animation: logoFloat 5s ease-in-out infinite;
}
@keyframes logoFloat {
  0%,100% { transform: translateY(0)   rotate(-0.8deg); }
  50%      { transform: translateY(-9px) rotate(0.8deg);  }
}
.auth-logo {
  width: 100%; 
  height: 100%;
  background: transparent;
  border: none;
  border-radius: 0;
  display: flex; 
  align-items: center; 
  justify-content: center;
  position: relative;
}

.auth-logo::before {
  display: none;
}

.auth-logo::after {
  display: none;
}

.atom-logo {
  width: 100%; 
  height: 100%; 
  position: relative; 
  z-index: 1;
  filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.4));
}
  width: 100%; height: 100%; position: relative; z-index: 1;
  filter: drop-shadow(0 0 20px rgba(10,132,255,0.6));
}

.auth-title {
  font-size: 28px; 
  font-weight: 600; 
  line-height: 1.2;
  margin-bottom: 8px; 
  letter-spacing: -0.02em;
  color: #F1F5F9;
  font-family: var(--font-sans);
}

.auth-subtitle {
  font-size: 14px; 
  font-weight: 400; 
  letter-spacing: -0.01em;
  color: rgba(148, 163, 184, 0.8);
  font-family: var(--font-sans);
}

.auth-features {
  display: flex; gap: 6px; justify-content: center;
  flex-wrap: wrap; margin-top: 13px;
}
.auth-feature-pill {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 11px;
  background: rgba(255,255,255,0.035);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 100px;
  font-size: 10.5px; font-weight: 500;
  color: rgba(175,192,228,0.55);
  letter-spacing: 0.025em;
  cursor: default;
  transition: all 0.22s ease;
}
.auth-feature-pill svg { width: 11px; height: 11px; }
.auth-feature-pill:hover {
  background: rgba(10,132,255,0.09);
  border-color: rgba(10,132,255,0.26);
  color: rgba(90,200,250,0.88);
  transform: translateY(-1px);
}

/* ─── TABS ─── */
.auth-tabs {
  display: flex; position: relative;
  background: rgba(0,0,0,0.30);
  border: 1px solid rgba(255,255,255,0.065);
  border-radius: 14px; padding: 3px;
  margin-bottom: 4px; width: 100%; z-index: 1;
  animation: authSlideUp 0.75s 0.12s cubic-bezier(0.16,1,0.3,1) both;
}
.auth-tab {
  flex: 1; height: 34px; background: none; border: none; border-radius: 11px;
  font-size: 13px; font-weight: 600;
  color: rgba(155,170,215,0.48); cursor: pointer;
  transition: color 0.22s ease; position: relative; z-index: 2;
  letter-spacing: -0.01em;
}
.auth-tab.active { color: rgba(255,255,255,0.93); }
.auth-tab-indicator {
  position: absolute; top: 3px; bottom: 3px;
  width: calc(50% - 3px); left: 3px;
  background: linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.044));
  border: 1px solid rgba(255,255,255,0.11);
  border-radius: 11px;
  transition: transform 0.38s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.12), 0 2px 10px rgba(0,0,0,0.32);
}
.auth-tab-indicator.right { transform: translateX(100%); }

/* ─── PANELS ─── */
.auth-panel {
  display: flex; flex-direction: column; gap: 11px; position: relative; z-index: 1;
  animation: authSlideUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
.auth-panel.hidden { display: none; }

/* ─── GOOGLE BUTTON ─── */
.btn-google {
  width: 100%; height: 52px;
  background: rgba(255,255,255,0.05);
  border: none;
  border-radius: 18px; color: rgba(255,255,255,0.90);
  font-size: 14.5px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 11px;
  transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
  letter-spacing: -0.01em; position: relative; overflow: hidden;
  backdrop-filter: blur(30px) saturate(180%);
  -webkit-backdrop-filter: blur(30px) saturate(180%);
  box-shadow: 
    0 4px 16px rgba(0,0,0,0.4);
}
.btn-google::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, 
    rgba(255,255,255,0.12) 0%, 
    transparent 60%
  );
  opacity: 0; transition: opacity 0.3s;
}
.btn-google:hover::before { opacity: 1; }
.btn-google:hover {
  background: rgba(255,255,255,0.08); 
  transform: translateY(-2px);
  box-shadow: 
    0 8px 24px rgba(0,0,0,0.5);
}
.btn-google:active { 
  transform: translateY(-1px) scale(0.98); 
}
.google-icon { 
  width: 20px; height: 20px; flex-shrink: 0;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

/* ─── DIVIDER ─── */
.auth-divider {
  display: flex; align-items: center; gap: 12px;
  color: rgba(160,175,210,0.35);
  font-size: 11px; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase;
}
.auth-divider::before, .auth-divider::after {
  content: ''; flex: 1; height: 0px;
  background: transparent;
}

/* ─── FORM ─── */
.auth-form-inner { display: flex; flex-direction: column; gap: 10px; }
.auth-form       { display: flex; flex-direction: column; gap: 10px; }
.form-group      { display: flex; flex-direction: column; gap: 0; }
.form-label      { font-size: 13px; font-weight: 600; color: rgba(200,215,240,0.75); letter-spacing: -0.01em; margin-bottom: 6px; }

.form-input-wrap { position: relative; display: flex; align-items: center; }
.input-icon {
  position: absolute; left: 14px;
  width: 17px; height: 17px;
  color: rgba(140,160,210,0.45); pointer-events: none;
  transition: all 0.3s cubic-bezier(0.4,0,0.2,1); z-index: 2;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
}
.form-input-wrap:focus-within .input-icon {
  color: rgba(10,132,255,0.90);
  transform: scale(1.15);
  filter: drop-shadow(0 2px 4px rgba(10,132,255,0.4));
}
.form-input {
  width: 100%; 
  height: 48px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 0 42px 0 44px;
  font-size: 15px; 
  color: #F1F5F9;
  font-family: var(--font-sans); 
  font-weight: 400;
  transition: all 0.2s ease;
  outline: none;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  caret-color: #6366F1;
}
.form-input::placeholder { 
  color: rgba(148, 163, 184, 0.5);
  font-family: var(--font-sans);
}
.form-input:focus {
  background: rgba(15, 23, 42, 0.8);
  border-color: #6366F1;
  box-shadow:
    0 0 0 3px rgba(99, 102, 241, 0.1),
    0 1px 2px rgba(0, 0, 0, 0.05);
}
.form-input:hover:not(:focus) {
  border-color: rgba(148, 163, 184, 0.3);
}
.input-toggle-pw {
  position: absolute; right: 12px; background: none; border: none; cursor: pointer;
  padding: 6px; color: rgba(150,170,210,0.4);
  transition: all 0.3s; display: flex; align-items: center; 
  border-radius: 8px;
}
.input-toggle-pw:hover { 
  color: rgba(220,230,255,0.85); 
  background: rgba(255,255,255,0.08);
}
.input-toggle-pw svg { width: 16px; height: 16px; }

/* password strength */
.password-strength { display: flex; align-items: center; gap: 4px; margin-top: 7px; }
.pw-bar {
  flex: 1; height: 2.5px; border-radius: 2px;
  background: rgba(255,255,255,0.065); transition: background 0.38s ease;
}
.pw-bar.weak   { background: #ff453a; box-shadow: 0 0 6px rgba(255,69,58,0.4);  }
.pw-bar.fair   { background: #ff9f0a; box-shadow: 0 0 6px rgba(255,159,10,0.4); }
.pw-bar.good   { background: #30d158; box-shadow: 0 0 6px rgba(48,209,88,0.4);  }
.pw-bar.strong { background: #32ade6; box-shadow: 0 0 6px rgba(50,174,230,0.4); }
.pw-label {
  font-size: 10.5px; font-weight: 500; color: rgba(140,158,205,0.55);
  min-width: 42px; text-align: right; transition: color 0.3s;
}

/* ─── PRIMARY BUTTON ─── */
.btn-primary {
  width: 100%; 
  height: 48px;
  background: #6366F1;
  border: none;
  border-radius: 12px;
  color: white; 
  font-size: 15px; 
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  display: flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px;
  transition: all 0.2s ease;
  box-shadow: 
    0 1px 2px rgba(0, 0, 0, 0.05),
    0 0 0 0 rgba(99, 102, 241, 0);
  position: relative; 
  overflow: hidden; 
  letter-spacing: -0.01em;
}
.btn-primary:hover {
  background: #4F46E5;
  transform: translateY(-1px);
  box-shadow: 
    0 4px 12px rgba(99, 102, 241, 0.4),
    0 0 0 0 rgba(99, 102, 241, 0);
}
.btn-primary:active { 
  transform: translateY(0); 
}
.btn-primary:disabled { 
  opacity: 0.5; 
  cursor: not-allowed; 
  transform: none !important; 
}
.btn-primary svg { 
  width: 18px; 
  height: 18px; 
  transition: transform 0.2s ease;
}
.btn-primary:hover svg { 
  transform: translateX(2px); 
}

.btn-secondary {
  padding: 10px 16px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 12px;
  color: rgba(255, 255, 255, 0.9);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(10, 132, 255, 0.4);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(10, 132, 255, 0.2);
}

.btn-danger {
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(255, 69, 58, 0.9), rgba(200, 30, 30, 0.9));
  border: none;
  border-radius: 12px;
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(255, 69, 58, 0.4);
}


/* ─── STATS BAR ─── */

@keyframes authSlideUp {
  from { opacity: 0; transform: translateY(13px); }
  to   { opacity: 1; transform: translateY(0);    }
}
@keyframes logoFloat {
  0%,100% { transform: translateY(0)    rotate(-0.8deg); }
  50%      { transform: translateY(-9px) rotate(0.8deg);  }
}

/* ─── FORM LABEL (standalone) ─── */
.form-label {
  font-size: 13px; font-weight: 600;
  color: rgba(198,215,240,0.72); letter-spacing: -0.01em; margin-bottom: 6px;
}

/* ============================================
   ОСНОВНОЕ ПРИЛОЖЕНИЕ
   ============================================ */

#app {
  position: fixed;
  inset: 0;
  display: flex;
  z-index: var(--z-content);
  transition: opacity var(--transition-slowest), visibility var(--transition-slowest);
}

#app.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* ============================================
   БОКОВАЯ ПАНЕЛЬ
   ============================================ */

#sidebar {
  width: var(--sidebar-width);
  height: 100%;
  background: rgba(0, 0, 0, 0.65);
  border-right: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(30px) saturate(220%);
  -webkit-backdrop-filter: blur(30px) saturate(220%);
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: var(--z-sidebar);
  box-shadow: 
    inset -1px 0 0 rgba(255, 255, 255, 0.06),
    inset 0 1px 0 rgba(255, 255, 255, 0.03),
    4px 0 80px rgba(0, 0, 0, 0.8),
    0 0 60px rgba(10, 132, 255, 0.05);
  transition: transform var(--transition-smooth);
}

#sidebar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 200px;
  background: linear-gradient(
    180deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.03) 40%,
    transparent 100%
  );
  pointer-events: none;
  z-index: 1;
}

@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    box-shadow: var(--shadow-2xl);
  }
  
  #sidebar.open {
    transform: translateX(0);
  }
}

.sidebar-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border-subtle);
  box-shadow: inset 0 -1px 0 var(--border-ultra-subtle);
  position: relative;
  z-index: 2;
}

.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding: 12px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  transition: all var(--transition-base);
  cursor: pointer;
}

.sidebar-brand:hover {
  background: var(--glass-regular);
  border-color: var(--border-regular);
  transform: translateX(2px);
}

.brand-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--color-blue), var(--color-blue-dark));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: var(--glow-blue);
  position: relative;
  overflow: hidden;
}

.brand-icon::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(
    to bottom right,
    transparent 0%,
    transparent 40%,
    rgba(255, 255, 255, 0.3) 50%,
    rgba(255, 255, 255, 0.2) 55%,
    transparent 70%,
    transparent 100%
  );
  transform: rotate(45deg);
  animation: shimmer 4s ease-in-out infinite;
}

@keyframes shimmer {
  0% {
    transform: translateX(-100%) translateY(-100%) rotate(45deg);
  }
  100% {
    transform: translateX(100%) translateY(100%) rotate(45deg);
  }
}

.brand-icon svg {
  width: 24px;
  height: 24px;
  color: white;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  position: relative;
  z-index: 1;
}

.brand-text {
  flex: 1;
}

.brand-name {
  font-size: 16px;
  font-weight: 700;
  color: white;
  line-height: 1.2;
  letter-spacing: -0.02em;
}

.brand-tagline {
  font-size: 11px;
  color: var(--color-gray-300);
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-top: 2px;
}

.new-chat-button {
  width: 100%;
  height: 48px;
  background: linear-gradient(135deg, var(--color-blue), var(--color-blue-dark));
  border: none;
  border-radius: var(--radius-lg);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all var(--transition-base);
  box-shadow: 
    var(--shadow-md),
    var(--glow-blue);
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

.new-chat-button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
  transform: scale(0);
  transition: transform var(--transition-smooth);
}

.new-chat-button:hover::before {
  transform: scale(2);
}

.new-chat-button:hover {
  box-shadow: 
    var(--shadow-lg),
    0 0 32px rgba(10, 132, 255, 0.5);
  transform: translateY(-1px);
}

.new-chat-button:active {
  transform: translateY(0);
}

.new-chat-button svg {
  width: 20px;
  height: 20px;
  position: relative;
  z-index: 1;
}

.new-chat-button span {
  position: relative;
  z-index: 1;
}

.chats-list {
  flex: 1;
  overflow-y: auto;
  padding: 16px 12px;
  scrollbar-width: thin;
  scrollbar-color: var(--glass-thick) transparent;
}

.chats-list::-webkit-scrollbar {
  width: 6px;
}

.chats-list::-webkit-scrollbar-track {
  background: transparent;
}

.chats-list::-webkit-scrollbar-thumb {
  background: var(--glass-thick);
  border-radius: 10px;
  transition: background var(--transition-base);
}

.chats-list::-webkit-scrollbar-thumb:hover {
  background: var(--glass-ultra-thick);
}

.chat-item {
  padding: 12px;
  background: var(--glass-ultra-thin);
  border: 1px solid transparent;
  border-radius: var(--radius-md);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
}

.chat-item::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, var(--glass-regular), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.chat-item:hover::before {
  transform: translateX(100%);
}

.chat-item:hover {
  background: var(--glass-thin);
  border-color: var(--border-subtle);
  transform: translateX(4px) scale(1.02);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.chat-item.active {
  background: var(--glass-medium);
  border-color: var(--border-regular);
  transform: translateX(2px);
  box-shadow: 
    inset 0 1px 0 var(--border-ultra-subtle),
    var(--glow-blue),
    0 4px 16px rgba(10, 132, 255, 0.2);
  animation: activeItemPulse 2s ease-in-out infinite;
}

@keyframes activeItemPulse {
  0%, 100% { box-shadow: 
    inset 0 1px 0 var(--border-ultra-subtle),
    var(--glow-blue),
    0 4px 16px rgba(10, 132, 255, 0.2);
  }
  50% { box-shadow: 
    inset 0 1px 0 var(--border-ultra-subtle),
    var(--glow-blue),
    0 4px 20px rgba(10, 132, 255, 0.4);
  }
}

.chat-item-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.chat-icon {
  width: 28px;
  height: 28px;
  background: var(--glass-regular);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all var(--transition-bounce);
}

.chat-item:hover .chat-icon,
.chat-item.active .chat-icon {
  background: var(--color-blue);
  border-color: var(--color-blue);
  box-shadow: var(--glow-blue);
}

.chat-icon svg {
  width: 14px;
  height: 14px;
  color: var(--color-gray-300);
  transition: color var(--transition-base);
}

.chat-item:hover .chat-icon svg,
.chat-item.active .chat-icon svg {
  color: white;
}

.chat-title {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
  color: white;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: -0.01em;
}

.chat-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transform: scale(0.9);
  transition: all var(--transition-fast);
}

.chat-item:hover .chat-actions {
  opacity: 1;
  transform: scale(1);
}

.chat-action-btn {
  width: 24px;
  height: 24px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-xs);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.chat-action-btn:hover {
  background: var(--color-blue);
  border-color: var(--color-blue);
  box-shadow: var(--glow-blue);
}

.chat-action-btn svg {
  width: 12px;
  height: 12px;
  color: var(--color-gray-300);
  transition: color var(--transition-fast);
}

.chat-action-btn:hover svg {
  color: white;
}

.chat-preview {
  font-size: 12px;
  color: var(--color-gray-400);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding-left: 38px;
}

.sidebar-footer {
  padding: 20px;
  border-top: 1px solid var(--border-subtle);
  box-shadow: inset 0 1px 0 var(--border-ultra-subtle);
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  margin-bottom: 12px;
  transition: all var(--transition-base);
  cursor: pointer;
}

.user-profile:hover {
  background: var(--glass-regular);
  border-color: var(--border-regular);
  transform: translateX(2px);
}

.user-avatar {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, 
    rgba(10, 132, 255, 0.15), 
    rgba(0, 92, 200, 0.1)
  );
  border: 1.5px solid rgba(10, 132, 255, 0.3);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
  box-shadow: 
    0 0 20px rgba(10, 132, 255, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  letter-spacing: -0.01em;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  position: relative;
  overflow: visible;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.user-avatar:hover {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 
    0 0 30px rgba(10, 132, 255, 0.5),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.user-atom-icon {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.6));
}

.user-info {
  flex: 1;
  min-width: 0;
}

.user-name {
  font-size: 14px;
  font-weight: 600;
  color: white;
  margin-bottom: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  letter-spacing: -0.01em;
}

.user-email {
  font-size: 12px;
  color: var(--color-gray-400);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.sidebar-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.sidebar-action-btn {
  height: 40px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  color: var(--color-gray-200);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all var(--transition-base);
  letter-spacing: -0.01em;
}

.sidebar-action-btn:hover {
  background: var(--glass-regular);
  border-color: var(--border-regular);
  color: white;
  transform: translateY(-1px);
}

.sidebar-action-btn svg {
  width: 16px;
  height: 16px;
}

/* ============================================
   ОСНОВНОЙ КОНТЕНТ
   ============================================ */

#main-content {
  flex: 1; display: flex; flex-direction: column; min-width: 0;
}

/* ─── TOPBAR ─── */
.topbar {
  height: var(--topbar-height);
  background: rgba(0,0,0,0.70);
  border-bottom: 1px solid rgba(255,255,255,0.10);
  backdrop-filter: blur(30px) saturate(220%);
  -webkit-backdrop-filter: blur(30px) saturate(220%);
  padding: 0 20px;
  display: flex; align-items: center; gap: 12px;
  z-index: var(--z-topbar);
  box-shadow: 
    inset 0 -1px 0 rgba(255,255,255,0.06), 
    inset 0 1px 0 rgba(255,255,255,0.03),
    0 4px 32px rgba(0,0,0,0.40),
    0 0 40px rgba(10, 132, 255, 0.05);
}
.menu-button {
  display: none; width: 36px; height: 36px;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s ease;
}
.menu-button:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.14); }
.menu-button svg { width: 18px; height: 18px; color: rgba(175,195,232,0.6); }
@media (max-width: 768px) { .menu-button { display: flex; } }

.topbar-logo {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
}

.topbar-atom {
  width: 36px;
  height: 36px;
  filter: drop-shadow(0 0 12px rgba(10, 132, 255, 0.5));
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.topbar-atom:hover {
  transform: scale(1.15) rotate(10deg);
  filter: drop-shadow(0 0 20px rgba(10, 132, 255, 0.8));
}

.topbar-title {
  font-size: 16px;
  font-weight: 700;
  background: linear-gradient(135deg, #fff 0%, rgba(90,200,250,0.95) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}

.chat-title-bar {
  flex: 1; font-size: 14.5px; font-weight: 600;
  color: rgba(238,248,255,0.82);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  letter-spacing: -0.01em;
}
.topbar-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 11.5px; font-weight: 500; color: rgba(128,150,205,0.44);
}
.status-dot {
  width: 6.5px; height: 6.5px; border-radius: 50%;
  background: rgba(48,209,88,0.78);
  box-shadow: 0 0 8px rgba(48,209,88,0.48);
  animation: statusPulse 2.8s ease-in-out infinite;
}
@keyframes statusPulse {
  0%,100% { opacity: 1; transform: scale(1); }
  50%      { opacity: 0.5; transform: scale(0.78); }
}
.topbar-actions { display: flex; gap: 6px; }
.topbar-btn {
  width: 34px; height: 34px;
  background: rgba(255,255,255,0.036);
  border: 1px solid rgba(255,255,255,0.075);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s ease;
}
.topbar-btn:hover {
  background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.14);
  transform: translateY(-1px);
}
.topbar-btn svg { width: 15px; height: 15px; color: rgba(168,190,232,0.52); transition: color 0.2s; }
.topbar-btn:hover svg { color: rgba(218,234,255,0.88); }

/* ─── CHAT AREA ─── */
.chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }

.messages-container {
  flex: 1; overflow-y: auto; padding: 28px 20px 20px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.075) transparent;
}
.messages-container::-webkit-scrollbar { width: 5px; }
.messages-container::-webkit-scrollbar-track { background: transparent; }
.messages-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.075); border-radius: 8px; }
.messages-container::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.13); }

/* empty state */
.chat-empty {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; height: 100%; padding: 40px 20px; text-align: center;
  animation: fadeUpSoft 0.6s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes fadeUpSoft {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}
.chat-empty-icon {
  width: 66px; height: 66px;
  background: rgba(255,255,255,0.045);
  border: 1px solid rgba(255,255,255,0.095);
  border-radius: 22px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 18px;
  box-shadow: 0 8px 34px rgba(94,92,230,0.17), inset 0 1px 0 rgba(255,255,255,0.13);
  backdrop-filter: blur(20px);
  animation: logoFloat 5s ease-in-out infinite;
}
.chat-empty-icon svg { width: 30px; height: 30px; color: rgba(195,215,248,0.60); }
.chat-empty h2 { font-size: 21px; font-weight: 700; letter-spacing: -0.025em; color: rgba(235,248,255,0.78); margin-bottom: 8px; }
.chat-empty p  { font-size: 13px; color: rgba(160,180,222,0.40); line-height: 1.65; max-width: 300px; margin: 0 auto 24px; }
.prompt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; width: 100%; max-width: 460px; }
.prompt-chip {
  background: rgba(255,255,255,0.035);
  border: 1px solid rgba(255,255,255,0.075);
  border-radius: 13px; padding: 11px 13px;
  font-size: 12.5px; color: rgba(182,204,242,0.58);
  cursor: pointer; text-align: left; line-height: 1.45;
  transition: all 0.22s ease; backdrop-filter: blur(12px);
}
.prompt-chip:hover {
  background: rgba(10,132,255,0.08); border-color: rgba(10,132,255,0.24);
  color: rgba(140,215,255,0.88); transform: translateY(-2px);
  box-shadow: 0 7px 22px rgba(0,0,0,0.30);
}
.prompt-chip strong {
  display: block; font-weight: 700; margin-bottom: 3px;
  color: rgba(208,228,255,0.68); font-size: 10.5px;
  text-transform: uppercase; letter-spacing: 0.05em;
}

/* ─── MESSAGES ─── */
.message-wrapper {
  max-width: 800px; margin: 0 auto 14px;
  display: flex; gap: 11px;
  animation: msgAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes msgAppear {
  from { 
    opacity: 0; 
    transform: translateY(20px) scale(0.95); 
    filter: blur(4px);
  }
  to   { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
    filter: blur(0);
  }
}
.message-wrapper.user { flex-direction: row-reverse; }
.message-content { display: flex; flex-direction: column; flex: 1; min-width: 0; }
.message-wrapper.user .message-content { align-items: flex-end; }

.message-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 12.5px; font-weight: 700;
  transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
  margin-top: 20px;
}
.message-wrapper:hover .message-avatar { 
  transform: scale(1.15) rotate(5deg); 
}
.message-wrapper.user .message-avatar {
  background: linear-gradient(140deg, rgba(10,132,255,0.88), rgba(0,74,186,1));
  box-shadow: 0 3px 14px rgba(10,132,255,0.42);
  border: 1px solid rgba(90,170,255,0.26); color: white;
}
.message-wrapper.assistant .message-avatar {
  background: rgba(255,255,255,0.046);
  border: 1px solid rgba(255,255,255,0.095);
  backdrop-filter: blur(20px);
  box-shadow: 0 3px 14px rgba(94,92,230,0.15), inset 0 1px 0 rgba(255,255,255,0.11);
}
.message-avatar svg { width: 17px; height: 17px; color: rgba(255,255,255,0.80); }

/* Крутящийся квант при загрузке */
.spinning-quantum {
  animation: quantumSpin 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

@keyframes quantumSpin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.spinning-quantum svg {
  filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.6));
}


.message-meta {
  display: flex; align-items: center; gap: 7px;
  margin-bottom: 5px; padding: 0 2px;
}
.message-wrapper.user .message-meta { flex-direction: row-reverse; }
.message-sender { font-size: 11.5px; font-weight: 600; color: rgba(165,186,230,0.46); }
.message-time   { font-size: 10px; color: rgba(118,140,196,0.28); }

.message-bubble {
  background: rgba(0, 0, 0, 0.65);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 18px 18px 18px 5px;
  padding: 13px 17px;
  font-size: 14.5px; line-height: 1.70;
  color: rgba(235,245,255,0.92);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.10), 
    inset 0 -1px 0 rgba(0,0,0,0.30),
    0 8px 32px rgba(0,0,0,0.40),
    0 0 40px rgba(255,255,255,0.02);
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
  letter-spacing: -0.006em;
}
.message-wrapper.user .message-bubble {
  border-radius: 18px 18px 5px 18px;
  background: linear-gradient(140deg, rgba(10,132,255,0.20), rgba(2,62,162,0.15));
  border-color: rgba(10,132,255,0.30);
  box-shadow: 
    inset 0 1px 0 rgba(90,170,255,0.18), 
    inset 0 -1px 0 rgba(0,0,0,0.25),
    0 8px 32px rgba(0,0,0,0.40), 
    0 0 50px rgba(10,132,255,0.12);
}
.message-wrapper:hover .message-bubble {
  border-color: rgba(255,255,255,0.18);
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.15), 
    inset 0 -1px 0 rgba(0,0,0,0.30),
    0 12px 48px rgba(0,0,0,0.50),
    0 0 60px rgba(255,255,255,0.05);
  transform: translateY(-3px) scale(1.01);
}
.message-wrapper.user:hover .message-bubble {
  border-color: rgba(10,132,255,0.45);
  box-shadow: 
    inset 0 1px 0 rgba(90,170,255,0.25), 
    inset 0 -1px 0 rgba(0,0,0,0.25),
    0 12px 48px rgba(0,0,0,0.50), 
    0 0 80px rgba(10,132,255,0.20);
}
.message-bubble p { margin-bottom: 10px; }
.message-bubble p:last-child { margin-bottom: 0; }

.message-actions {
  display: flex; gap: 4px; margin-top: 5px; padding: 0 2px;
  opacity: 0; transform: translateY(-3px); transition: all 0.18s ease;
}
.message-wrapper.user .message-actions { flex-direction: row-reverse; }
.message-wrapper:hover .message-actions { opacity: 1; transform: translateY(0); }
.msg-action-btn {
  display: flex; align-items: center; gap: 4px; padding: 2px 8px; height: 23px;
  background: rgba(255,255,255,0.035); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 7px; font-size: 10.5px; font-weight: 500;
  color: rgba(145,168,218,0.50); cursor: pointer; transition: all 0.18s ease;
}
.msg-action-btn svg { width: 11px; height: 11px; }
.msg-action-btn:hover { background: rgba(255,255,255,0.075); border-color: rgba(255,255,255,0.14); color: rgba(215,232,255,0.86); }

.message-bubble code {
  background: rgba(0,0,0,0.34); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 5px; padding: 1px 6px;
  font-family: var(--font-mono); font-size: 13px; color: rgba(90,200,250,0.88);
}
.message-bubble pre {
  background: rgba(0,0,0,0.42); border: 1px solid rgba(255,255,255,0.065);
  border-radius: 12px; padding: 13px 16px; overflow-x: auto; margin: 10px 0;
}
.message-bubble pre code { background: none; border: none; padding: 0; color: rgba(192,216,255,0.80); font-size: 13px; }

/* ============================================
   HTML PREVIEW - КАК У CLAUDE
   ============================================ */

.html-preview-container {
  margin: 12px 0;
  border-radius: 16px;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.08);
}

.html-preview-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.04);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.html-preview-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
}

.html-preview-title svg {
  width: 16px;
  height: 16px;
  color: var(--color-blue);
}

.html-preview-actions {
  display: flex;
  gap: 8px;
}

.html-preview-btn {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.html-preview-btn:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 1);
  transform: translateY(-1px);
}

.html-preview-btn svg {
  width: 14px;
  height: 14px;
}

.html-preview-frame {
  width: 100%;
  min-height: 400px;
  border: none;
  background: white;
  display: block;
}

.html-preview-code {
  background: rgba(0, 0, 0, 0.4);
  padding: 16px;
  font-family: var(--font-mono);
  font-size: 13px;
  color: rgba(192, 216, 255, 0.8);
  overflow-x: auto;
  max-height: 400px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}

.html-preview-toggle {
  display: flex;
  gap: 4px;
  padding: 8px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
}

.html-preview-tab {
  padding: 6px 14px;
  background: transparent;
  border: none;
  border-radius: 6px;
  color: rgba(255, 255, 255, 0.6);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.html-preview-tab.active {
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.95);
}

.html-preview-tab:hover:not(.active) {
  background: rgba(255, 255, 255, 0.05);
  color: rgba(255, 255, 255, 0.8);
}

/* ============================================
   ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ
   ============================================ */

.message-tools {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.message-tool-btn {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 10px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.message-tool-btn:hover {
  background: rgba(10, 132, 255, 0.12);
  border-color: rgba(10, 132, 255, 0.3);
  color: rgba(10, 132, 255, 0.95);
  transform: translateY(-1px);
}

.message-tool-btn svg {
  width: 14px;
  height: 14px;
}


.typing-indicator { display: flex; gap: 5px; padding: 5px 2px; align-items: center; }
.typing-dot {
  width: 7px; height: 7px; background: rgba(10,132,255,0.60); border-radius: 50%;
  animation: typingBounce 1.35s ease-in-out infinite;
}
.typing-dot:nth-child(1) { animation-delay: -0.28s; }
.typing-dot:nth-child(2) { animation-delay: -0.14s; }
@keyframes typingBounce {
  0%,60%,100% { transform: translateY(0) scale(1); }
  30%          { transform: translateY(-7px) scale(1.1); }
}

/* ─── INPUT ─── */
.input-container {
  padding: 13px 18px 18px;
  border-top: 1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(30px) saturate(220%);
  -webkit-backdrop-filter: blur(30px) saturate(220%);
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.08),
    inset 0 -1px 0 rgba(0,0,0,0.40),
    0 -8px 32px rgba(0,0,0,0.30);
}
.input-wrapper {
  max-width: 800px; margin: 0 auto;
  display: flex; align-items: flex-end; gap: 10px;
  background: rgba(255,255,255,0.053);
  border: 1px solid rgba(255,255,255,0.098);
  border-radius: 22px; padding: 8px 8px 8px 16px;
  transition: all 0.26s cubic-bezier(0.4,0,0.2,1);
  backdrop-filter: blur(30px);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.075), 0 4px 24px rgba(0,0,0,0.26);
}
.input-wrapper:focus-within {
  background: rgba(255,255,255,0.078);
  border-color: rgba(10,132,255,0.44);
  box-shadow:
    0 0 0 3.5px rgba(10,132,255,0.09),
    inset 0 1px 0 rgba(255,255,255,0.10),
    0 4px 24px rgba(0,0,0,0.30),
    0 0 40px rgba(10,132,255,0.07);
}
.message-input {
  flex: 1; background: transparent; border: none; outline: none;
  color: rgba(232,245,255,0.90); font-size: 14.5px;
  font-family: var(--font-sans); font-weight: 400; line-height: 1.55;
  padding: 5px 0; min-height: 34px; max-height: 180px; resize: none;
  letter-spacing: -0.006em; caret-color: rgba(10,132,255,0.9);
}
.message-input::placeholder { color: rgba(128,150,208,0.30); }

.send-button {
  width: 38px; height: 38px;
  background: linear-gradient(140deg, #0a84ff, #0050be);
  border: none; border-radius: 50%;
  color: white; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.22s ease; flex-shrink: 0;
  box-shadow: 0 4px 16px rgba(10,132,255,0.46), inset 0 1px 0 rgba(255,255,255,0.25);
  position: relative; overflow: hidden;
}
.send-button::before {
  content: ''; position: absolute; inset: 0; border-radius: 50%;
  background: radial-gradient(circle at 38% 30%, rgba(255,255,255,0.24), transparent 56%);
  opacity: 0; transition: opacity 0.2s;
}
.send-button:hover::before { opacity: 1; }
.send-button:hover { transform: scale(1.11); box-shadow: 0 7px 22px rgba(10,132,255,0.60), inset 0 1px 0 rgba(255,255,255,0.30); }
.send-button:active { transform: scale(0.93); }
.send-button:disabled { opacity: 0.35; cursor: not-allowed; transform: none; }
.send-button svg { width: 17px; height: 17px; position: relative; z-index: 1; }


/* ============================================
   МОДАЛЬНОЕ ОКНО НАСТРОЕК
   ============================================ */

.modal {
  position: fixed;
  inset: 0;
  z-index: var(--z-modal);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  transition: opacity var(--transition-slowest), visibility var(--transition-slowest);
}

.modal.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(var(--blur-md));
  -webkit-backdrop-filter: blur(var(--blur-md));
}

.modal-content {
  position: relative;
  width: 100%;
  max-width: 560px;
  max-height: 80vh;
  background: linear-gradient(135deg,
    rgba(0, 0, 0, 0.85) 0%,
    rgba(0, 0, 0, 0.75) 50%,
    rgba(0, 0, 0, 0.82) 100%
  );
  border: 1px solid rgba(255, 255, 255, 0.18);
  border-radius: 32px;
  backdrop-filter: blur(30px) saturate(220%);
  -webkit-backdrop-filter: blur(30px) saturate(220%);
  box-shadow: 
    0 60px 140px rgba(0, 0, 0, 0.90),
    0 12px 48px rgba(0, 0, 0, 0.70),
    inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.50),
    0 0 100px rgba(10, 132, 255, 0.15);
  display: flex;
  flex-direction: column;
  animation: modalSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(40px);
    filter: blur(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
    filter: blur(0px);
  }
}

.modal-header {
  padding: 28px 32px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: inset 0 -1px 0 var(--border-ultra-subtle);
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: white;
  letter-spacing: -0.02em;
}

.modal-close {
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.10);
  border: 1px solid rgba(255, 255, 255, 0.16);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--transition-base);
}

.modal-close:hover {
  background: rgba(255, 60, 60, 0.25);
  border-color: rgba(255, 80, 80, 0.45);
  transform: rotate(90deg);
}

.modal-close svg {
  width: 18px;
  height: 18px;
  color: var(--color-gray-200);
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 32px;
  scrollbar-width: thin;
  scrollbar-color: var(--glass-thick) transparent;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}

.modal-body::-webkit-scrollbar-track {
  background: transparent;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--glass-thick);
  border-radius: 10px;
}

.settings-section {
  margin-bottom: 32px;
}

.settings-section:last-child {
  margin-bottom: 0;
}

.settings-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--color-gray-100);
  margin-bottom: 8px;
  display: block;
  letter-spacing: -0.01em;
  text-transform: uppercase;
}

.settings-select {
  width: 100%;
  height: 48px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 0 16px;
  color: white;
  font-size: 15px;
  font-family: var(--font-sans);
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-base);
  outline: none;
  backdrop-filter: blur(var(--blur-md));
  -webkit-backdrop-filter: blur(var(--blur-md));
}

.settings-select:focus {
  background: var(--glass-regular);
  border-color: var(--color-blue);
  box-shadow: 
    0 0 0 4px rgba(10, 132, 255, 0.1),
    var(--glow-blue);
}

.settings-textarea {
  width: 100%;
  min-height: 120px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  padding: 16px;
  color: white;
  font-size: 14px;
  font-family: var(--font-mono);
  resize: vertical;
  transition: all var(--transition-base);
  outline: none;
  backdrop-filter: blur(var(--blur-md));
  -webkit-backdrop-filter: blur(var(--blur-md));
}

.settings-textarea:focus {
  background: var(--glass-regular);
  border-color: var(--color-blue);
  box-shadow: 
    0 0 0 4px rgba(10, 132, 255, 0.1),
    var(--glow-blue);
}

.slider-group {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 12px;
}

.slider-input {
  flex: 1;
  height: 6px;
  background: var(--glass-regular);
  border-radius: 10px;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  cursor: pointer;
}

.slider-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: var(--color-blue);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: var(--glow-blue);
  transition: all var(--transition-base);
}

.slider-input::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(10, 132, 255, 0.6);
}

.slider-input::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--color-blue);
  border-radius: 50%;
  border: none;
  cursor: pointer;
  box-shadow: var(--glow-blue);
  transition: all var(--transition-base);
}

.slider-input::-moz-range-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(10, 132, 255, 0.6);
}

.slider-value {
  min-width: 48px;
  text-align: center;
  font-size: 15px;
  font-weight: 700;
  color: var(--color-blue);
  background: var(--glass-regular);
  padding: 8px 12px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-subtle);
}

.toggle-group {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background: var(--glass-thin);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-lg);
  transition: all var(--transition-base);
  cursor: pointer;
}

.toggle-group:hover {
  background: var(--glass-regular);
  border-color: var(--border-regular);
}

.toggle-text {
  font-size: 15px;
  font-weight: 600;
  color: white;
  letter-spacing: -0.01em;
}

.toggle-switch {
  position: relative;
  width: 48px;
  height: 28px;
  background: var(--glass-regular);
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--transition-base);
}

.toggle-switch::before {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 20px;
  height: 20px;
  background: var(--color-gray-400);
  border-radius: 50%;
  transition: all var(--transition-base);
  box-shadow: var(--shadow-sm);
}

.toggle-checkbox {
  display: none;
}

.toggle-checkbox:checked + .toggle-switch {
  background: var(--color-blue);
  border-color: var(--color-blue);
  box-shadow: var(--glow-blue);
}

.toggle-checkbox:checked + .toggle-switch::before {
  left: 23px;
  background: white;
}

/* ============================================
   УВЕДОМЛЕНИЯ (ТОСТЫ)
   ============================================ */

.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: var(--z-toast);
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 20px;
  background: var(--glass-medium);
  border: 1px solid var(--border-regular);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(var(--blur-ultra));
  -webkit-backdrop-filter: blur(var(--blur-ultra));
  box-shadow: 
    var(--shadow-xl),
    inset 0 1px 0 var(--border-ultra-subtle);
  max-width: 380px;
  animation: toastSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes toastSlide {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.toast-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.toast.success .toast-icon {
  color: #10b981;
}

.toast.error .toast-icon {
  color: #ef4444;
}

.toast.warning .toast-icon {
  color: #f59e0b;
}

.toast.info .toast-icon {
  color: var(--color-blue);
}

.toast-message {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
  color: white;
  line-height: 1.4;
  letter-spacing: -0.01em;
}

/* ============================================
   МОБИЛЬНЫЙ БЭКДРОП
   ============================================ */

#sidebar-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(var(--blur-sm));
  -webkit-backdrop-filter: blur(var(--blur-sm));
  z-index: calc(var(--z-sidebar) - 1);
  opacity: 0;
  transition: opacity var(--transition-smooth);
}

#sidebar-backdrop.active {
  opacity: 1;
}

@media (max-width: 768px) {
  #sidebar-backdrop {
    display: block;
  }
}

/* ============================================
   АДАПТИВНОСТЬ
   ============================================ */

@media (max-width: 768px) {
  .auth-card {
    padding: 40px 32px;
  }
  
  .auth-title {
    font-size: 32px;
  }
  
  .topbar {
    padding: 0 16px;
  }
  
  .messages-container {
    padding: 24px 16px;
  }
  
  .input-container {
    padding: 16px;
  }
  
  .modal-content {
    max-width: 100%;
    max-height: 90vh;
  }
  
  .modal-header,
  .modal-body {
    padding: 24px;
  }
  
  .toast {
    bottom: 16px;
    right: 16px;
    left: 16px;
    max-width: none;
  }
}

@media (max-width: 480px) {
  .auth-logo-container {
    width: 80px;
    height: 80px;
  }
  
  .auth-title {
    font-size: 28px;
  }
  
  .sidebar-actions {
    grid-template-columns: 1fr;
  }
  
  .form-input,
  .btn-primary {
    height: 48px;
  }
}

/* ============================================
   УТИЛИТЫ
   ============================================ */

.hidden {
  display: none !important;
}

/* Улучшенная прокрутка для iOS */
@supports (-webkit-overflow-scrolling: touch) {
  .messages-container,
  .chats-list,
  .modal-body {
    -webkit-overflow-scrolling: touch;
  }
}

/* ============================================
   АНИМАЦИИ ЗАГРУЗКИ
   ============================================ */

@keyframes shimmer {
  0% {
    background-position: -1000px 0;
  }
  100% {
    background-position: 1000px 0;
  }
}

.shimmer {
  animation: shimmer 2s infinite linear;
  background: linear-gradient(
    to right,
    var(--glass-thin) 0%,
    var(--glass-regular) 50%,
    var(--glass-thin) 100%
  );
  background-size: 1000px 100%;
}

/* ============================================
   ДОСТУПНОСТЬ
   ============================================ */

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Фокус для клавиатурной навигации */
*:focus-visible {
  outline: 2px solid var(--color-blue);
  outline-offset: 2px;
}

button:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible {
  outline: 2px solid var(--color-blue);
  outline-offset: -2px;
}

</style>
</head>
<body>

<!-- ЭКРАН ЗАГРУЗКИ -->
<div id="loading-screen">
  <div class="loading-container">
    <!-- Квантовая частица -->
    <div class="loading-atom">
      <svg viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Квантовое поле -->
        <circle cx="200" cy="200" r="160" stroke="rgba(100,120,255,0.06)" stroke-width="0.5" fill="none">
          <animate attributeName="r" values="160;165;160" dur="6s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.06;0.12;0.06" dur="6s" repeatCount="indefinite"/>
        </circle>
        
        <!-- Центральная квантовая сфера -->
        <g class="quantum-core">
          <!-- Внешнее квантовое свечение -->
          <circle cx="200" cy="200" r="50" fill="url(#quantumGlow1)" opacity="0.08">
            <animate attributeName="r" values="50;55;50" dur="4s" repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.08;0.15;0.08" dur="4s" repeatCount="indefinite"/>
          </circle>
          
          <circle cx="200" cy="200" r="35" fill="url(#quantumGlow2)" opacity="0.12">
            <animate attributeName="r" values="35;40;35" dur="4s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Центральное ядро -->
          <circle cx="200" cy="200" r="25" fill="url(#quantumCore)">
            <animate attributeName="r" values="25;27;25" dur="4s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Внутренние квантовые частицы -->
          <circle cx="195" cy="200" r="4.5" fill="rgba(150,170,255,0.7)">
            <animate attributeName="opacity" values="0.7;0.95;0.7" dur="4.5s" repeatCount="indefinite"/>
          </circle>
          <circle cx="205" cy="200" r="4.5" fill="rgba(150,170,255,0.7)">
            <animate attributeName="opacity" values="0.7;0.95;0.7" dur="4.5s" begin="0.6s" repeatCount="indefinite"/>
          </circle>
          <circle cx="200" cy="195" r="4.5" fill="rgba(120,140,255,0.7)">
            <animate attributeName="opacity" values="0.7;0.95;0.7" dur="4.5s" begin="1.2s" repeatCount="indefinite"/>
          </circle>
          <circle cx="200" cy="205" r="4.5" fill="rgba(120,140,255,0.7)">
            <animate attributeName="opacity" values="0.7;0.95;0.7" dur="4.5s" begin="1.8s" repeatCount="indefinite"/>
          </circle>
        </g>
        
        <!-- Квантовая орбита 1 -->
        <ellipse cx="200" cy="200" rx="115" ry="48" stroke="url(#quantumOrbit1)" stroke-width="1.8" fill="none" opacity="0.5">
          <animate attributeName="opacity" values="0.5;0.7;0.5" dur="5s" repeatCount="indefinite"/>
        </ellipse>
        
        <!-- Квантовые частицы на орбите 1 -->
        <g class="quantum-particle">
          <circle r="6" fill="url(#particle1)" filter="url(#quantumGlow)">
            <animateMotion dur="5s" repeatCount="indefinite">
              <mpath href="#qorbit1"/>
            </animateMotion>
          </circle>
          <circle r="4" fill="url(#particle1)" opacity="0.4">
            <animateMotion dur="5s" repeatCount="indefinite" begin="-0.1s">
              <mpath href="#qorbit1"/>
            </animateMotion>
          </circle>
        </g>
        
        <!-- Квантовая орбита 2 -->
        <ellipse cx="200" cy="200" rx="115" ry="48" stroke="url(#quantumOrbit2)" stroke-width="1.8" fill="none" opacity="0.5" transform="rotate(60 200 200)">
          <animate attributeName="opacity" values="0.5;0.7;0.5" dur="5.5s" repeatCount="indefinite"/>
        </ellipse>
        
        <!-- Квантовые частицы на орбите 2 -->
        <g class="quantum-particle">
          <circle r="6" fill="url(#particle2)" filter="url(#quantumGlow)">
            <animateMotion dur="5.5s" repeatCount="indefinite">
              <mpath href="#qorbit2"/>
            </animateMotion>
          </circle>
          <circle r="4" fill="url(#particle2)" opacity="0.4">
            <animateMotion dur="5.5s" repeatCount="indefinite" begin="-0.1s">
              <mpath href="#qorbit2"/>
            </animateMotion>
          </circle>
        </g>
        
        <!-- Квантовая орбита 3 -->
        <ellipse cx="200" cy="200" rx="115" ry="48" stroke="url(#quantumOrbit3)" stroke-width="1.8" fill="none" opacity="0.5" transform="rotate(120 200 200)">
          <animate attributeName="opacity" values="0.5;0.7;0.5" dur="6s" repeatCount="indefinite"/>
        </ellipse>
        
        <!-- Квантовые частицы на орбите 3 -->
        <g class="quantum-particle">
          <circle r="6" fill="url(#particle3)" filter="url(#quantumGlow)">
            <animateMotion dur="6s" repeatCount="indefinite">
              <mpath href="#qorbit3"/>
            </animateMotion>
          </circle>
          <circle r="4" fill="url(#particle3)" opacity="0.4">
            <animateMotion dur="6s" repeatCount="indefinite" begin="-0.1s">
              <mpath href="#qorbit3"/>
            </animateMotion>
          </circle>
        </g>
        
        <defs>
          <!-- Пути орбит -->
          <path id="qorbit1" d="M 200,152 A 115,48 0 1,1 200,248 A 115,48 0 1,1 200,152 Z"/>
          <path id="qorbit2" d="M 200,152 A 115,48 0 1,1 200,248 A 115,48 0 1,1 200,152 Z" transform="rotate(60 200 200)"/>
          <path id="qorbit3" d="M 200,152 A 115,48 0 1,1 200,248 A 115,48 0 1,1 200,152 Z" transform="rotate(120 200 200)"/>
          
          <!-- Фильтр квантового свечения -->
          <filter id="quantumGlow">
            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
          
          <!-- Тёмные квантовые градиенты -->
          <radialGradient id="quantumCore">
            <stop offset="0%" style="stop-color:#e8eeff;stop-opacity:1" />
            <stop offset="40%" style="stop-color:#8898ff;stop-opacity:1" />
            <stop offset="70%" style="stop-color:#6678dd;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#5566cc;stop-opacity:1" />
          </radialGradient>
          
          <radialGradient id="quantumGlow1">
            <stop offset="0%" style="stop-color:#7788ee;stop-opacity:0.4" />
            <stop offset="100%" style="stop-color:#5566cc;stop-opacity:0" />
          </radialGradient>
          
          <radialGradient id="quantumGlow2">
            <stop offset="0%" style="stop-color:#8898ff;stop-opacity:0.5" />
            <stop offset="100%" style="stop-color:#6678dd;stop-opacity:0" />
          </radialGradient>
          
          <!-- Градиенты орбит - тёмные -->
          <linearGradient id="quantumOrbit1">
            <stop offset="0%" style="stop-color:#6678dd;stop-opacity:0.6" />
            <stop offset="50%" style="stop-color:#7788ee;stop-opacity:0.7" />
            <stop offset="100%" style="stop-color:#6678dd;stop-opacity:0.6" />
          </linearGradient>
          
          <linearGradient id="quantumOrbit2">
            <stop offset="0%" style="stop-color:#5566cc;stop-opacity:0.6" />
            <stop offset="50%" style="stop-color:#8877dd;stop-opacity:0.7" />
            <stop offset="100%" style="stop-color:#5566cc;stop-opacity:0.6" />
          </linearGradient>
          
          <linearGradient id="quantumOrbit3">
            <stop offset="0%" style="stop-color:#5588cc;stop-opacity:0.6" />
            <stop offset="50%" style="stop-color:#6678dd;stop-opacity:0.7" />
            <stop offset="100%" style="stop-color:#5588cc;stop-opacity:0.6" />
          </linearGradient>
          
          <!-- Градиенты частиц - тёмные -->
          <radialGradient id="particle1">
            <stop offset="0%" style="stop-color:#d8e0ff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#8898ff;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#6678dd;stop-opacity:0.8" />
          </radialGradient>
          
          <radialGradient id="particle2">
            <stop offset="0%" style="stop-color:#d8e0ff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#9988dd;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#7766cc;stop-opacity:0.8" />
          </radialGradient>
          
          <radialGradient id="particle3">
            <stop offset="0%" style="stop-color:#d8e0ff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#7799ee;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#6678dd;stop-opacity:0.8" />
          </radialGradient>
        </defs>
      </svg>
    </div>
  </div>
</div>

<!-- Фоновый космос с несколькими слоями -->
<div class="forest-background">
  <div class="forest-sky"></div>
  <div class="forest-fog"></div>
  <div class="stars">
    <canvas id="star-canvas"></canvas>
  </div>
  <div class="aurora-strip"></div>
  <div class="forest-layer-near"></div>
  <div class="forest-layer-far"></div>
  <div class="forest-layer-mid"></div>
  <div class="forest-layer-closest"></div>
  <div class="light-orbs"></div>
  <div class="grain-texture"></div>
  <div class="vignette"></div>
  <div class="bg-blur-overlay"></div>
</div>

<!-- Экран авторизации -->
<div id="auth-screen">
  <div class="auth-container">
    <!-- Floating particles -->
    <div class="auth-particles" id="auth-particles"></div>
    
    <div class="auth-card">
      <!-- Inner top shine -->
      <div class="auth-card-shine"></div>
      
      <div class="auth-header">
        <div class="auth-logo-container">
          <div class="auth-logo">
            <svg class="atom-logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
              <!-- Центральное ядро -->
              <circle cx="50" cy="50" r="8" fill="url(#nucleusGrad)">
                <animate attributeName="r" values="8;9;8" dur="2s" repeatCount="indefinite"/>
              </circle>
              
              <!-- Внутреннее свечение ядра -->
              <circle cx="50" cy="50" r="12" fill="url(#glowGrad)" opacity="0.6">
                <animate attributeName="opacity" values="0.6;0.9;0.6" dur="2s" repeatCount="indefinite"/>
              </circle>
              
              <!-- Орбита 1 -->
              <ellipse cx="50" cy="50" rx="35" ry="15" stroke="url(#orbitGrad1)" stroke-width="1.5" fill="none" opacity="0.7">
                <animate attributeName="opacity" values="0.7;1;0.7" dur="3s" repeatCount="indefinite"/>
              </ellipse>
              
              <!-- Электрон 1 -->
              <circle r="4" fill="url(#electronGrad1)">
                <animateMotion dur="3s" repeatCount="indefinite">
                  <mpath href="#orbit1"/>
                </animateMotion>
                <animate attributeName="r" values="4;5;4" dur="1.5s" repeatCount="indefinite"/>
              </circle>
              
              <!-- Орбита 2 -->
              <ellipse cx="50" cy="50" rx="35" ry="15" stroke="url(#orbitGrad2)" stroke-width="1.5" fill="none" opacity="0.7" transform="rotate(60 50 50)">
                <animate attributeName="opacity" values="0.7;1;0.7" dur="3.2s" repeatCount="indefinite"/>
              </ellipse>
              
              <!-- Электрон 2 -->
              <circle r="4" fill="url(#electronGrad2)">
                <animateMotion dur="3.2s" repeatCount="indefinite">
                  <mpath href="#orbit2"/>
                </animateMotion>
                <animate attributeName="r" values="4;5;4" dur="1.8s" repeatCount="indefinite"/>
              </circle>
              
              <!-- Орбита 3 -->
              <ellipse cx="50" cy="50" rx="35" ry="15" stroke="url(#orbitGrad3)" stroke-width="1.5" fill="none" opacity="0.7" transform="rotate(120 50 50)">
                <animate attributeName="opacity" values="0.7;1;0.7" dur="3.5s" repeatCount="indefinite"/>
              </ellipse>
              
              <!-- Электрон 3 -->
              <circle r="4" fill="url(#electronGrad3)">
                <animateMotion dur="3.5s" repeatCount="indefinite">
                  <mpath href="#orbit3"/>
                </animateMotion>
                <animate attributeName="r" values="4;5;4" dur="2s" repeatCount="indefinite"/>
              </circle>
              
              <!-- Пути для анимации электронов -->
              <defs>
                <!-- Орбита 1 путь -->
                <path id="orbit1" d="M 50,35 A 35,15 0 1,1 50,65 A 35,15 0 1,1 50,35 Z"/>
                
                <!-- Орбита 2 путь -->
                <path id="orbit2" d="M 50,35 A 35,15 0 1,1 50,65 A 35,15 0 1,1 50,35 Z" transform="rotate(60 50 50)"/>
                
                <!-- Орбита 3 путь -->
                <path id="orbit3" d="M 50,35 A 35,15 0 1,1 50,65 A 35,15 0 1,1 50,35 Z" transform="rotate(120 50 50)"/>
                
                <!-- Градиенты -->
                <radialGradient id="nucleusGrad">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#0a84ff;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#5e5ce6;stop-opacity:1" />
                </radialGradient>
                
                <radialGradient id="glowGrad">
                  <stop offset="0%" style="stop-color:#0a84ff;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#5e5ce6;stop-opacity:0" />
                </radialGradient>
                
                <linearGradient id="orbitGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#0a84ff;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#5ac8fa;stop-opacity:0.6" />
                </linearGradient>
                
                <linearGradient id="orbitGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#5e5ce6;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#bf5af2;stop-opacity:0.6" />
                </linearGradient>
                
                <linearGradient id="orbitGrad3" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#32d8ff;stop-opacity:0.8" />
                  <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:0.6" />
                </linearGradient>
                
                <radialGradient id="electronGrad1">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#5ac8fa;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:0.8" />
                </radialGradient>
                
                <radialGradient id="electronGrad2">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#bf5af2;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#5e5ce6;stop-opacity:0.8" />
                </radialGradient>
                
                <radialGradient id="electronGrad3">
                  <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                  <stop offset="50%" style="stop-color:#32d8ff;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:0.8" />
                </radialGradient>
              </defs>
            </svg>
          </div>
        </div>
        
        <h1 class="auth-title">KVANT AI</h1>
        <p class="auth-subtitle">Квантовый интеллект нового поколения</p>
        
        <!-- Feature pills -->
        <div class="auth-features">
          <div class="auth-feature-pill">
            <svg viewBox="0 0 16 16" fill="none"><path d="M8 1L10 6H15L11 9.5L12.5 14.5L8 11.5L3.5 14.5L5 9.5L1 6H6L8 1Z" fill="currentColor" opacity="0.8"/></svg>
            <span>Claude 3.5</span>
          </div>
          <div class="auth-feature-pill">
            <svg viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/><path d="M8 4v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            <span>Быстрый</span>
          </div>
          <div class="auth-feature-pill">
            <svg viewBox="0 0 16 16" fill="none"><path d="M13 7H3M3 7L7 3M3 7L7 11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>История чатов</span>
          </div>
        </div>
      </div>

      <!-- Tabs: Sign In / Sign Up -->
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-signin" onclick="switchAuthTab('signin')">Войти</button>
        <button class="auth-tab" id="tab-signup" onclick="switchAuthTab('signup')">Регистрация</button>
        <div class="auth-tab-indicator" id="tab-indicator"></div>
      </div>
      
      <!-- Sign In Panel -->
      <div class="auth-panel" id="panel-signin">
        <!-- Google Sign In -->
        <button class="btn-google" onclick="loginWithGoogle()">
          <svg class="google-icon" viewBox="0 0 24 24" fill="none">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>Продолжить с Google</span>
        </button>

        <div class="auth-divider">
          <span>или</span>
        </div>
        
        <div class="auth-form-inner" id="form-signin">
          <div class="form-group">
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              <input type="text" id="auth-username" class="form-input" placeholder="Имя пользователя" autocomplete="off"/>
            </div>
          </div>
          <div class="form-group">
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
              <input type="password" id="auth-password" class="form-input" placeholder="Пароль" autocomplete="current-password"/>
              <button class="input-toggle-pw" onclick="togglePw('auth-password', this)" type="button" tabindex="-1">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              </button>
            </div>
          </div>
          <button class="btn-primary" onclick="loginWithCredentials()">
            <span>Войти</span>
            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 10h12M10 4l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>

      <!-- Sign Up Panel -->
      <div class="auth-panel hidden" id="panel-signup">
        <button class="btn-google" onclick="loginWithGoogle()">
          <svg class="google-icon" viewBox="0 0 24 24" fill="none">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>Зарегистрироваться через Google</span>
        </button>

        <div class="auth-divider"><span>или</span></div>
        
        <div class="auth-form-inner" id="form-signup">
          <div class="form-group">
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              <input type="text" id="reg-username" class="form-input" placeholder="Имя пользователя" autocomplete="off"/>
            </div>
          </div>
          <div class="form-group">
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              <input type="email" id="reg-email" class="form-input" placeholder="Email (необязательно)" autocomplete="email"/>
            </div>
          </div>
          <div class="form-group">
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
              <input type="password" id="reg-password" class="form-input" placeholder="Пароль" autocomplete="new-password"/>
              <button class="input-toggle-pw" onclick="togglePw('reg-password', this)" type="button" tabindex="-1">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              </button>
            </div>
            <div class="password-strength" id="pw-strength-bar">
              <div class="pw-bar" id="pw-bar-1"></div>
              <div class="pw-bar" id="pw-bar-2"></div>
              <div class="pw-bar" id="pw-bar-3"></div>
              <div class="pw-bar" id="pw-bar-4"></div>
              <span class="pw-label" id="pw-label"></span>
            </div>
          </div>
          <button class="btn-primary" onclick="registerWithCredentials()">
            <span>Создать аккаунт</span>
            <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 10h12M10 4l6 6-6 6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Основное приложение -->
<div id="app" class="hidden">
  <!-- Боковая панель -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <div class="brand-icon">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Quantum Core with glow -->
            <circle cx="32" cy="32" r="6" fill="url(#quantumCore)">
              <animate attributeName="r" values="6;7;6" dur="3s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Orbit Ring 1 -->
            <ellipse cx="32" cy="32" rx="22" ry="11" stroke="url(#orbit1)" stroke-width="2" fill="none" opacity="0.8">
              <animate attributeName="opacity" values="0.6;1;0.6" dur="4s" repeatCount="indefinite"/>
            </ellipse>
            
            <!-- Quantum Particle 1 -->
            <circle r="3.5" fill="url(#particle1)">
              <animateMotion dur="4s" repeatCount="indefinite">
                <mpath href="#orbitPath1"/>
              </animateMotion>
              <animate attributeName="r" values="3.5;4.5;3.5" dur="2s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Orbit Ring 2 -->
            <ellipse cx="32" cy="32" rx="22" ry="11" stroke="url(#orbit2)" stroke-width="2" fill="none" opacity="0.8" transform="rotate(60 32 32)">
              <animate attributeName="opacity" values="0.7;0.9;0.7" dur="3.5s" repeatCount="indefinite"/>
            </ellipse>
            
            <!-- Quantum Particle 2 -->
            <circle r="3.5" fill="url(#particle2)">
              <animateMotion dur="3.5s" repeatCount="indefinite">
                <mpath href="#orbitPath2"/>
              </animateMotion>
              <animate attributeName="r" values="3.5;4.5;3.5" dur="2.2s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Orbit Ring 3 -->
            <ellipse cx="32" cy="32" rx="22" ry="11" stroke="url(#orbit3)" stroke-width="2" fill="none" opacity="0.8" transform="rotate(120 32 32)">
              <animate attributeName="opacity" values="0.8;1;0.8" dur="3s" repeatCount="indefinite"/>
            </ellipse>
            
            <!-- Quantum Particle 3 -->
            <circle r="3.5" fill="url(#particle3)">
              <animateMotion dur="3s" repeatCount="indefinite">
                <mpath href="#orbitPath3"/>
              </animateMotion>
              <animate attributeName="r" values="3.5;4.5;3.5" dur="1.8s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Energy Field -->
            <circle cx="32" cy="32" r="18" fill="none" stroke="url(#energyField)" stroke-width="0.5" opacity="0.3">
              <animate attributeName="r" values="18;20;18" dur="5s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.2;0.4;0.2" dur="5s" repeatCount="indefinite"/>
            </circle>
            
            <defs>
              <!-- Orbit Paths -->
              <path id="orbitPath1" d="M 32,21 A 22,11 0 1,1 32,43 A 22,11 0 1,1 32,21 Z"/>
              <path id="orbitPath2" d="M 32,21 A 22,11 0 1,1 32,43 A 22,11 0 1,1 32,21 Z" transform="rotate(60 32 32)"/>
              <path id="orbitPath3" d="M 32,21 A 22,11 0 1,1 32,43 A 22,11 0 1,1 32,21 Z" transform="rotate(120 32 32)"/>
              
              <!-- Gradients -->
              <radialGradient id="quantumCore">
                <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:1"/>
                <stop offset="50%" style="stop-color:#00D9FF;stop-opacity:1"/>
                <stop offset="100%" style="stop-color:#0088CC;stop-opacity:1"/>
              </radialGradient>
              
              <linearGradient id="orbit1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00D9FF;stop-opacity:0.9"/>
                <stop offset="100%" style="stop-color:#0088FF;stop-opacity:0.7"/>
              </linearGradient>
              
              <linearGradient id="orbit2" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#7B2FBE;stop-opacity:0.9"/>
                <stop offset="100%" style="stop-color:#5E35B1;stop-opacity:0.7"/>
              </linearGradient>
              
              <linearGradient id="orbit3" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00FFA3;stop-opacity:0.9"/>
                <stop offset="100%" style="stop-color:#00CC82;stop-opacity:0.7"/>
              </linearGradient>
              
              <radialGradient id="particle1">
                <stop offset="0%" style="stop-color:#FFFFFF"/>
                <stop offset="100%" style="stop-color:#00D9FF"/>
              </radialGradient>
              
              <radialGradient id="particle2">
                <stop offset="0%" style="stop-color:#FFFFFF"/>
                <stop offset="100%" style="stop-color:#7B2FBE"/>
              </radialGradient>
              
              <radialGradient id="particle3">
                <stop offset="0%" style="stop-color:#FFFFFF"/>
                <stop offset="100%" style="stop-color:#00FFA3"/>
              </radialGradient>
              
              <radialGradient id="energyField">
                <stop offset="0%" style="stop-color:#00D9FF;stop-opacity:0.6"/>
                <stop offset="100%" style="stop-color:#7B2FBE;stop-opacity:0.2"/>
              </radialGradient>
            </defs>
          </svg>
        </div>
        <div class="brand-text">
          <div class="brand-name">KVANT</div>
          <div class="brand-tagline">AI ASSISTANT</div>
        </div>
      </div>
      
      <button class="new-chat-button" onclick="createNewChat()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <span>Новый чат</span>
      </button>
    </div>
    
    <div class="chats-list" id="chats-list">
      <!-- Список чатов -->
    </div>
    
    <div class="sidebar-footer">
      <div class="user-profile">
        <div class="user-avatar" id="user-avatar">
          <svg class="user-atom-icon" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Ядро -->
            <circle cx="32" cy="32" r="5" fill="url(#userNucleus)">
              <animate attributeName="r" values="5;6;5" dur="2s" repeatCount="indefinite"/>
            </circle>
            
            <!-- Орбита 1 -->
            <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#userOrbit1)" stroke-width="1.2" fill="none" opacity="0.8"/>
            
            <!-- Электрон 1 -->
            <circle r="3" fill="url(#userElectron1)">
              <animateMotion dur="2s" repeatCount="indefinite">
                <mpath href="#userPath1"/>
              </animateMotion>
            </circle>
            
            <!-- Орбита 2 -->
            <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#userOrbit2)" stroke-width="1.2" fill="none" opacity="0.8" transform="rotate(60 32 32)"/>
            
            <!-- Электрон 2 -->
            <circle r="3" fill="url(#userElectron2)">
              <animateMotion dur="2.3s" repeatCount="indefinite">
                <mpath href="#userPath2"/>
              </animateMotion>
            </circle>
            
            <!-- Орбита 3 -->
            <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#userOrbit3)" stroke-width="1.2" fill="none" opacity="0.8" transform="rotate(120 32 32)"/>
            
            <!-- Электрон 3 -->
            <circle r="3" fill="url(#userElectron3)">
              <animateMotion dur="2.5s" repeatCount="indefinite">
                <mpath href="#userPath3"/>
              </animateMotion>
            </circle>
            
            <defs>
              <path id="userPath1" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z"/>
              <path id="userPath2" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z" transform="rotate(60 32 32)"/>
              <path id="userPath3" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z" transform="rotate(120 32 32)"/>
              
              <radialGradient id="userNucleus">
                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:1" />
              </radialGradient>
              
              <linearGradient id="userOrbit1">
                <stop offset="0%" style="stop-color:#0a84ff;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#5ac8fa;stop-opacity:0.6" />
              </linearGradient>
              
              <linearGradient id="userOrbit2">
                <stop offset="0%" style="stop-color:#5e5ce6;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#bf5af2;stop-opacity:0.6" />
              </linearGradient>
              
              <linearGradient id="userOrbit3">
                <stop offset="0%" style="stop-color:#32d8ff;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:0.6" />
              </linearGradient>
              
              <radialGradient id="userElectron1">
                <stop offset="0%" style="stop-color:#ffffff" />
                <stop offset="100%" style="stop-color:#0a84ff" />
              </radialGradient>
              
              <radialGradient id="userElectron2">
                <stop offset="0%" style="stop-color:#ffffff" />
                <stop offset="100%" style="stop-color:#5e5ce6" />
              </radialGradient>
              
              <radialGradient id="userElectron3">
                <stop offset="0%" style="stop-color:#ffffff" />
                <stop offset="100%" style="stop-color:#32d8ff" />
              </radialGradient>
            </defs>
          </svg>
        </div>
        <div class="user-info">
          <div class="user-name" id="user-name">Пользователь</div>
          <div class="user-email" id="user-email"></div>
        </div>
      </div>
      
      <div class="sidebar-actions">
        <button class="sidebar-action-btn" onclick="toggleSettings()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364-6.364l-4.243 4.243m-4.242 0L5.636 5.636m12.728 12.728l-4.243-4.243m-4.242 0l-4.243 4.243"/>
          </svg>
          <span>Настройки</span>
        </button>
        
        <button class="sidebar-action-btn" onclick="logout()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 14l5-5-5-5m5 5H9"/>
          </svg>
          <span>Выйти</span>
        </button>
      </div>
    </div>
  </aside>
  
  <!-- Основной контент -->
  <main id="main-content">
    <div class="topbar">
      <button class="menu-button" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      
      <div class="topbar-logo">
        <svg class="topbar-atom" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Ядро -->
          <circle cx="32" cy="32" r="5" fill="url(#topNucleus)">
            <animate attributeName="r" values="5;6;5" dur="2s" repeatCount="indefinite"/>
          </circle>
          
          <!-- Орбита 1 -->
          <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#topOrbit1)" stroke-width="1.2" fill="none" opacity="0.8"/>
          
          <!-- Электрон 1 -->
          <circle r="3" fill="url(#topElectron1)">
            <animateMotion dur="2s" repeatCount="indefinite">
              <mpath href="#topPath1"/>
            </animateMotion>
          </circle>
          
          <!-- Орбита 2 -->
          <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#topOrbit2)" stroke-width="1.2" fill="none" opacity="0.8" transform="rotate(60 32 32)"/>
          
          <!-- Электрон 2 -->
          <circle r="3" fill="url(#topElectron2)">
            <animateMotion dur="2.3s" repeatCount="indefinite">
              <mpath href="#topPath2"/>
            </animateMotion>
          </circle>
          
          <!-- Орбита 3 -->
          <ellipse cx="32" cy="32" rx="22" ry="10" stroke="url(#topOrbit3)" stroke-width="1.2" fill="none" opacity="0.8" transform="rotate(120 32 32)"/>
          
          <!-- Электрон 3 -->
          <circle r="3" fill="url(#topElectron3)">
            <animateMotion dur="2.5s" repeatCount="indefinite">
              <mpath href="#topPath3"/>
            </animateMotion>
          </circle>
          
          <defs>
            <path id="topPath1" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z"/>
            <path id="topPath2" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z" transform="rotate(60 32 32)"/>
            <path id="topPath3" d="M 32,22 A 22,10 0 1,1 32,42 A 22,10 0 1,1 32,22 Z" transform="rotate(120 32 32)"/>
            
            <radialGradient id="topNucleus">
              <stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:1" />
            </radialGradient>
            
            <linearGradient id="topOrbit1">
              <stop offset="0%" style="stop-color:#0a84ff;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#5ac8fa;stop-opacity:0.6" />
            </linearGradient>
            
            <linearGradient id="topOrbit2">
              <stop offset="0%" style="stop-color:#5e5ce6;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#bf5af2;stop-opacity:0.6" />
            </linearGradient>
            
            <linearGradient id="topOrbit3">
              <stop offset="0%" style="stop-color:#32d8ff;stop-opacity:0.8" />
              <stop offset="100%" style="stop-color:#0a84ff;stop-opacity:0.6" />
            </linearGradient>
            
            <radialGradient id="topElectron1">
              <stop offset="0%" style="stop-color:#ffffff" />
              <stop offset="100%" style="stop-color:#0a84ff" />
            </radialGradient>
            
            <radialGradient id="topElectron2">
              <stop offset="0%" style="stop-color:#ffffff" />
              <stop offset="100%" style="stop-color:#5e5ce6" />
            </radialGradient>
            
            <radialGradient id="topElectron3">
              <stop offset="0%" style="stop-color:#ffffff" />
              <stop offset="100%" style="stop-color:#32d8ff" />
            </radialGradient>
          </defs>
        </svg>
        <span class="topbar-title">KVANT AI</span>
      </div>
      
      <div class="topbar-status">
        <div class="status-dot"></div>
        <span>Online</span>
      </div>
      <div class="topbar-actions">
        <button class="topbar-btn" onclick="clearChat()" title="Очистить чат">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="chat-area">
      <div class="messages-container" id="messages">
        <!-- Сообщения -->
      </div>
      
      <div class="input-container">
        <div class="input-wrapper">
          <textarea 
            id="message-input" 
            class="message-input"
            placeholder="Введите сообщение..."
            rows="1"
          ></textarea>
          <button id="send-button" class="send-button" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Бэкдроп для мобильных -->
<div id="sidebar-backdrop" onclick="closeSidebar()"></div>

<!-- Модальное окно настроек -->
<div id="settings-modal" class="modal hidden">
  <div class="modal-backdrop" onclick="toggleSettings()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Настройки</h2>
      <button class="modal-close" onclick="toggleSettings()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="settings-section">
        <label class="settings-label" for="model-select">Модель AI</label>
        <select id="model-select" class="settings-select" onchange="updateModel()">
          <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
          <option value="claude-3-opus-20240229">Claude 3 Opus</option>
          <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
          <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
        </select>
      </div>
      
      <div class="settings-section">
        <label class="settings-label" for="system-prompt">Системный промпт</label>
        <textarea 
          id="system-prompt" 
          class="settings-textarea"
          placeholder="Вы полезный AI ассистент..."
          onchange="updateSystemPrompt()"
        ></textarea>
      </div>
      
      <div class="settings-section">
        <label class="settings-label">Температура: <span id="temperature-value">0.7</span></label>
        <div class="slider-group">
          <input 
            type="range" 
            id="temperature-slider" 
            class="slider-input"
            min="0" 
            max="1" 
            step="0.1" 
            value="0.7"
            oninput="updateTemperature(this.value)"
          >
          <div class="slider-value" id="temperature-display">0.7</div>
        </div>
      </div>
      
      <div class="settings-section">
        <label class="toggle-group" for="sound-toggle">
          <span class="toggle-text">Звук уведомлений</span>
          <input type="checkbox" id="sound-toggle" class="toggle-checkbox" onchange="toggleSound()" checked>
          <div class="toggle-switch"></div>
        </label>
      </div>
      
      <div class="settings-section">
        <label class="toggle-group" for="enter-send-toggle">
          <span class="toggle-text">Enter отправляет</span>
          <input type="checkbox" id="enter-send-toggle" class="toggle-checkbox" onchange="toggleEnterSend()" checked>
          <div class="toggle-switch"></div>
        </label>
      </div>
      
      <div class="settings-section">
        <label class="toggle-group" for="theme-toggle">
          <span class="toggle-text">Светлая тема</span>
          <input type="checkbox" id="theme-toggle" class="toggle-checkbox" onchange="toggleTheme()">
          <div class="toggle-switch"></div>
        </label>
      </div>
      
      <div class="settings-section">
        <label class="toggle-group" for="html-preview-toggle">
          <span class="toggle-text">HTML Preview (автопоказ)</span>
          <input type="checkbox" id="html-preview-toggle" class="toggle-checkbox" onchange="toggleHTMLPreview()" checked>
          <div class="toggle-switch"></div>
        </label>
        <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px;">Автоматически показывать HTML код в iframe</p>
      </div>
      
      <div class="settings-section">
        <label class="settings-label">Экспорт данных</label>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <button class="btn-secondary" onclick="exportChats()" style="flex: 1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Экспорт чатов
          </button>
          <button class="btn-secondary" onclick="importChats()" style="flex: 1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Импорт
          </button>
        </div>
      </div>
      
      <div class="settings-section">
        <button class="btn-danger" onclick="clearAllData()" style="width: 100%; background: linear-gradient(135deg, rgba(255,69,58,0.9), rgba(200,30,30,0.9));">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
          Очистить все данные
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// КОСМИЧЕСКИЙ ФОН - РЕАЛИСТИЧНЫЕ ЗВЁЗДЫ
// ============================================

function initStarField() {
  const canvas = document.getElementById('star-canvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  let width, height;
  let stars = [];
  let shootingStars = [];
  let animFrame;
  
  function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
    generateStars();
  }
  
  function generateStars() {
    stars = [];
    const numStars = Math.floor((width * height) / 1200);
    
    for (let i = 0; i < numStars; i++) {
      const size = Math.random();
      let r, g, b, alpha;
      
      // Реалистичные цвета звёзд
      const colorType = Math.random();
      if (colorType < 0.15) {
        // Голубые звёзды (горячие)
        r = 180 + Math.random() * 40; g = 210 + Math.random() * 30; b = 255;
        alpha = 0.7 + Math.random() * 0.3;
      } else if (colorType < 0.3) {
        // Белые звёзды
        r = g = b = 240 + Math.random() * 15;
        alpha = 0.6 + Math.random() * 0.4;
      } else if (colorType < 0.45) {
        // Желтоватые
        r = 255; g = 240 + Math.random() * 15; b = 200 + Math.random() * 40;
        alpha = 0.5 + Math.random() * 0.3;
      } else if (colorType < 0.55) {
        // Оранжеватые
        r = 255; g = 200 + Math.random() * 35; b = 150 + Math.random() * 60;
        alpha = 0.4 + Math.random() * 0.3;
      } else {
        // Холодно-белые
        r = 220 + Math.random() * 30; g = 230 + Math.random() * 20; b = 255;
        alpha = 0.3 + Math.random() * 0.4;
      }
      
      const starSize = size < 0.3 ? 0.3 + Math.random() * 0.4 :
                       size < 0.7 ? 0.5 + Math.random() * 0.7 :
                       size < 0.92 ? 1.0 + Math.random() * 0.8 :
                       size < 0.99 ? 1.8 + Math.random() * 1.2 :
                                     2.5 + Math.random() * 1.5;
      
      stars.push({
        x: Math.random() * width,
        y: Math.random() * height,
        r: starSize,
        baseAlpha: alpha,
        alpha: alpha,
        color: `${r},${g},${b}`,
        twinklePeriod: 3000 + Math.random() * 8000,
        twinkleOffset: Math.random() * Math.PI * 2,
        bright: size > 0.95,
      });
    }
  }
  
  function spawnShootingStar() {
    if (shootingStars.length < 3 && Math.random() < 0.004) {
      const startX = Math.random() * width * 1.2;
      const startY = Math.random() * height * 0.4;
      const angle = (Math.PI / 4) + (Math.random() - 0.5) * 0.5;
      const speed = 6 + Math.random() * 10;
      
      shootingStars.push({
        x: startX, y: startY,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        length: 80 + Math.random() * 120,
        alpha: 0,
        maxAlpha: 0.6 + Math.random() * 0.4,
        phase: 'in', // in, full, out
        life: 0,
        maxLife: 40 + Math.random() * 30,
      });
    }
  }
  
  function drawStar(star, time) {
    const twinkle = Math.sin(time / star.twinklePeriod * Math.PI * 2 + star.twinkleOffset);
    const alpha = star.baseAlpha * (0.7 + 0.3 * twinkle);
    
    ctx.beginPath();
    ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${star.color},${alpha})`;
    ctx.fill();
    
    // Блик для ярких звёзд
    if (star.bright && star.r > 1.8) {
      const glowSize = star.r * 3;
      const grad = ctx.createRadialGradient(star.x, star.y, 0, star.x, star.y, glowSize);
      grad.addColorStop(0, `rgba(${star.color},${alpha * 0.4})`);
      grad.addColorStop(1, `rgba(${star.color},0)`);
      ctx.beginPath();
      ctx.arc(star.x, star.y, glowSize, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.fill();
      
      // Крест-блик
      if (star.r > 2.2) {
        ctx.save();
        ctx.globalAlpha = alpha * 0.3;
        ctx.strokeStyle = `rgba(${star.color},1)`;
        ctx.lineWidth = 0.5;
        const crossLen = star.r * 8;
        ctx.beginPath();
        ctx.moveTo(star.x - crossLen, star.y);
        ctx.lineTo(star.x + crossLen, star.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(star.x, star.y - crossLen);
        ctx.lineTo(star.x, star.y + crossLen);
        ctx.stroke();
        ctx.restore();
      }
    }
  }
  
  function drawShootingStar(s) {
    if (s.phase === 'in') {
      s.alpha = Math.min(s.maxAlpha, s.alpha + s.maxAlpha / 8);
      if (s.alpha >= s.maxAlpha) s.phase = 'full';
    } else if (s.phase === 'full') {
      s.life++;
      if (s.life > s.maxLife) s.phase = 'out';
    } else {
      s.alpha = Math.max(0, s.alpha - s.maxAlpha / 10);
    }
    
    const tailX = s.x - (s.vx / Math.hypot(s.vx, s.vy)) * s.length;
    const tailY = s.y - (s.vy / Math.hypot(s.vx, s.vy)) * s.length;
    
    const grad = ctx.createLinearGradient(tailX, tailY, s.x, s.y);
    grad.addColorStop(0, `rgba(255,255,255,0)`);
    grad.addColorStop(0.6, `rgba(200,230,255,${s.alpha * 0.5})`);
    grad.addColorStop(1, `rgba(255,255,255,${s.alpha})`);
    
    ctx.beginPath();
    ctx.moveTo(tailX, tailY);
    ctx.lineTo(s.x, s.y);
    ctx.strokeStyle = grad;
    ctx.lineWidth = 1.5;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Яркая головка
    ctx.beginPath();
    ctx.arc(s.x, s.y, 2, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
    ctx.fill();
    
    s.x += s.vx;
    s.y += s.vy;
  }
  
  function animate(time) {
    ctx.clearRect(0, 0, width, height);
    
    // Рисуем звёзды
    for (const star of stars) {
      drawStar(star, time);
    }
    
    // Падающие звёзды
    spawnShootingStar();
    shootingStars = shootingStars.filter(s => s.alpha > 0 || s.phase !== 'out');
    for (const s of shootingStars) {
      drawShootingStar(s);
    }
    
    animFrame = requestAnimationFrame(animate);
  }
  
  window.addEventListener('resize', resize);
  resize();
  animate(0);
}

window.addEventListener('load', () => {
  initStarField();
});

// ============================================
// КОНФИГУРАЦИЯ API
// ============================================

// API ключ теперь хранится в STATE.config.apiKey
const API_ENDPOINT = 'https://api.anthropic.com/v1/messages';

// ============================================
// СОСТОЯНИЕ ПРИЛОЖЕНИЯ
// ============================================

let STATE = {
  user: null,
  chats: [],
  currentChatId: null,
  config: {
    model: 'claude-3-5-sonnet-20241022',
    systemPrompt: 'Вы полезный AI ассистент.',
    temperature: 0.7,
    sound: true,
    enterSend: true,
    theme: 'cosmic', // 'cosmic' или 'light'
    htmlPreview: true, // Автоматический показ HTML
    apiKey: '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'
  }
};

// ============================================
// ХРАНИЛИЩЕ ДАННЫХ
// ============================================

function saveState() {
  try {
    localStorage.setItem('kvant_ai_state', JSON.stringify(STATE));
  } catch (error) {
    console.error('Ошибка сохранения состояния:', error);
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem('kvant_ai_state');
    if (saved) {
      STATE = JSON.parse(saved);
      updateUI();
    }
  } catch (error) {
    console.error('Ошибка загрузки состояния:', error);
  }
}

function updateUI() {
  if (STATE.user) {
    document.getElementById('user-name').textContent = STATE.user.name;
    document.getElementById('user-email').textContent = STATE.user.email || '';
    // Аватар теперь SVG, не обновляем текст
  }
  
  document.getElementById('model-select').value = STATE.config.model;
  document.getElementById('system-prompt').value = STATE.config.systemPrompt;
  document.getElementById('temperature-slider').value = STATE.config.temperature;
  document.getElementById('temperature-value').textContent = STATE.config.temperature;
  document.getElementById('temperature-display').textContent = STATE.config.temperature;
  document.getElementById('sound-toggle').checked = STATE.config.sound;
  document.getElementById('enter-send-toggle').checked = STATE.config.enterSend;
  
  // Загрузка темы
  const isLight = STATE.config.theme === 'light';
  document.getElementById('theme-toggle').checked = isLight;
  if (isLight) {
    document.body.classList.add('light-theme');
  } else {
    document.body.classList.remove('light-theme');
  }
  
  renderChatsList();
}

// ============================================
// АВТОРИЗАЦИЯ - ОБНОВЛЁННАЯ
// ============================================

function switchAuthTab(tab) {
  const signinPanel = document.getElementById('panel-signin');
  const signupPanel = document.getElementById('panel-signup');
  const tabSignin   = document.getElementById('tab-signin');
  const tabSignup   = document.getElementById('tab-signup');
  const indicator   = document.getElementById('tab-indicator');
  if (tab === 'signin') {
    signinPanel.classList.remove('hidden');
    signupPanel.classList.add('hidden');
    tabSignin.classList.add('active');
    tabSignup.classList.remove('active');
    indicator.classList.remove('right');
  } else {
    signinPanel.classList.add('hidden');
    signupPanel.classList.remove('hidden');
    tabSignin.classList.remove('active');
    tabSignup.classList.add('active');
    indicator.classList.add('right');
  }
}

function loginWithGoogle() {
  const name = prompt('Google Sign-In\n\nВведите ваше имя:');
  if (!name || !name.trim()) return;
  const email = name.trim().toLowerCase().replace(/\s+/g, '.') + '@gmail.com';
  STATE.user = { name: name.trim(), email, provider: 'google', avatar: name.trim().charAt(0).toUpperCase() };
  saveState();
  showToast('Вы вошли через Google', 'success');
  startApp();
}

function loginWithCredentials() {
  const username = (document.getElementById('auth-username') || {}).value || '';
  const password = (document.getElementById('auth-password') || {}).value || '';
  if (!username.trim()) { showToast('Введите имя пользователя', 'error'); return; }
  if (!password) { showToast('Введите пароль', 'error'); return; }
  STATE.user = { name: username.trim(), email: '', provider: 'local', avatar: username.trim().charAt(0).toUpperCase() };
  saveState();
  startApp();
}

function registerWithCredentials() {
  const username = (document.getElementById('reg-username') || {}).value || '';
  const email    = (document.getElementById('reg-email') || {}).value || '';
  const password = (document.getElementById('reg-password') || {}).value || '';
  if (!username.trim()) { showToast('Введите имя пользователя', 'error'); return; }
  if (!password || password.length < 4) { showToast('Пароль минимум 4 символа', 'error'); return; }
  STATE.user = { name: username.trim(), email: email || '', provider: 'local', avatar: username.trim().charAt(0).toUpperCase() };
  saveState();
  showToast('Аккаунт создан', 'success');
  startApp();
}

function togglePw(inputId, btn) {
  const inp = document.getElementById(inputId);
  if (!inp) return;
  inp.type = inp.type === 'text' ? 'password' : 'text';
  btn.style.opacity = inp.type === 'text' ? '0.9' : '0.4';
}

function initPasswordStrength() {
  const pwInput = document.getElementById('reg-password');
  if (!pwInput) return;
  pwInput.addEventListener('input', () => {
    const v = pwInput.value;
    const bars  = [1,2,3,4].map(i => document.getElementById('pw-bar-' + i));
    const label = document.getElementById('pw-label');
    bars.forEach(b => { if (b) b.className = 'pw-bar'; });
    let s = 0;
    if (v.length >= 4) s++;
    if (v.length >= 8) s++;
    if (/[A-Z]/.test(v) && /[0-9]/.test(v)) s++;
    if (/[^A-Za-z0-9]/.test(v)) s++;
    const lvls  = ['', 'weak', 'fair', 'good', 'strong'];
    const names = ['', 'Слабый', 'Средний', 'Хороший', 'Сильный'];
    for (let i = 0; i < s; i++) if (bars[i]) bars[i].classList.add(lvls[s]);
    if (label) {
      label.textContent = v.length > 0 ? names[s] : '';
      label.style.color = s >= 3 ? 'rgba(48,209,88,0.9)' : s === 2 ? 'rgba(255,159,10,0.9)' : s === 1 ? 'rgba(255,69,58,0.9)' : '';
    }
  });
}

function initAuthParticles() {
  const container = document.getElementById('auth-particles');
  if (!container) return;
  const colors = ['rgba(10,132,255,', 'rgba(94,92,230,', 'rgba(191,90,242,', 'rgba(50,216,255,', 'rgba(255,255,255,'];
  for (let i = 0; i < 22; i++) {
    const p = document.createElement('div');
    p.className = 'auth-particle';
    const size = 2 + Math.random() * 4;
    const c = colors[Math.floor(Math.random() * colors.length)];
    const a = 0.18 + Math.random() * 0.30;
    p.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;background:${c}${a});box-shadow:0 0 ${size*3}px ${c}${a*0.7});animation-duration:${9+Math.random()*18}s;animation-delay:-${Math.random()*12}s;`;
    container.appendChild(p);
  }
}

function startApp() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  updateUI();
  if (STATE.chats.length === 0) {
    createNewChat();
  } else {
    loadChat(STATE.currentChatId || STATE.chats[0].id);
  }
}

function logout() {
  if (confirm('Выйти из аккаунта?')) {
    STATE.user = null;
    saveState();
    document.getElementById('app').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    switchAuthTab('signin');
  }
}

// ============================================
// УПРАВЛЕНИЕ ЧАТАМИ
// ============================================

function createNewChat() {
  const chatId = Date.now().toString();
  const newChat = {
    id: chatId,
    title: 'Новый чат',
    messages: [],
    createdAt: new Date().toISOString()
  };
  
  STATE.chats.unshift(newChat);
  STATE.currentChatId = chatId;
  saveState();
  
  renderChatsList();
  loadChat(chatId);
  
  if (window.innerWidth <= 768) {
    closeSidebar();
  }
  
  showToast('Создан новый чат', 'success');
}

function loadChat(chatId) {
  STATE.currentChatId = chatId;
  const chat = STATE.chats.find(c => c.id === chatId);
  
  if (!chat) return;
  
  document.getElementById('chat-title').textContent = chat.title;
  renderMessages();
  saveState();
}

function deleteChat(chatId, event) {
  event.stopPropagation();
  
  if (confirm('Удалить этот чат?')) {
    STATE.chats = STATE.chats.filter(c => c.id !== chatId);
    
    if (STATE.currentChatId === chatId) {
      if (STATE.chats.length > 0) {
        loadChat(STATE.chats[0].id);
      } else {
        createNewChat();
      }
    }
    
    saveState();
    renderChatsList();
    showToast('Чат удален', 'success');
  }
}

function clearChat() {
  if (confirm('Очистить текущий чат?')) {
    const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
    if (chat) {
      chat.messages = [];
      chat.title = 'Новый чат';
      saveState();
      renderMessages();
      document.getElementById('chat-title').textContent = chat.title;
      showToast('Чат очищен', 'success');
    }
  }
}

function renderChatsList() {
  const container = document.getElementById('chats-list');
  container.innerHTML = '';
  
  STATE.chats.forEach(chat => {
    const item = document.createElement('div');
    item.className = `chat-item ${chat.id === STATE.currentChatId ? 'active' : ''}`;
    item.onclick = () => loadChat(chat.id);
    
    const preview = chat.messages.length > 0 
      ? chat.messages[chat.messages.length - 1].content.substring(0, 40) + '...'
      : 'Нет сообщений';
    
    item.innerHTML = `
      <div class="chat-item-header">
        <div class="chat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
          </svg>
        </div>
        <div class="chat-title">${escapeHtml(chat.title)}</div>
        <div class="chat-actions">
          <div class="chat-action-btn" onclick="deleteChat('${chat.id}', event)" title="Удалить">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="chat-preview">${escapeHtml(preview)}</div>
    `;
    
    container.appendChild(item);
  });
}

// ============================================
// СООБЩЕНИЯ
// ============================================

function formatTime(iso) {
  const d = new Date(iso || Date.now());
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => showToast('Скопировано', 'success')).catch(() => {});
}

function renderMessages() {
  const container = document.getElementById('messages');
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  
  if (!chat) { container.innerHTML = ''; return; }
  
  container.innerHTML = '';
  
  if (chat.messages.length === 0) {
    const userName = STATE.user ? STATE.user.name : 'Гость';
    container.innerHTML = `
      <div class="chat-empty">
        <div class="chat-empty-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
            <line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="13" x2="12" y2="13"/>
          </svg>
        </div>
        <h2>Привет, ${escapeHtml(userName)}</h2>
        <p>Задай любой вопрос — я готов помочь</p>
        <div class="prompt-grid">
          <div class="prompt-chip" onclick="insertPrompt('Объясни квантовые вычисления простыми словами')">
            <strong>Объясни</strong>Квантовые вычисления простыми словами
          </div>
          <div class="prompt-chip" onclick="insertPrompt('Создай красивую HTML страницу с анимацией')">
            <strong>HTML</strong>Страница с анимацией
          </div>
          <div class="prompt-chip" onclick="insertPrompt('Придумай оригинальные идеи для стартапа в сфере AI')">
            <strong>Идеи</strong>Стартап в сфере AI
          </div>
          <div class="prompt-chip" onclick="insertPrompt('Помоги написать профессиональное резюме')">
            <strong>Карьера</strong>Написать профессиональное резюме
          </div>
        </div>
      </div>
    `;
    return;
  }
  
  const userInitial = STATE.user ? STATE.user.name.charAt(0).toUpperCase() : 'U';
  const assistantSvg = `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="5" fill="white" opacity="0.95"/><ellipse cx="32" cy="32" rx="20" ry="10" stroke="white" stroke-width="1.8" fill="none" opacity="0.75"/><ellipse cx="32" cy="32" rx="20" ry="10" stroke="white" stroke-width="1.8" fill="none" opacity="0.75" transform="rotate(60 32 32)"/><ellipse cx="32" cy="32" rx="20" ry="10" stroke="white" stroke-width="1.8" fill="none" opacity="0.75" transform="rotate(120 32 32)"/><circle cx="52" cy="32" r="2.5" fill="white" opacity="0.9"/><circle cx="12" cy="32" r="2.5" fill="white" opacity="0.9"/><circle cx="32" cy="22" r="2.5" fill="white" opacity="0.9"/></svg>`;

  chat.messages.forEach((msg, idx) => {
    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${msg.role}`;
    const time = formatTime(msg.timestamp);
    const senderName = isUser ? (STATE.user ? STATE.user.name : 'Вы') : 'KVANT AI';
    const msgId = `msg-${idx}`;
    
    // Проверяем наличие HTML кода
    const htmlMatch = msg.content.match(/```html\n([\s\S]*?)\n```/);
    const hasHTML = htmlMatch && htmlMatch[1];
    
    let content = escapeHtml(msg.content).replace(/\n/g, '<br>');
    let htmlPreview = '';
    
    if (hasHTML && !isUser) {
      const htmlCode = htmlMatch[1];
      const previewId = `preview-${idx}`;
      
      htmlPreview = `
        <div class="html-preview-container" id="${previewId}-container">
          <div class="html-preview-header">
            <div class="html-preview-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="16 18 22 12 16 6"/>
                <polyline points="8 6 2 12 8 18"/>
              </svg>
              HTML Preview
            </div>
            <div class="html-preview-actions">
              <div class="html-preview-toggle">
                <button class="html-preview-tab active" onclick="showPreviewTab('${previewId}', 'preview')">Preview</button>
                <button class="html-preview-tab" onclick="showPreviewTab('${previewId}', 'code')">Code</button>
              </div>
              <button class="html-preview-btn" onclick="openInNewTab('${previewId}')" title="Открыть в новой вкладке">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </button>
              <button class="html-preview-btn" onclick="copyHTMLCode('${previewId}')" title="Копировать код">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                </svg>
              </button>
            </div>
          </div>
          <div id="${previewId}-preview" class="html-preview-content">
            <iframe id="${previewId}-frame" class="html-preview-frame" sandbox="allow-scripts"></iframe>
          </div>
          <div id="${previewId}-code" class="html-preview-content" style="display: none;">
            <pre class="html-preview-code"><code>${escapeHtml(htmlCode)}</code></pre>
          </div>
        </div>
      `;
      
      // Сохраняем HTML код для последующего использования
      setTimeout(() => {
        const iframe = document.getElementById(`${previewId}-frame`);
        if (iframe) {
          const doc = iframe.contentDocument || iframe.contentWindow.document;
          doc.open();
          doc.write(htmlCode);
          doc.close();
        }
      }, 100);
    }

    wrapper.innerHTML = `
      <div class="message-avatar">${isUser ? userInitial : assistantSvg}</div>
      <div class="message-content">
        <div class="message-meta">
          <span class="message-sender">${escapeHtml(senderName)}</span>
          <span class="message-time">${time}</span>
        </div>
        <div class="message-bubble" id="${msgId}">${content}</div>
        ${htmlPreview}
        <div class="message-actions">
          <button class="msg-action-btn" onclick="copyToClipboard(document.getElementById('${msgId}').innerText)" title="Копировать">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="9" height="10" rx="1.5"/><path d="M3 11H2.5A1.5 1.5 0 011 9.5v-7A1.5 1.5 0 012.5 1h7A1.5 1.5 0 0111 2.5V3"/></svg>
            Копировать
          </button>
        </div>
      </div>
    `;
    container.appendChild(wrapper);
  });
  
  requestAnimationFrame(() => { container.scrollTop = container.scrollHeight; });
}

// ============================================
// HTML PREVIEW FUNCTIONS
// ============================================

function showPreviewTab(previewId, tab) {
  const previewDiv = document.getElementById(`${previewId}-preview`);
  const codeDiv = document.getElementById(`${previewId}-code`);
  const tabs = document.querySelectorAll(`#${previewId}-container .html-preview-tab`);
  
  if (tab === 'preview') {
    previewDiv.style.display = 'block';
    codeDiv.style.display = 'none';
    tabs[0].classList.add('active');
    tabs[1].classList.remove('active');
  } else {
    previewDiv.style.display = 'none';
    codeDiv.style.display = 'block';
    tabs[0].classList.remove('active');
    tabs[1].classList.add('active');
  }
}

function openInNewTab(previewId) {
  const iframe = document.getElementById(`${previewId}-frame`);
  if (iframe) {
    const htmlContent = iframe.contentDocument.documentElement.outerHTML;
    const newWindow = window.open();
    newWindow.document.write(htmlContent);
    newWindow.document.close();
  }
}

function copyHTMLCode(previewId) {
  const iframe = document.getElementById(`${previewId}-frame`);
  if (iframe) {
    const htmlContent = iframe.contentDocument.documentElement.outerHTML;
    copyToClipboard(htmlContent);
  }
}

function insertPrompt(text) {
  const inp = document.getElementById('message-input');
  if (inp) { inp.value = text; inp.focus(); inp.dispatchEvent(new Event('input')); }
}

// Применяет typing эффект к последнему сообщению ассистента
function applyTypingEffectToLastMessage() {
  const messages = document.querySelectorAll('.message-wrapper.assistant .message-bubble');
  if (messages.length === 0) return;
  
  const lastMessage = messages[messages.length - 1];
  if (lastMessage && !lastMessage.hasAttribute('data-typed')) {
    lastMessage.setAttribute('data-typed', 'true');
    const originalText = lastMessage.textContent;
    typeText(lastMessage, originalText, 20); // 20ms на букву - быстро но видно
  }
}



function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================
// ТЕРМИНАЛЬНЫЙ TYPING ЭФФЕКТ СО ЗВУКОМ
// ============================================

// Звук печати - используем Web Audio API
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playTypeSound() {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  // Короткий клик как на терминале
  oscillator.frequency.value = 800 + Math.random() * 400;
  oscillator.type = 'square';
  
  gainNode.gain.setValueAtTime(0.015, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.02);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.02);
}

// Функция печатающегося текста
async function typeText(element, text, speed = 15) {
  element.innerHTML = '';
  const chars = text.split('');
  
  for (let i = 0; i < chars.length; i++) {
    element.innerHTML += chars[i];
    
    // Звук на каждой букве (кроме пробелов)
    if (chars[i] !== ' ' && STATE.config.sound) {
      playTypeSound();
    }
    
    // Очень быстрая печать
    await new Promise(resolve => setTimeout(resolve, speed));
    
    // Автоскролл
    const container = document.getElementById('messages');
    if (container) {
      container.scrollTop = container.scrollHeight;
    }
  }
}

// Функция для плавной печати с HTML кодом
async function typeHTML(element, html, speed = 15) {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;
  const text = tempDiv.textContent;
  
  await typeText(element, text, speed);
}


// ============================================
// ОТПРАВКА СООБЩЕНИЙ
// ============================================

const messageInput = document.getElementById('message-input');

messageInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey && STATE.config.enterSend) {
    e.preventDefault();
    sendMessage();
  }
});

messageInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

async function sendMessage() {
  const input = document.getElementById('message-input');
  const sendButton = document.getElementById('send-button');
  const message = input.value.trim();
  
  if (!message) return;
  
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat) return;
  
  chat.messages.push({
    role: 'user',
    content: message,
    timestamp: new Date().toISOString()
  });
  
  if (chat.messages.length === 1) {
    chat.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
    document.getElementById('chat-title').textContent = chat.title;
    renderChatsList();
  }
  
  input.value = '';
  input.style.height = 'auto';
  sendButton.disabled = true;
  
  saveState();
  renderMessages();
  showTypingIndicator();
  
  try {
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': STATE.config.apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: STATE.config.model,
        max_tokens: 4096,
        temperature: STATE.config.temperature,
        system: STATE.config.systemPrompt,
        messages: chat.messages.map(msg => ({
          role: msg.role,
          content: msg.content
        }))
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error?.message || `HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const assistantMessage = data.content[0].text;
    
    chat.messages.push({
      role: 'assistant',
      content: assistantMessage,
      timestamp: new Date().toISOString()
    });
    
    saveState();
    hideTypingIndicator();
    renderMessages();
    
    // Применяем typing эффект к новому сообщению
    setTimeout(() => {
      applyTypingEffectToLastMessage();
    }, 100);
    
    if (STATE.config.sound) {
      playNotificationSound();
    }
    
  } catch (error) {
    console.error('Ошибка API:', error);
    hideTypingIndicator();
    
    const errorMessage = error.message.includes('fetch')
      ? 'Ошибка сети. Проверьте подключение к интернету.'
      : error.message.includes('API key')
      ? 'Неверный API ключ. Проверьте настройки.'
      : `Ошибка: ${error.message}`;
    
    chat.messages.push({
      role: 'assistant',
      content: `❌ ${errorMessage}`
    });
    
    saveState();
    renderMessages();
    showToast(errorMessage, 'error');
  }
  
  sendButton.disabled = false;
}

function showTypingIndicator() {
  const container = document.getElementById('messages');
  const indicator = document.createElement('div');
  indicator.className = 'message-wrapper assistant';
  indicator.id = 'typing-indicator';
  indicator.innerHTML = `
    <div class="message-avatar spinning-quantum">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Quantum Core -->
        <circle cx="32" cy="32" r="5" fill="url(#spinGrad1)">
          <animate attributeName="r" values="5;6;5" dur="1s" repeatCount="indefinite"/>
        </circle>
        
        <!-- Orbit 1 -->
        <ellipse cx="32" cy="32" rx="20" ry="10" stroke="url(#spinGrad2)" stroke-width="2" fill="none" opacity="0.8"/>
        
        <!-- Particle 1 -->
        <circle r="3" fill="url(#spinGrad3)">
          <animateMotion dur="1.5s" repeatCount="indefinite">
            <mpath href="#spinPath1"/>
          </animateMotion>
        </circle>
        
        <!-- Orbit 2 -->
        <ellipse cx="32" cy="32" rx="20" ry="10" stroke="url(#spinGrad4)" stroke-width="2" fill="none" opacity="0.8" transform="rotate(60 32 32)"/>
        
        <!-- Particle 2 -->
        <circle r="3" fill="url(#spinGrad5)">
          <animateMotion dur="1.2s" repeatCount="indefinite">
            <mpath href="#spinPath2"/>
          </animateMotion>
        </circle>
        
        <!-- Orbit 3 -->
        <ellipse cx="32" cy="32" rx="20" ry="10" stroke="url(#spinGrad6)" stroke-width="2" fill="none" opacity="0.8" transform="rotate(120 32 32)"/>
        
        <!-- Particle 3 -->
        <circle r="3" fill="url(#spinGrad7)">
          <animateMotion dur="1.8s" repeatCount="indefinite">
            <mpath href="#spinPath3"/>
          </animateMotion>
        </circle>
        
        <defs>
          <path id="spinPath1" d="M 32,22 A 20,10 0 1,1 32,42 A 20,10 0 1,1 32,22 Z"/>
          <path id="spinPath2" d="M 32,22 A 20,10 0 1,1 32,42 A 20,10 0 1,1 32,22 Z" transform="rotate(60 32 32)"/>
          <path id="spinPath3" d="M 32,22 A 20,10 0 1,1 32,42 A 20,10 0 1,1 32,22 Z" transform="rotate(120 32 32)"/>
          
          <radialGradient id="spinGrad1">
            <stop offset="0%" stop-color="#FFFFFF"/>
            <stop offset="100%" stop-color="#6366F1"/>
          </radialGradient>
          
          <linearGradient id="spinGrad2">
            <stop offset="0%" stop-color="#6366F1"/>
            <stop offset="100%" stop-color="#818CF8"/>
          </linearGradient>
          
          <radialGradient id="spinGrad3">
            <stop offset="0%" stop-color="#FFFFFF"/>
            <stop offset="100%" stop-color="#6366F1"/>
          </radialGradient>
          
          <linearGradient id="spinGrad4">
            <stop offset="0%" stop-color="#818CF8"/>
            <stop offset="100%" stop-color="#A5B4FC"/>
          </linearGradient>
          
          <radialGradient id="spinGrad5">
            <stop offset="0%" stop-color="#FFFFFF"/>
            <stop offset="100%" stop-color="#818CF8"/>
          </radialGradient>
          
          <linearGradient id="spinGrad6">
            <stop offset="0%" stop-color="#A5B4FC"/>
            <stop offset="100%" stop-color="#C7D2FE"/>
          </linearGradient>
          
          <radialGradient id="spinGrad7">
            <stop offset="0%" stop-color="#FFFFFF"/>
            <stop offset="100%" stop-color="#A5B4FC"/>
          </radialGradient>
        </defs>
      </svg>
    </div>
    <div class="message-content">
      <div class="message-bubble">
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  `;
  container.appendChild(indicator);
  container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) {
    indicator.remove();
  }
}

// ============================================
// ЗВУК УВЕДОМЛЕНИЙ
// ============================================

function playNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.15);
  } catch (error) {
    console.error('Ошибка воспроизведения звука:', error);
  }
}

// ============================================
// UI УПРАВЛЕНИЕ
// ============================================

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebar-backdrop');
  
  sidebar.classList.toggle('open');
  backdrop.classList.toggle('active');
}

function closeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebar-backdrop');
  
  sidebar.classList.remove('open');
  backdrop.classList.remove('active');
}

function toggleSettings() {
  const modal = document.getElementById('settings-modal');
  modal.classList.toggle('hidden');
}

// ============================================
// НАСТРОЙКИ
// ============================================

function updateModel() {
  STATE.config.model = document.getElementById('model-select').value;
  saveState();
  showToast('Модель обновлена', 'success');
}

function updateSystemPrompt() {
  STATE.config.systemPrompt = document.getElementById('system-prompt').value;
  saveState();
  showToast('Промпт обновлен', 'success');
}

function updateTemperature(value) {
  STATE.config.temperature = parseFloat(value);
  document.getElementById('temperature-value').textContent = value;
  document.getElementById('temperature-display').textContent = value;
  saveState();
}

function toggleSound() {
  STATE.config.sound = document.getElementById('sound-toggle').checked;
  saveState();
}

function toggleEnterSend() {
  STATE.config.enterSend = document.getElementById('enter-send-toggle').checked;
  saveState();
}

function toggleTheme() {
  const isLight = document.getElementById('theme-toggle').checked;
  STATE.config.theme = isLight ? 'light' : 'cosmic';
  
  if (isLight) {
    document.body.classList.add('light-theme');
  } else {
    document.body.classList.remove('light-theme');
  }
  
  saveState();
  showToast(`Тема изменена на ${isLight ? 'светлую' : 'космическую'}`, 'success');
}

function toggleHTMLPreview() {
  STATE.config.htmlPreview = document.getElementById('html-preview-toggle').checked;
  saveState();
  showToast(`HTML Preview ${STATE.config.htmlPreview ? 'включен' : 'выключен'}`, 'success');
}

function exportChats() {
  const data = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    user: STATE.user,
    chats: STATE.chats,
    config: STATE.config
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `kvant-ai-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Чаты успешно экспортированы', 'success');
}

function importChats() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        if (data.chats && Array.isArray(data.chats)) {
          // Объединяем импортированные чаты с существующими
          const importedIds = new Set(data.chats.map(c => c.id));
          STATE.chats = [
            ...data.chats,
            ...STATE.chats.filter(c => !importedIds.has(c.id))
          ];
          
          saveState();
          renderChatsList();
          showToast(`Импортировано ${data.chats.length} чатов`, 'success');
        } else {
          showToast('Неверный формат файла', 'error');
        }
      } catch (error) {
        showToast('Ошибка при импорте: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function clearAllData() {
  if (confirm('Вы уверены? Все чаты и настройки будут удалены безвозвратно!')) {
    if (confirm('Последнее предупреждение! Это действие нельзя отменить.')) {
      localStorage.clear();
      location.reload();
    }
  }
}

// ============================================
// УВЕДОМЛЕНИЯ
// ============================================

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || icons.info}</div>
    <div class="toast-message">${escapeHtml(message)}</div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.transition = 'all 0.3s ease';
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ============================================
// ГОРЯЧИЕ КЛАВИШИ
// ============================================

document.addEventListener('keydown', (event) => {
  // Новый чат: Cmd/Ctrl + K
  if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
    event.preventDefault();
    if (!document.getElementById('app').classList.contains('hidden')) {
      createNewChat();
    }
  }
  
  // Закрыть модалки: Escape
  if (event.key === 'Escape') {
    const settingsModal = document.getElementById('settings-modal');
    if (!settingsModal.classList.contains('hidden')) {
      toggleSettings();
    }
    
    if (window.innerWidth <= 768) {
      closeSidebar();
    }
  }
});

// ============================================
// ИНИЦИАЛИЗАЦИЯ
// ============================================

// ============================================
// ЭКРАН ЗАГРУЗКИ
// ============================================

function initLoadingScreen() {
  const loadingScreen = document.getElementById('loading-screen');
  
  // Просто показываем атом 2.5 секунды
  setTimeout(() => {
    loadingScreen.classList.add('hidden');
  }, 2500);
}

// ============================================
// ИНИЦИАЛИЗАЦИЯ
// ============================================

window.addEventListener('load', () => {
  console.log('%c KVANT AI', 'font-size: 28px; font-weight: bold; color: #0a84ff; font-family: -apple-system;');
  console.log('%c Sistema loaded', 'color: #10b981; font-size: 14px;');
  
  // Запускаем экран загрузки
  initLoadingScreen();
  
  loadState();
  initAuthParticles();
  initPasswordStrength();
  
  if (window.location.protocol === 'file:') {
    showToast('Откройте файл через веб-сервер для работы с API', 'warning');
  }
  
  if (STATE.user) {
    startApp();
  }
});

// Предотвращение bounce-эффекта на iOS
document.addEventListener('touchmove', (e) => {
  if (e.target.closest('.messages-container, .chats-list, .modal-body')) {
    return;
  }
  e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
