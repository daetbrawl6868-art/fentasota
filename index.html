<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>KVANT AI - Интеллектуальный ассистент</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* =============================================================================
   ПРОФЕССИОНАЛЬНАЯ СИСТЕМА ДИЗАЙНА - KVANT AI
   ============================================================================= */

:root {
  /* Цветовая схема */
  --color-primary: #0a84ff;
  --color-primary-dark: #0055cc;
  --color-primary-light: #5ac8fa;
  --color-secondary: #bf5af2;
  --color-accent: #32d8ff;
  --color-success: #10b981;
  --color-error: #ef4444;
  --color-warning: #f59e0b;
  
  /* Стеклянные поверхности */
  --glass-ultra: rgba(255, 255, 255, 0.02);
  --glass-subtle: rgba(255, 255, 255, 0.04);
  --glass-light: rgba(255, 255, 255, 0.06);
  --glass-medium: rgba(255, 255, 255, 0.08);
  --glass-strong: rgba(255, 255, 255, 0.12);
  
  /* Границы */
  --border-subtle: rgba(255, 255, 255, 0.06);
  --border-light: rgba(255, 255, 255, 0.08);
  --border-medium: rgba(255, 255, 255, 0.12);
  --border-strong: rgba(255, 255, 255, 0.18);
  
  /* Тени */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
  --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.7);
  
  /* Размытие */
  --blur-sm: 20px;
  --blur-md: 40px;
  --blur-lg: 60px;
  --blur-xl: 80px;
  
  /* Радиусы */
  --radius-xs: 6px;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-2xl: 24px;
  --radius-3xl: 28px;
  
  /* Размеры компонентов */
  --sidebar-width: 280px;
  --topbar-height: 64px;
  
  /* Типографика - Inter */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
  
  /* Переходы */
  --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
  
  /* Z-index система */
  --z-base: 0;
  --z-background: 1;
  --z-content: 10;
  --z-sidebar: 100;
  --z-topbar: 200;
  --z-dropdown: 300;
  --z-modal: 400;
  --z-toast: 500;
  --z-loader: 10000;
}

/* =============================================================================
   ГЛОБАЛЬНЫЕ СТИЛИ
   ============================================================================= */

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: relative;
}

#app-container {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: relative;
}

body {
  font-family: var(--font-sans);
  font-weight: 400;
  line-height: 1.6;
  background: #000000;
  color: rgba(255, 255, 255, 0.95);
}

/* =============================================================================
   КОСМИЧЕСКИЙ ФОН
   ============================================================================= */

.space-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: var(--z-background);
  overflow: hidden;
  background: radial-gradient(ellipse at bottom, #1a1f35 0%, #0a0e1a 100%);
}

.stars {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.stars::before,
.stars::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(2px 2px at 30px 40px, rgba(255, 255, 255, 0.9), transparent),
    radial-gradient(2px 2px at 80px 90px, rgba(255, 255, 255, 0.8), transparent),
    radial-gradient(1px 1px at 60px 60px, rgba(255, 255, 255, 0.7), transparent),
    radial-gradient(1px 1px at 140px 100px, rgba(255, 255, 255, 0.85), transparent),
    radial-gradient(2px 2px at 110px 30px, rgba(255, 255, 255, 0.9), transparent);
  background-size: 200px 200px;
  animation: twinkle 5s ease-in-out infinite;
}

.stars::after {
  background-image: 
    radial-gradient(1px 1px at 50px 80px, rgba(255, 255, 255, 0.8), transparent),
    radial-gradient(1px 1px at 130px 110px, rgba(255, 255, 255, 0.7), transparent),
    radial-gradient(1px 1px at 190px 50px, rgba(255, 255, 255, 0.85), transparent);
  background-size: 250px 250px;
  animation: twinkle 4s ease-in-out infinite reverse;
}

@keyframes twinkle {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.nebula {
  position: absolute;
  width: 100%;
  height: 100%;
  opacity: 0.2;
  filter: blur(120px);
  animation: drift 40s ease-in-out infinite alternate;
}

.nebula-1 {
  background: radial-gradient(circle at 25% 30%, rgba(10, 132, 255, 0.35) 0%, transparent 60%);
  animation-duration: 45s;
}

.nebula-2 {
  background: radial-gradient(circle at 75% 70%, rgba(191, 90, 242, 0.28) 0%, transparent 60%);
  animation-duration: 50s;
  animation-delay: -15s;
}

.nebula-3 {
  background: radial-gradient(circle at 50% 50%, rgba(50, 216, 255, 0.22) 0%, transparent 60%);
  animation-duration: 55s;
  animation-delay: -25s;
}

@keyframes drift {
  0% { transform: translate(0, 0) scale(1); }
  100% { transform: translate(-40px, 40px) scale(1.15); }
}

.light-rays {
  position: absolute;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    45deg,
    transparent 0%,
    rgba(10, 132, 255, 0.012) 30%,
    transparent 60%,
    rgba(191, 90, 242, 0.012) 85%,
    transparent 100%
  );
  background-size: 300% 300%;
  animation: rays 25s ease-in-out infinite;
}

@keyframes rays {
  0%, 100% { background-position: 0% 0%; }
  50% { background-position: 100% 100%; }
}

/* =============================================================================
   ЭКРАН ЗАГРУЗКИ
   ============================================================================= */

#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #000000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: var(--z-loader);
  transition: opacity 800ms cubic-bezier(0.4, 0, 0.2, 1), visibility 800ms cubic-bezier(0.4, 0, 0.2, 1);
}

#loading-screen.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-logo {
  font-size: 68px;
  font-weight: 800;
  font-family: var(--font-sans);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 4px;
  margin-bottom: 36px;
}

.logo-letter {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.7));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: letterPulse 3s ease-in-out infinite;
}

.logo-letter:nth-child(2) { animation-delay: 0.2s; }
.logo-letter:nth-child(3) { animation-delay: 0.4s; }
.logo-letter:nth-child(5) { animation-delay: 0.6s; }
.logo-letter:nth-child(6) { animation-delay: 0.8s; }

@keyframes letterPulse {
  0%, 100% { opacity: 0.7; }
  50% { 
    opacity: 1;
    text-shadow: 0 0 24px rgba(10, 132, 255, 0.5);
  }
}

.atom-container {
  position: relative;
  width: 62px;
  height: 62px;
  display: inline-block;
  margin: 0 4px;
}

.atom-nucleus {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 13px;
  height: 13px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(10, 132, 255, 0.9));
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 
    0 0 18px rgba(10, 132, 255, 0.95),
    0 0 36px rgba(10, 132, 255, 0.55),
    0 0 54px rgba(10, 132, 255, 0.25);
  animation: nucleusPulse 2.8s ease-in-out infinite;
  z-index: 3;
}

@keyframes nucleusPulse {
  0%, 100% { 
    transform: translate(-50%, -50%) scale(1);
    box-shadow: 
      0 0 18px rgba(10, 132, 255, 0.95),
      0 0 36px rgba(10, 132, 255, 0.55),
      0 0 54px rgba(10, 132, 255, 0.25);
  }
  50% { 
    transform: translate(-50%, -50%) scale(1.18);
    box-shadow: 
      0 0 28px rgba(10, 132, 255, 1),
      0 0 56px rgba(10, 132, 255, 0.75),
      0 0 84px rgba(10, 132, 255, 0.4);
  }
}

.atom-orbit {
  position: absolute;
  top: 50%;
  left: 50%;
  border: 1.5px solid;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  z-index: 1;
}

.orbit-1 {
  width: 48px;
  height: 48px;
  border-color: rgba(10, 132, 255, 0.4);
  animation: orbitRotate1 2.6s linear infinite;
}

.orbit-2 {
  width: 62px;
  height: 23px;
  border-color: rgba(191, 90, 242, 0.4);
  animation: orbitRotate2 3.4s linear infinite;
}

.orbit-3 {
  width: 62px;
  height: 23px;
  border-color: rgba(50, 216, 255, 0.4);
  animation: orbitRotate3 3s linear infinite;
}

@keyframes orbitRotate1 {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

@keyframes orbitRotate2 {
  from { transform: translate(-50%, -50%) rotate(60deg); }
  to { transform: translate(-50%, -50%) rotate(420deg); }
}

@keyframes orbitRotate3 {
  from { transform: translate(-50%, -50%) rotate(-60deg); }
  to { transform: translate(-50%, -50%) rotate(300deg); }
}

.electron {
  position: absolute;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
  z-index: 2;
}

.electron-1 {
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(10, 132, 255, 0.85));
  color: rgba(10, 132, 255, 0.75);
}

.electron-2 {
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(191, 90, 242, 0.85));
  color: rgba(191, 90, 242, 0.75);
}

.electron-3 {
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  background: radial-gradient(circle, rgba(255, 255, 255, 0.95), rgba(50, 216, 255, 0.85));
  color: rgba(50, 216, 255, 0.75);
}

.loading-text {
  font-size: 14px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.35);
  letter-spacing: 3px;
  text-transform: uppercase;
  animation: textFade 2.5s ease-in-out infinite;
}

@keyframes textFade {
  0%, 100% { opacity: 0.25; }
  50% { opacity: 0.55; }
}

/* =============================================================================
   АУТЕНТИФИКАЦИЯ
   ============================================================================= */

#auth-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-content);
  padding: 20px;
}

#auth-particles {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.auth-container {
  width: 100%;
  max-width: 440px;
  animation: authFadeIn 650ms cubic-bezier(0.16, 1, 0.3, 1) both;
  position: relative;
  z-index: 1;
}

@keyframes authFadeIn {
  from {
    opacity: 0;
    transform: translateY(48px) scale(0.96);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.auth-card {
  background: linear-gradient(
    145deg,
    rgba(255, 255, 255, 0.08) 0%,
    rgba(255, 255, 255, 0.05) 50%,
    rgba(255, 255, 255, 0.03) 100%
  );
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: var(--radius-3xl);
  padding: 52px 44px;
  backdrop-filter: blur(var(--blur-md)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--blur-md)) saturate(180%);
  box-shadow:
    0 32px 64px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(255, 255, 255, 0.08),
    inset 0 1px 0 rgba(255, 255, 255, 0.2),
    inset 0 -1px 0 rgba(0, 0, 0, 0.2);
  position: relative;
  overflow: hidden;
}

.auth-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 120px;
  background: linear-gradient(
    180deg,
    rgba(99, 102, 241, 0.15) 0%,
    rgba(50, 216, 255, 0.08) 50%,
    transparent 100%
  );
  pointer-events: none;
  opacity: 0.8;
}

.auth-header {
  text-align: center;
  margin-bottom: 26px;
  position: relative;
  z-index: 1;
  animation: authSlideUp 750ms 80ms cubic-bezier(0.16, 1, 0.3, 1) both;
}

@keyframes authSlideUp {
  from { 
    opacity: 0; 
    transform: translateY(16px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

.auth-logo-container {
  width: 78px;
  height: 78px;
  margin: 0 auto 20px;
  animation: logoFloat 5.5s ease-in-out infinite;
}

@keyframes logoFloat {
  0%, 100% { transform: translateY(0) rotate(-0.8deg); }
  50% { transform: translateY(-10px) rotate(0.8deg); }
}

.auth-logo {
  width: 100%;
  height: 100%;
  position: relative;
  filter: drop-shadow(0 0 22px rgba(10, 132, 255, 0.6));
}

.auth-title {
  font-size: 28px;
  font-weight: 700;
  line-height: 1.2;
  margin-bottom: 10px;
  letter-spacing: -0.03em;
  color: rgba(255, 255, 255, 0.95);
  font-family: var(--font-sans);
}

.auth-subtitle {
  font-size: 14px;
  font-weight: 400;
  letter-spacing: -0.01em;
  color: rgba(148, 163, 184, 0.75);
  font-family: var(--font-sans);
}

.auth-features {
  display: flex;
  gap: 7px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 14px;
}

.auth-feature-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: rgba(255, 255, 255, 0.035);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 100px;
  font-size: 10.5px;
  font-weight: 500;
  color: rgba(175, 192, 228, 0.55);
  letter-spacing: 0.03em;
  cursor: default;
  transition: all 220ms ease;
}

.auth-feature-pill svg {
  width: 11px;
  height: 11px;
}

.auth-feature-pill:hover {
  background: rgba(10, 132, 255, 0.09);
  border-color: rgba(10, 132, 255, 0.26);
  color: rgba(90, 200, 250, 0.88);
  transform: translateY(-1px);
}

.auth-tabs {
  display: flex;
  position: relative;
  background: rgba(0, 0, 0, 0.32);
  border: 1px solid rgba(255, 255, 255, 0.07);
  border-radius: 14px;
  padding: 3px;
  margin-bottom: 26px;
  width: 100%;
  z-index: 1;
  animation: authSlideUp 750ms 120ms cubic-bezier(0.16, 1, 0.3, 1) both;
}

.auth-tab {
  flex: 1;
  height: 36px;
  background: none;
  border: none;
  border-radius: 11px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(155, 170, 215, 0.48);
  cursor: pointer;
  transition: color 220ms ease;
  position: relative;
  z-index: 2;
  letter-spacing: -0.01em;
  font-family: var(--font-sans);
}

.auth-tab.active {
  color: rgba(255, 255, 255, 0.93);
}

.auth-tab-indicator {
  position: absolute;
  top: 3px;
  bottom: 3px;
  width: calc(50% - 3px);
  left: 3px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.11), rgba(255, 255, 255, 0.05));
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 11px;
  transition: transform 380ms cubic-bezier(0.34, 1.56, 0.64, 1);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12), 0 2px 10px rgba(0, 0, 0, 0.35);
  z-index: 1;
}

.auth-tab-indicator.right {
  transform: translateX(100%);
}

.auth-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  z-index: 1;
  animation: authSlideUp 500ms cubic-bezier(0.16, 1, 0.3, 1) both;
}

.auth-panel.hidden {
  display: none;
}

.btn-google {
  width: 100%;
  height: 52px;
  background: rgba(255, 255, 255, 0.05);
  border: none;
  border-radius: 18px;
  color: rgba(255, 255, 255, 0.90);
  font-size: 14.5px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
  letter-spacing: -0.01em;
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(30px) saturate(180%);
  -webkit-backdrop-filter: blur(30px) saturate(180%);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
  font-family: var(--font-sans);
}

.btn-google::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, transparent 60%);
  opacity: 0;
  transition: opacity 300ms;
}

.btn-google:hover::before {
  opacity: 1;
}

.btn-google:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}

.btn-google:active {
  transform: translateY(-1px) scale(0.98);
}

.google-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
}

.auth-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  color: rgba(160, 175, 210, 0.35);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.auth-divider::before,
.auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: rgba(255, 255, 255, 0.08);
}

.auth-form-inner {
  display: flex;
  flex-direction: column;
  gap: 11px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-label {
  font-size: 13px;
  font-weight: 600;
  color: rgba(200, 215, 240, 0.75);
  letter-spacing: -0.01em;
  margin-bottom: 7px;
}

.form-input-wrap {
  position: relative;
  display: flex;
  align-items: center;
}

.input-icon {
  position: absolute;
  left: 14px;
  width: 17px;
  height: 17px;
  color: rgba(140, 160, 210, 0.45);
  pointer-events: none;
  transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 2;
  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

.form-input-wrap:focus-within .input-icon {
  color: rgba(10, 132, 255, 0.90);
  transform: scale(1.15);
  filter: drop-shadow(0 2px 4px rgba(10, 132, 255, 0.4));
}

.form-input {
  width: 100%;
  height: 48px;
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: var(--radius-md);
  padding: 0 42px 0 44px;
  font-size: 15px;
  color: rgba(255, 255, 255, 0.95);
  font-family: var(--font-sans);
  font-weight: 400;
  transition: all 200ms ease;
  outline: none;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  caret-color: #6366F1;
}

.form-input::placeholder {
  color: rgba(148, 163, 184, 0.5);
}

.form-input:focus {
  background: rgba(15, 23, 42, 0.8);
  border-color: #6366F1;
  box-shadow:
    0 0 0 3px rgba(99, 102, 241, 0.1),
    0 1px 2px rgba(0, 0, 0, 0.05);
}

.form-input:hover:not(:focus) {
  border-color: rgba(148, 163, 184, 0.3);
}

.input-toggle-pw {
  position: absolute;
  right: 12px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  color: rgba(150, 170, 210, 0.4);
  transition: all 300ms;
  display: flex;
  align-items: center;
  border-radius: 8px;
}

.input-toggle-pw:hover {
  color: rgba(220, 230, 255, 0.85);
  background: rgba(255, 255, 255, 0.08);
}

.input-toggle-pw svg {
  width: 16px;
  height: 16px;
}

.password-strength {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
}

.pw-bar {
  flex: 1;
  height: 2.5px;
  border-radius: 2px;
  background: rgba(255, 255, 255, 0.065);
  transition: background 380ms ease;
}

.pw-bar.weak {
  background: #ff453a;
  box-shadow: 0 0 6px rgba(255, 69, 58, 0.4);
}

.pw-bar.fair {
  background: #ff9f0a;
  box-shadow: 0 0 6px rgba(255, 159, 10, 0.4);
}

.pw-bar.good {
  background: #30d158;
  box-shadow: 0 0 6px rgba(48, 209, 88, 0.4);
}

.pw-bar.strong {
  background: #32ade6;
  box-shadow: 0 0 6px rgba(50, 174, 230, 0.4);
}

.pw-label {
  font-size: 10.5px;
  font-weight: 500;
  color: rgba(140, 158, 205, 0.55);
  min-width: 44px;
  text-align: right;
  transition: color 300ms;
}

.remember-me-checkbox {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
  margin-top: 5px;
}

.remember-me-checkbox input[type="checkbox"] {
  display: none;
}

.checkbox-custom {
  position: relative;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(148, 163, 184, 0.3);
  border-radius: 6px;
  background: rgba(15, 23, 42, 0.6);
  transition: all 200ms ease;
  flex-shrink: 0;
}

.checkbox-custom::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0);
  width: 10px;
  height: 10px;
  background: white;
  border-radius: 3px;
  transition: transform 200ms ease;
}

.remember-me-checkbox input[type="checkbox"]:checked + .checkbox-custom {
  background: #6366F1;
  border-color: #6366F1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
}

.remember-me-checkbox input[type="checkbox"]:checked + .checkbox-custom::after {
  transform: translate(-50%, -50%) scale(1);
}

.checkbox-label {
  font-size: 14px;
  color: rgba(200, 210, 240, 0.7);
  font-weight: 500;
}

.remember-me-checkbox:hover .checkbox-custom {
  border-color: rgba(148, 163, 184, 0.5);
}

.remember-me-checkbox:hover .checkbox-label {
  color: rgba(220, 230, 250, 0.9);
}

.btn-primary {
  width: 100%;
  height: 48px;
  background: #6366F1;
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: 15px;
  font-weight: 600;
  font-family: var(--font-sans);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 200ms ease;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  position: relative;
  overflow: hidden;
  letter-spacing: -0.01em;
}

.btn-primary:hover {
  background: #4F46E5;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-primary svg {
  width: 18px;
  height: 18px;
  transition: transform 200ms ease;
}

.btn-primary:hover svg {
  transform: translateX(2px);
}

/* =============================================================================
   ОСНОВНОЕ ПРИЛОЖЕНИЕ
   ============================================================================= */

#app {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  z-index: var(--z-content);
}

/* Сайдбар */
.sidebar {
  width: var(--sidebar-width);
  height: 100%;
  background: var(--glass-medium);
  backdrop-filter: blur(var(--blur-md)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--blur-md)) saturate(180%);
  border-right: 1px solid var(--border-light);
  display: flex;
  flex-direction: column;
  z-index: var(--z-sidebar);
  transition: transform var(--transition-base);
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border-subtle);
}

.btn-new-chat {
  width: 100%;
  padding: 14px 20px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
  border: none;
  border-radius: var(--radius-lg);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  font-family: var(--font-sans);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
}

.btn-new-chat:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(10, 132, 255, 0.4);
}

.btn-new-chat svg {
  width: 20px;
  height: 20px;
}

.chats-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.chat-item {
  padding: 14px 16px;
  margin-bottom: 6px;
  background: transparent;
  border: 1px solid transparent;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-item:hover {
  background: var(--glass-light);
  border-color: var(--border-light);
}

.chat-item.active {
  background: rgba(10, 132, 255, 0.15);
  border-color: rgba(10, 132, 255, 0.3);
  box-shadow: 0 2px 8px rgba(10, 132, 255, 0.2);
}

.chat-icon {
  width: 36px;
  height: 36px;
  background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(191, 90, 242, 0.2));
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 16px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.8);
}

.chat-info {
  flex: 1;
  min-width: 0;
}

.chat-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.chat-preview {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chat-time {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.3);
  flex-shrink: 0;
}

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border-subtle);
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--glass-subtle);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all var(--transition-fast);
  border: 1px solid transparent;
}

.user-profile:hover {
  background: var(--glass-light);
  border-color: var(--border-light);
}

.user-avatar {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
}

.user-info {
  flex: 1;
  min-width: 0;
}

.user-name {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.user-email {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Основной контент */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100%;
}

.topbar {
  height: var(--topbar-height);
  background: var(--glass-medium);
  backdrop-filter: blur(var(--blur-md)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--blur-md)) saturate(180%);
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  z-index: var(--z-topbar);
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.btn-menu {
  width: 40px;
  height: 40px;
  background: var(--glass-light);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: rgba(255, 255, 255, 0.7);
}

.topbar-title {
  font-size: 18px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  letter-spacing: -0.3px;
}

.topbar-actions {
  display: flex;
  gap: 8px;
}

.btn-icon {
  width: 40px;
  height: 40px;
  background: var(--glass-light);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--transition-fast);
  color: rgba(255, 255, 255, 0.7);
}

.btn-icon:hover {
  background: var(--glass-medium);
  border-color: var(--border-medium);
  color: rgba(255, 255, 255, 0.9);
  transform: translateY(-1px);
}

.btn-icon svg {
  width: 20px;
  height: 20px;
}

/* Сообщения */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.message-group {
  display: flex;
  gap: 12px;
  animation: messageSlideIn 400ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-group.user {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  flex-shrink: 0;
  box-shadow: var(--shadow-md);
}

.message-group.assistant .message-avatar {
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
}

.message-group.user .message-avatar {
  background: linear-gradient(135deg, var(--color-success), #059669);
}

.message-bubble {
  max-width: 70%;
  padding: 16px 20px;
  background: var(--glass-light);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xl);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

.message-group.user .message-bubble {
  background: linear-gradient(135deg, rgba(10, 132, 255, 0.2), rgba(0, 85, 204, 0.2));
  border-color: rgba(10, 132, 255, 0.3);
}

.message-content {
  color: rgba(255, 255, 255, 0.95);
  font-size: 15px;
  line-height: 1.7;
  word-wrap: break-word;
}

.message-content code {
  background: rgba(0, 0, 0, 0.3);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 14px;
}

.message-content pre {
  background: rgba(0, 0, 0, 0.3);
  padding: 16px;
  border-radius: var(--radius-md);
  overflow-x: auto;
  margin: 12px 0;
}

.message-content pre code {
  background: none;
  padding: 0;
}

.message-time {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.3);
  margin-top: 8px;
  text-align: right;
}

.typing-indicator {
  display: flex;
  gap: 6px;
  padding: 12px 16px;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.4);
  border-radius: 50%;
  animation: typingBounce 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingBounce {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 40px 20px;
}

.empty-icon {
  width: 120px;
  height: 120px;
  background: linear-gradient(135deg, rgba(10, 132, 255, 0.1), rgba(191, 90, 242, 0.1));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 24px;
  font-size: 48px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.5);
}

.empty-title {
  font-size: 24px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 12px;
}

.empty-description {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.4);
  max-width: 400px;
  line-height: 1.6;
}

/* Поле ввода */
.input-area {
  padding: 24px;
  border-top: 1px solid var(--border-subtle);
}

.input-container {
  background: var(--glass-medium);
  backdrop-filter: blur(var(--blur-md)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--blur-md)) saturate(180%);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-2xl);
  padding: 16px 20px;
  display: flex;
  align-items: flex-end;
  gap: 12px;
  transition: all var(--transition-base);
}

.input-container:focus-within {
  border-color: rgba(10, 132, 255, 0.5);
  box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.1);
  background: var(--glass-strong);
}

.chat-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.95);
  font-size: 15px;
  font-family: var(--font-sans);
  resize: none;
  max-height: 120px;
  line-height: 1.6;
}

.chat-input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}

.btn-send {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
  border: none;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-base);
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
}

.btn-send:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(10, 132, 255, 0.4);
}

.btn-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-send svg {
  width: 22px;
  height: 22px;
}

/* =============================================================================
   МОБИЛЬНАЯ АДАПТАЦИЯ
   ============================================================================= */

@media (max-width: 768px) {
  /* Скрываем сайдбар по умолчанию на мобильных */
  #sidebar {
    transform: translateX(-100%);
    width: 85%;
    max-width: 320px;
  }
  
  #sidebar.open {
    transform: translateX(0);
  }
  
  /* Убираем отступ для контента, так как сайдбар скрыт */
  #main-content {
    margin-left: 0;
  }
  
  /* Топбар на всю ширину */
  #topbar {
    left: 0;
    width: 100%;
  }
  
  /* Контейнер чата с учетом виртуальной клавиатуры */
  #chat-container {
    padding-bottom: 80px;
    min-height: calc(100vh - var(--topbar-height) - 100px);
  }
  
  /* Панель ввода фиксируется внизу */
  #input-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 16px;
    padding-bottom: max(12px, env(safe-area-inset-bottom));
    margin: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border-medium);
    z-index: 100;
  }
  
  /* Контейнер ввода адаптивный */
  .input-container {
    max-width: 100%;
  }
  
  /* Текстовое поле более компактное */
  #chat-input {
    font-size: 16px; /* Предотвращает зум на iOS */
    min-height: 44px; /* Минимальный размер касания iOS */
    max-height: 120px;
  }
  
  /* Кнопки более крупные для удобства нажатия */
  .icon-btn, .btn-attach, .btn-voice {
    min-width: 44px;
    min-height: 44px;
    padding: 10px;
  }
  
  .send-btn, .btn-send {
    min-width: 44px;
    min-height: 44px;
    padding: 10px;
  }
  
  /* Кнопки в топбаре */
  .btn-new-chat, .btn-settings {
    min-width: 40px;
    min-height: 40px;
  }
  
  /* Сообщения более компактные */
  .message {
    padding: 12px 16px;
    font-size: 15px;
  }
  
  /* Кнопка меню всегда видна на мобильных */
  #menu-btn {
    display: flex !important;
  }
  
  /* Уменьшаем отступы в топбаре */
  #topbar {
    padding: 0 12px;
    height: 56px;
  }
  
  /* Лого компактнее */
  .logo {
    font-size: 20px;
  }
  
  /* Иконка модели меньше */
  .model-icon {
    width: 32px;
    height: 32px;
  }
  
  /* Модальные окна на весь экран на мобильных */
  .modal-content {
    width: 95%;
    max-width: 95%;
    max-height: 90vh;
    margin: 20px auto;
  }
  
  /* Дропдауны на всю ширину */
  .dropdown-menu {
    max-width: calc(100vw - 32px);
  }
}

@media (max-width: 480px) {
  /* Еще более компактный вид для маленьких экранов */
  .logo-text {
    display: none;
  }
  
  #chat-input {
    font-size: 16px;
    padding: 12px 14px;
  }
  
  .message {
    padding: 10px 14px;
    font-size: 14px;
  }
  
  .input-actions {
    gap: 6px;
  }
}

/* Фикс для iOS Safari - предотвращаем прыжки при открытии клавиатуры */
@supports (-webkit-touch-callout: none) {
  body {
    position: fixed;
    width: 100%;
  }
  
  #app-container {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
}

/* =============================================================================
   МОДАЛЬНЫЕ ОКНА
   ============================================================================= */

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-modal);
  padding: 20px;
  animation: fadeIn 300ms ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--glass-strong);
  backdrop-filter: blur(var(--blur-lg)) saturate(200%);
  -webkit-backdrop-filter: blur(var(--blur-lg)) saturate(200%);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-2xl);
  padding: 32px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: var(--shadow-xl);
  animation: modalSlideIn 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 28px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border-subtle);
}

.modal-title {
  font-size: 28px;
  font-weight: 800;
  color: rgba(255, 255, 255, 0.95);
  letter-spacing: -0.5px;
}

.btn-close {
  width: 36px;
  height: 36px;
  background: var(--glass-light);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition-fast);
}

.btn-close:hover {
  background: var(--glass-medium);
  color: rgba(255, 255, 255, 0.9);
}

.btn-close svg {
  width: 20px;
  height: 20px;
}

.modal-body {
  color: rgba(255, 255, 255, 0.7);
  font-size: 15px;
  line-height: 1.7;
}

.settings-section {
  margin-bottom: 32px;
  padding-bottom: 32px;
  border-bottom: 1px solid var(--border-subtle);
}

.settings-section:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.95);
  margin-bottom: 20px;
}

.setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
}

.setting-item:last-child {
  border-bottom: none;
}

.setting-info {
  flex: 1;
}

.setting-label {
  font-size: 15px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 4px;
}

.setting-description {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
}

.btn-secondary {
  padding: 10px 16px;
  background: var(--glass-light);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-md);
  color: rgba(255, 255, 255, 0.9);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  font-family: var(--font-sans);
}

.btn-secondary:hover {
  background: var(--glass-medium);
  border-color: rgba(10, 132, 255, 0.4);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(10, 132, 255, 0.2);
}

.btn-danger {
  padding: 12px 16px;
  background: linear-gradient(135deg, var(--color-error), #dc2626);
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-base);
  font-family: var(--font-sans);
}

.btn-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
}

.btn-group {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

select.form-input {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='rgba(255,255,255,0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  padding-right: 44px;
}

textarea.form-input {
  min-height: 120px;
  resize: vertical;
  padding: 12px 16px;
}

/* Тоасты */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--glass-strong);
  backdrop-filter: blur(var(--blur-md)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--blur-md)) saturate(180%);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-xl);
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--shadow-lg);
  z-index: var(--z-toast);
  animation: toastSlideIn 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  min-width: 300px;
  max-width: 500px;
}

@keyframes toastSlideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.toast-icon {
  width: 24px;
  height: 24px;
  flex-shrink: 0;
}

.toast.success {
  border-color: rgba(16, 185, 129, 0.3);
}

.toast.success .toast-icon {
  color: var(--color-success);
}

.toast.error {
  border-color: rgba(239, 68, 68, 0.3);
}

.toast.error .toast-icon {
  color: var(--color-error);
}

.toast.info {
  border-color: rgba(10, 132, 255, 0.3);
}

.toast.info .toast-icon {
  color: var(--color-primary);
}

.toast-message {
  color: rgba(255, 255, 255, 0.95);
  font-size: 14px;
  font-weight: 500;
  flex: 1;
}

/* =============================================================================
   УТИЛИТЫ
   ============================================================================= */

.hidden {
  display: none !important;
}

::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.15);
}

.sidebar-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  z-index: calc(var(--z-sidebar) - 1);
  opacity: 0;
  transition: opacity var(--transition-base);
}

.sidebar-backdrop.active {
  opacity: 1;
}

/* =============================================================================
   НОВЫЕ ФУНКЦИИ - Кнопки копирования, редактирования и открытия HTML
   ============================================================================= */

.message-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity var(--transition-fast);
  z-index: 10;
}

.message-group:hover .message-actions {
  opacity: 1;
}

.message-action-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass-strong);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
  color: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
}

.message-action-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: var(--border-strong);
  color: rgba(255, 255, 255, 0.95);
  transform: scale(1.1);
}

.message-action-btn:active {
  transform: scale(0.95);
}

.message-action-btn svg {
  width: 16px;
  height: 16px;
}

.code-block-wrapper {
  position: relative;
  margin: 12px 0;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid var(--border-subtle);
}

.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.03);
  border-bottom: 1px solid var(--border-subtle);
}

.code-language {
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.5);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.code-actions {
  display: flex;
  gap: 6px;
}

.code-action-btn {
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 500;
  background: var(--glass-medium);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition-fast);
  color: rgba(255, 255, 255, 0.7);
  display: flex;
  align-items: center;
  gap: 4px;
}

.code-action-btn:hover {
  background: var(--glass-strong);
  border-color: var(--border-medium);
  color: rgba(255, 255, 255, 0.95);
  transform: translateY(-1px);
}

.code-action-btn:active {
  transform: translateY(0);
}

.code-action-btn.success {
  background: rgba(16, 185, 129, 0.2);
  border-color: rgba(16, 185, 129, 0.3);
  color: var(--color-success);
}

.code-action-btn svg {
  width: 12px;
  height: 12px;
}

.edit-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: var(--z-modal);
  padding: 20px;
}

.edit-modal-content {
  background: var(--glass-strong);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-xl);
  padding: 24px;
  max-width: 600px;
  width: 100%;
  backdrop-filter: blur(var(--blur-lg));
}

.edit-modal-header {
  font-size: 20px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.95);
  margin-bottom: 16px;
}

.edit-textarea {
  width: 100%;
  min-height: 150px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 12px;
  color: rgba(255, 255, 255, 0.95);
  font-family: var(--font-sans);
  font-size: 15px;
  line-height: 1.6;
  resize: vertical;
  outline: none;
  transition: all var(--transition-fast);
}

.edit-textarea:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
}

.edit-modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  justify-content: flex-end;
}

/* =============================================================================
   АДАПТИВНОСТЬ
   ============================================================================= */

@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    transform: translateX(-100%);
  }
  
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
  }
  
  .sidebar-backdrop {
    display: block;
  }
  
  .btn-menu {
    display: flex;
  }
  
  .auth-card {
    padding: 42px 32px;
  }
  
  .loading-logo {
    font-size: 54px;
  }
  
  .atom-container {
    width: 48px;
    height: 48px;
  }
  
  .messages-container {
    padding: 16px;
  }
  
  .message-bubble {
    max-width: 85%;
  }
  
  .input-area {
    padding: 16px;
  }
}

@media (max-width: 480px) {
  .auth-card {
    padding: 36px 24px;
  }
  
  .form-input {
    font-size: 16px;
  }
  
  .loading-logo {
    font-size: 44px;
  }
}
</style>
</head>
<body>

<!-- КОСМИЧЕСКИЙ ФОН -->
<div class="space-background">
  <div class="stars"></div>
  <div class="nebula nebula-1"></div>
  <div class="nebula nebula-2"></div>
  <div class="nebula nebula-3"></div>
  <div class="light-rays"></div>
</div>

<!-- ЭКРАН ЗАГРУЗКИ -->
<div id="loading-screen">
  <div class="loading-logo">
    <span class="logo-letter">K</span>
    <span class="logo-letter">V</span>
    <div class="atom-container">
      <div class="atom-nucleus"></div>
      <div class="atom-orbit orbit-1">
        <div class="electron electron-1"></div>
      </div>
      <div class="atom-orbit orbit-2">
        <div class="electron electron-2"></div>
      </div>
      <div class="atom-orbit orbit-3">
        <div class="electron electron-3"></div>
      </div>
    </div>
    <span class="logo-letter">N</span>
    <span class="logo-letter">T</span>
    <span class="logo-letter" style="margin-left: 14px; font-size: 52px; opacity: 0.88;">A</span>
    <span class="logo-letter" style="font-size: 52px; opacity: 0.88;">I</span>
  </div>
  <div class="loading-text">Инициализация системы</div>
</div>

<!-- АУТЕНТИФИКАЦИЯ -->
<div id="auth-screen" class="hidden">
  <canvas id="auth-particles"></canvas>
  
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo-container">
          <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="8" fill="url(#nucleus-gradient)">
              <animate attributeName="r" values="8;9.5;8" dur="2.5s" repeatCount="indefinite"/>
            </circle>
            
            <ellipse cx="50" cy="50" rx="30" ry="30" fill="none" stroke="rgba(10,132,255,0.4)" stroke-width="1.5">
              <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="2.6s" repeatCount="indefinite"/>
            </ellipse>
            
            <ellipse cx="50" cy="50" rx="40" ry="15" fill="none" stroke="rgba(191,90,242,0.4)" stroke-width="1.5">
              <animateTransform attributeName="transform" type="rotate" from="60 50 50" to="420 50 50" dur="3.4s" repeatCount="indefinite"/>
            </ellipse>
            
            <ellipse cx="50" cy="50" rx="40" ry="15" fill="none" stroke="rgba(50,216,255,0.4)" stroke-width="1.5">
              <animateTransform attributeName="transform" type="rotate" from="-60 50 50" to="300 50 50" dur="3s" repeatCount="indefinite"/>
            </ellipse>
            
            <circle r="4" fill="url(#electron-gradient-1)">
              <animateMotion dur="2.6s" repeatCount="indefinite">
                <mpath href="#orbit1"/>
              </animateMotion>
            </circle>
            
            <circle r="4" fill="url(#electron-gradient-2)">
              <animateMotion dur="3.4s" repeatCount="indefinite">
                <mpath href="#orbit2"/>
              </animateMotion>
            </circle>
            
            <circle r="4" fill="url(#electron-gradient-3)">
              <animateMotion dur="3s" repeatCount="indefinite">
                <mpath href="#orbit3"/>
              </animateMotion>
            </circle>
            
            <path id="orbit1" d="M 50,20 A 30,30 0 1,1 50,80 A 30,30 0 1,1 50,20" fill="none"/>
            <ellipse id="orbit2" cx="50" cy="50" rx="40" ry="15" fill="none" transform="rotate(60 50 50)"/>
            <ellipse id="orbit3" cx="50" cy="50" rx="40" ry="15" fill="none" transform="rotate(-60 50 50)"/>
            
            <defs>
              <radialGradient id="nucleus-gradient">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#0a84ff"/>
              </radialGradient>
              <radialGradient id="electron-gradient-1">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#0a84ff"/>
              </radialGradient>
              <radialGradient id="electron-gradient-2">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#bf5af2"/>
              </radialGradient>
              <radialGradient id="electron-gradient-3">
                <stop offset="0%" stop-color="#ffffff"/>
                <stop offset="100%" stop-color="#32d8ff"/>
              </radialGradient>
            </defs>
          </svg>
        </div>
        <h1 class="auth-title">KVANT AI</h1>
        <p class="auth-subtitle">Интеллектуальный ассистент нового поколения</p>
        <div class="auth-features">
          <div class="auth-feature-pill">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            <span>Быстрый</span>
          </div>
          <div class="auth-feature-pill">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span>Умный</span>
          </div>
          <div class="auth-feature-pill">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2"/>
              <path d="M7 11V7a5 5 0 0110 0v4"/>
            </svg>
            <span>Безопасный</span>
          </div>
        </div>
      </div>
      
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">Вход</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
        <div class="auth-tab-indicator"></div>
      </div>
      
      <div id="login-panel" class="auth-panel">
        <button class="btn-google" onclick="loginWithGoogle()">
          <svg class="google-icon" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span>Продолжить с Google</span>
        </button>
        
        <div class="auth-divider">
          <span>или</span>
        </div>
        
        <form class="auth-form-inner" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label">Email</label>
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              <input type="email" class="form-input" id="login-email" placeholder="your@email.com" required autocomplete="email">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Пароль</label>
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <input type="password" class="form-input" id="login-password" placeholder="••••••••" required autocomplete="current-password">
              <button type="button" class="input-toggle-pw" onclick="togglePassword('login-password', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
          </div>
          
          <label class="remember-me-checkbox">
            <input type="checkbox" id="remember-me">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Запомнить меня</span>
          </label>
          
          <button type="submit" class="btn-primary">
            <span>Войти</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </form>
      </div>
      
      <div id="register-panel" class="auth-panel hidden">
        <button class="btn-google" onclick="loginWithGoogle()">
          <svg class="google-icon" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          <span>Продолжить с Google</span>
        </button>
        
        <div class="auth-divider">
          <span>или</span>
        </div>
        
        <form class="auth-form-inner" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label class="form-label">Имя</label>
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <input type="text" class="form-input" id="register-name" placeholder="Александр Смирнов" required autocomplete="name">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Email</label>
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              <input type="email" class="form-input" id="register-email" placeholder="your@email.com" required autocomplete="email">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Пароль</label>
            <div class="form-input-wrap">
              <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <input type="password" class="form-input" id="register-password" placeholder="••••••••" required minlength="6" autocomplete="new-password" oninput="updatePasswordStrength(this.value)">
              <button type="button" class="input-toggle-pw" onclick="togglePassword('register-password', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
            <div class="password-strength">
              <div class="pw-bar"></div>
              <div class="pw-bar"></div>
              <div class="pw-bar"></div>
              <div class="pw-bar"></div>
              <span class="pw-label" id="pw-label"></span>
            </div>
          </div>
          
          <button type="submit" class="btn-primary">
            <span>Создать аккаунт</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
              <polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ОСНОВНОЕ ПРИЛОЖЕНИЕ -->
<div id="app" class="hidden">
  <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="closeSidebar()"></div>
  
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="btn-new-chat" onclick="createNewChat()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        <span>Новый чат</span>
      </button>
    </div>
    
    <div class="chats-list" id="chats-list"></div>
    
    <div class="sidebar-footer">
      <div class="user-profile" onclick="toggleSettings()">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Пользователь</div>
          <div class="user-email" id="user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="572224322517322f363a273b327934383a">[email&#160;protected]</a></div>
        </div>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: rgba(255,255,255,0.3);">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6"/>
        </svg>
      </div>
    </div>
  </aside>
  
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="btn-menu" onclick="toggleSidebar()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
        <div class="topbar-title" id="chat-title">Новый чат</div>
      </div>
      
      <div class="topbar-actions">
        <button class="btn-icon" onclick="clearCurrentChat()" title="Очистить чат">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
          </svg>
        </button>
        
        <button class="btn-icon" onclick="toggleSettings()" title="Настройки">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6M7.05 7.05L3.51 3.51m0 16.98l3.54-3.54M1 12h6m6 0h6m-4.95 4.95l3.54 3.54M20.49 3.51l-3.54 3.54"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="messages-container" id="messages-container">
      <div class="empty-state">
        <div class="empty-icon">AI</div>
        <div class="empty-title">Начните новый диалог</div>
        <div class="empty-description">
          Задайте любой вопрос или выберите один из предложенных запросов
        </div>
      </div>
    </div>
    
    <div class="input-area">
      <div class="input-container">
        <textarea 
          class="chat-input" 
          id="chat-input" 
          placeholder="Введите сообщение..."
          rows="1"
          onkeydown="handleInputKeydown(event)"
          oninput="autoResizeInput(this)"
        ></textarea>
        
        <button class="btn-send" id="send-button">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<!-- МОДАЛЬНОЕ ОКНО НАСТРОЕК -->
<div id="settings-modal" class="modal hidden" onclick="if(event.target === this) toggleSettings()">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Настройки</h2>
      <button class="btn-close" onclick="toggleSettings()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="settings-section">
        <h3 class="section-title">Модель</h3>
        <div class="form-group">
          <label class="form-label">Выберите модель</label>
          <select id="model-select" class="form-input" onchange="updateModel()">
            <option value="llama-3.3-70b-versatile">Llama 3.3 70B</option>
            <option value="llama-3.1-70b-versatile">Llama 3.1 70B</option>
            <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Системный промпт</label>
          <textarea 
            id="system-prompt" 
            class="form-input" 
            placeholder="Вы - полезный ассистент..."
            onchange="updateSystemPrompt()"
          ></textarea>
        </div>
      </div>
      
      <div class="settings-section">
        <h3 class="section-title">Данные</h3>
        <div class="btn-group">
          <button class="btn-secondary" onclick="exportChats()">Экспортировать</button>
          <button class="btn-secondary" onclick="importChats()">Импортировать</button>
        </div>
        <div class="btn-group">
          <button class="btn-danger" onclick="clearAllData()">Очистить все данные</button>
        </div>
      </div>
      
      <div class="settings-section">
        <h3 class="section-title">Профиль</h3>
        <div class="setting-item">
          <div class="setting-info">
            <div class="setting-label">Аккаунт</div>
            <div class="setting-description" id="settings-user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="493c3a2c3b092c31282439252c672a2624">[email&#160;protected]</a></div>
          </div>
          <button class="btn-secondary" onclick="logout()">Выйти</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// =============================================================================
// КОНФИГУРАЦИЯ API
// =============================================================================

const API_CONFIG = {
  GROQ_API_KEY: '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',
  GROQ_API_URL: 'https://api.groq.com/openai/v1/chat/completions',
  DEFAULT_MODEL: 'llama-3.3-70b-versatile',
  SYSTEM_PROMPT: 'Вы - KVANT AI, умный и полезный ассистент. Отвечайте кратко, четко и профессионально. Используйте markdown для форматирования кода.'
};

// =============================================================================
// ГЛОБАЛЬНОЕ СОСТОЯНИЕ
// =============================================================================

const STATE = {
  user: null,
  chats: [],
  currentChatId: null,
  config: {
    model: API_CONFIG.DEFAULT_MODEL,
    systemPrompt: API_CONFIG.SYSTEM_PROMPT,
    enterSend: true
  },
  isGenerating: false
};

// =============================================================================
// ЛОКАЛЬНОЕ ХРАНИЛИЩЕ
// =============================================================================

function saveState() {
  try {
    localStorage.setItem('kvant-ai-state', JSON.stringify(STATE));
  } catch (error) {
    console.error('Ошибка сохранения:', error);
    showToast('Ошибка сохранения данных', 'error');
  }
}

function loadState() {
  try {
    const saved = localStorage.getItem('kvant-ai-state');
    if (saved) {
      const data = JSON.parse(saved);
      Object.assign(STATE, data);
      
      if (STATE.config) {
        const modelSelect = document.getElementById('model-select');
        const systemPrompt = document.getElementById('system-prompt');
        
        if (modelSelect) modelSelect.value = STATE.config.model || API_CONFIG.DEFAULT_MODEL;
        if (systemPrompt) systemPrompt.value = STATE.config.systemPrompt || API_CONFIG.SYSTEM_PROMPT;
      }
    }
  } catch (error) {
    console.error('Ошибка загрузки:', error);
  }
}

// =============================================================================
// АУТЕНТИФИКАЦИЯ
// =============================================================================

function switchAuthTab(tab) {
  const indicator = document.querySelector('.auth-tab-indicator');
  const loginPanel = document.getElementById('login-panel');
  const registerPanel = document.getElementById('register-panel');
  const tabs = document.querySelectorAll('.auth-tab');
  
  tabs.forEach(t => t.classList.remove('active'));
  
  if (tab === 'login') {
    tabs[0].classList.add('active');
    indicator.classList.remove('right');
    loginPanel.classList.remove('hidden');
    registerPanel.classList.add('hidden');
  } else {
    tabs[1].classList.add('active');
    indicator.classList.add('right');
    loginPanel.classList.add('hidden');
    registerPanel.classList.remove('hidden');
  }
}

function togglePassword(inputId, button) {
  const input = document.getElementById(inputId);
  const svg = button.querySelector('svg');
  
  if (input.type === 'password') {
    input.type = 'text';
    svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
  } else {
    input.type = 'password';
    svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
  }
}

function updatePasswordStrength(password) {
  const bars = document.querySelectorAll('.pw-bar');
  const label = document.getElementById('pw-label');
  
  bars.forEach(bar => bar.className = 'pw-bar');
  
  if (!password) {
    label.textContent = '';
    return;
  }
  
  let strength = 0;
  if (password.length >= 6) strength++;
  if (password.length >= 10) strength++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
  if (/\d/.test(password)) strength++;
  if (/[^a-zA-Z\d]/.test(password)) strength++;
  
  if (strength <= 2) {
    bars[0].classList.add('weak');
    label.textContent = 'Слабый';
  } else if (strength === 3) {
    bars[0].classList.add('fair');
    bars[1].classList.add('fair');
    label.textContent = 'Средний';
  } else if (strength === 4) {
    bars[0].classList.add('good');
    bars[1].classList.add('good');
    bars[2].classList.add('good');
    label.textContent = 'Хороший';
  } else {
    bars.forEach(bar => bar.classList.add('strong'));
    label.textContent = 'Надежный';
  }
}

function loginWithGoogle() {
  showToast('Google Auth в разработке. Используйте email/пароль', 'info');
}

function handleLogin(event) {
  event.preventDefault();
  
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  
  if (!email || !password) {
    showToast('Заполните все поля', 'error');
    return;
  }
  
  const users = JSON.parse(localStorage.getItem('kvant-users') || '[]');
  const user = users.find(u => u.email === email && u.password === password);
  
  if (user) {
    STATE.user = { id: user.id, name: user.name, email: user.email };
    saveState();
    startApp();
    showToast(`Добро пожаловать, ${user.name}!`, 'success');
  } else {
    showToast('Неверный email или пароль', 'error');
  }
}

function handleRegister(event) {
  event.preventDefault();
  
  const name = document.getElementById('register-name').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const password = document.getElementById('register-password').value;
  
  if (!name || !email || !password) {
    showToast('Заполните все поля', 'error');
    return;
  }
  
  if (password.length < 6) {
    showToast('Пароль должен содержать минимум 6 символов', 'error');
    return;
  }
  
  const users = JSON.parse(localStorage.getItem('kvant-users') || '[]');
  
  if (users.find(u => u.email === email)) {
    showToast('Email уже зарегистрирован', 'error');
    return;
  }
  
  const newUser = {
    id: Date.now().toString(),
    name,
    email,
    password,
    createdAt: new Date().toISOString()
  };
  
  users.push(newUser);
  localStorage.setItem('kvant-users', JSON.stringify(users));
  
  STATE.user = { id: newUser.id, name: newUser.name, email: newUser.email };
  saveState();
  startApp();
  showToast(`Добро пожаловать, ${name}!`, 'success');
}

function logout() {
  if (confirm('Выйти из аккаунта?')) {
    STATE.user = null;
    STATE.chats = [];
    STATE.currentChatId = null;
    saveState();
    
    document.getElementById('app').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    showToast('Вы вышли из системы', 'success');
  }
}

function startApp() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  
  const avatar = document.getElementById('user-avatar');
  const name = document.getElementById('user-name');
  const email = document.getElementById('user-email');
  const settingsEmail = document.getElementById('settings-user-email');
  
  if (STATE.user) {
    const initials = STATE.user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    avatar.textContent = initials;
    name.textContent = STATE.user.name;
    email.textContent = STATE.user.email;
    if (settingsEmail) settingsEmail.textContent = STATE.user.email;
  }
  
  renderChatsList();
  
  if (STATE.chats.length === 0) {
    createNewChat();
  } else {
    loadChat(STATE.chats[0].id);
  }
}

// =============================================================================
// УПРАВЛЕНИЕ ЧАТАМИ
// =============================================================================

function createNewChat() {
  const chat = {
    id: Date.now().toString(),
    title: 'Новый чат',
    messages: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  
  STATE.chats.unshift(chat);
  STATE.currentChatId = chat.id;
  
  saveState();
  renderChatsList();
  loadChat(chat.id);
  showToast('Создан новый чат', 'success');
}

function renderChatsList() {
  const container = document.getElementById('chats-list');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (STATE.chats.length === 0) {
    container.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.3);"><p>Нет чатов</p></div>';
    return;
  }
  
  STATE.chats.forEach(chat => {
    const item = document.createElement('div');
    item.className = 'chat-item';
    if (chat.id === STATE.currentChatId) item.classList.add('active');
    
    const lastMessage = chat.messages[chat.messages.length - 1];
    const preview = lastMessage ? (lastMessage.content.substring(0, 40) + (lastMessage.content.length > 40 ? '...' : '')) : 'Нет сообщений';
    const date = new Date(chat.updatedAt);
    const timeStr = formatTime(date);
    
    item.innerHTML = `
      <div class="chat-icon">AI</div>
      <div class="chat-info">
        <div class="chat-title">${escapeHtml(chat.title)}</div>
        <div class="chat-preview">${escapeHtml(preview)}</div>
      </div>
      <div class="chat-time">${timeStr}</div>
    `;
    
    item.onclick = () => loadChat(chat.id);
    container.appendChild(item);
  });
}

function loadChat(chatId) {
  STATE.currentChatId = chatId;
  const chat = STATE.chats.find(c => c.id === chatId);
  
  if (!chat) return;
  
  document.getElementById('chat-title').textContent = chat.title;
  renderMessages();
  renderChatsList();
  
  if (window.innerWidth <= 768) closeSidebar();
}

function clearCurrentChat() {
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat) return;
  
  if (confirm('Очистить все сообщения?')) {
    chat.messages = [];
    chat.title = 'Новый чат';
    chat.updatedAt = new Date().toISOString();
    
    saveState();
    renderMessages();
    renderChatsList();
    showToast('Чат очищен', 'success');
  }
}

// =============================================================================
// СООБЩЕНИЯ И AI
// =============================================================================

function renderMessages() {
  const container = document.getElementById('messages-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat) return;
  
  if (chat.messages.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">AI</div>
        <div class="empty-title">Начните новый диалог</div>
        <div class="empty-description">Задайте любой вопрос</div>
      </div>
    `;
    return;
  }
  
  chat.messages.forEach((message, index) => {
    const group = document.createElement('div');
    group.className = `message-group ${message.role}`;
    group.dataset.messageIndex = index;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = message.role === 'user' ? (STATE.user?.name.substring(0, 2).toUpperCase() || 'U') : 'AI';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    if (message.role === 'assistant') {
      content.innerHTML = formatMarkdownWithCodeBlocks(message.content);
    } else {
      content.textContent = message.content;
    }
    
    bubble.appendChild(content);
    
    if (message.timestamp) {
      const time = document.createElement('div');
      time.className = 'message-time';
      time.textContent = formatTime(new Date(message.timestamp));
      bubble.appendChild(time);
    }
    
    // Добавляем кнопки действий
    const actions = document.createElement('div');
    actions.className = 'message-actions';
    
    // Кнопка копирования сообщения
    const copyBtn = document.createElement('button');
    copyBtn.className = 'message-action-btn';
    copyBtn.title = 'Копировать сообщение';
    copyBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
    copyBtn.onclick = () => copyMessageToClipboard(message.content);
    actions.appendChild(copyBtn);
    
    // Кнопка редактирования для пользовательских сообщений
    if (message.role === 'user') {
      const editBtn = document.createElement('button');
      editBtn.className = 'message-action-btn';
      editBtn.title = 'Редактировать';
      editBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>';
      editBtn.onclick = () => editMessage(index);
      actions.appendChild(editBtn);
    }
    
    bubble.appendChild(actions);
    
    group.appendChild(avatar);
    group.appendChild(bubble);
    container.appendChild(group);
  });
  
  container.scrollTop = container.scrollHeight;
}

function formatMarkdown(text) {
  return formatMarkdownWithCodeBlocks(text);
}

function formatMarkdownWithCodeBlocks(text) {
  let html = escapeHtml(text);
  
  // Обрабатываем блоки кода с языком
  html = html.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, lang, code) => {
    const language = lang || 'code';
    const codeId = 'code-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    let buttons = `
      <div class="code-actions">
        <button class="code-action-btn" onclick="copyCode('${codeId}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
          Копировать
        </button>`;
    
    // Добавляем кнопку "Открыть" только для HTML
    if (language.toLowerCase() === 'html') {
      buttons += `
        <button class="code-action-btn" onclick="openHtmlInBrowser('${codeId}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
          Открыть
        </button>`;
    }
    
    buttons += '</div>';
    
    return `
      <div class="code-block-wrapper">
        <div class="code-header">
          <span class="code-language">${language}</span>
          ${buttons}
        </div>
        <pre><code id="${codeId}">${code}</code></pre>
      </div>`;
  });
  
  // Инлайн код
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Жирный текст
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  
  // Курсив
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  
  // Переносы строк
  html = html.replace(/\n/g, '<br>');
  
  return html;
}

async function sendMessage() {
  if (STATE.isGenerating) return;
  
  const input = document.getElementById('chat-input');
  if (!input) return;
  
  const content = input.value.trim();
  if (!content) return;
  
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat) return;
  
  chat.messages.push({
    role: 'user',
    content: content,
    timestamp: new Date().toISOString()
  });
  
  if (chat.messages.length === 1) {
    chat.title = content.substring(0, 40) + (content.length > 40 ? '...' : '');
  }
  
  chat.updatedAt = new Date().toISOString();
  
  input.value = '';
  input.style.height = 'auto';
  
  saveState();
  renderMessages();
  renderChatsList();
  
  STATE.isGenerating = true;
  document.getElementById('send-button').disabled = true;
  
  showTypingIndicator();
  
  try {
    const response = await fetch(API_CONFIG.GROQ_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_CONFIG.GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: STATE.config.model,
        messages: [
          { role: 'system', content: STATE.config.systemPrompt },
          ...chat.messages.map(m => ({ role: m.role, content: m.content }))
        ],
        temperature: 0.7,
        max_tokens: 2048,
        stream: true
      })
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }
    
    hideTypingIndicator();
    
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let assistantMessage = '';
    
    chat.messages.push({
      role: 'assistant',
      content: '',
      timestamp: new Date().toISOString()
    });
    
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      
      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6);
          if (data === '[DONE]') continue;
          
          try {
            const json = JSON.parse(data);
            const delta = json.choices[0]?.delta?.content || '';
            if (delta) {
              assistantMessage += delta;
              chat.messages[chat.messages.length - 1].content = assistantMessage;
              renderMessages();
            }
          } catch (e) {
            // Игнорируем ошибки парсинга
          }
        }
      }
    }
    
    chat.updatedAt = new Date().toISOString();
    saveState();
    renderChatsList();
    
  } catch (error) {
    console.error('Ошибка API:', error);
    hideTypingIndicator();
    
    chat.messages.push({
      role: 'assistant',
      content: 'Извините, произошла ошибка при обработке запроса. Пожалуйста, попробуйте еще раз.',
      timestamp: new Date().toISOString()
    });
    
    saveState();
    renderMessages();
    showToast('Ошибка при отправке сообщения', 'error');
  } finally {
    STATE.isGenerating = false;
    document.getElementById('send-button').disabled = false;
  }
}

function showTypingIndicator() {
  const container = document.getElementById('messages-container');
  if (!container) return;
  
  const group = document.createElement('div');
  group.className = 'message-group assistant';
  group.id = 'typing-indicator';
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = 'AI';
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  
  const typing = document.createElement('div');
  typing.className = 'typing-indicator';
  typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  
  bubble.appendChild(typing);
  group.appendChild(avatar);
  group.appendChild(bubble);
  container.appendChild(group);
  
  container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typing-indicator');
  if (indicator) indicator.remove();
}

function handleInputKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey && STATE.config.enterSend) {
    event.preventDefault();
    sendMessage();
  }
}

function autoResizeInput(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

// =============================================================================
// UI УТИЛИТЫ
// =============================================================================

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-backdrop').classList.toggle('active');
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-backdrop').classList.remove('active');
}

function toggleSettings() {
  document.getElementById('settings-modal').classList.toggle('hidden');
}

function updateModel() {
  STATE.config.model = document.getElementById('model-select').value;
  saveState();
  showToast('Модель обновлена', 'success');
}

function updateSystemPrompt() {
  STATE.config.systemPrompt = document.getElementById('system-prompt').value;
  saveState();
  showToast('Промпт обновлен', 'success');
}

function exportChats() {
  const data = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    user: STATE.user,
    chats: STATE.chats,
    config: STATE.config
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `kvant-ai-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Чаты экспортированы', 'success');
}

function importChats() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        
        if (data.chats && Array.isArray(data.chats)) {
          const importedIds = new Set(data.chats.map(c => c.id));
          STATE.chats = [...data.chats, ...STATE.chats.filter(c => !importedIds.has(c.id))];
          
          saveState();
          renderChatsList();
          showToast(`Импортировано ${data.chats.length} чатов`, 'success');
        } else {
          showToast('Неверный формат файла', 'error');
        }
      } catch (error) {
        showToast('Ошибка импорта: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function clearAllData() {
  if (confirm('Удалить все данные безвозвратно?')) {
    if (confirm('Последнее предупреждение!')) {
      localStorage.clear();
      location.reload();
    }
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icons = {
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>',
  };
  
  toast.innerHTML = `
    <div class="toast-icon">${icons[type] || icons.success}</div>
    <div class="toast-message">${escapeHtml(message)}</div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.transition = 'all 0.3s ease';
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatTime(date) {
  const now = new Date();
  const diff = now - date;
  
  if (diff < 60000) return 'сейчас';
  if (diff < 3600000) return Math.floor(diff / 60000) + ' мин';
  if (diff < 86400000) return Math.floor(diff / 3600000) + ' ч';
  if (diff < 604800000) return Math.floor(diff / 86400000) + ' д';
  
  return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

// =============================================================================
// ЧАСТИЦЫ НА ФОНЕ АУТЕНТИФИКАЦИИ
// =============================================================================

function initAuthParticles() {
  const canvas = document.getElementById('auth-particles');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  
  resize();
  window.addEventListener('resize', resize);
  
  const particles = [];
  for (let i = 0; i < 50; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      radius: Math.random() * 1.8 + 0.8,
      opacity: Math.random() * 0.4 + 0.2
    });
  }
  
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      
      if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
      
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(10, 132, 255, ${p.opacity})`;
      ctx.fill();
    });
    
    requestAnimationFrame(animate);
  }
  
  animate();
}

// =============================================================================
// ИНИЦИАЛИЗАЦИЯ
// =============================================================================

function initLoadingScreen() {
  setTimeout(() => {
    document.getElementById('loading-screen').classList.add('hidden');
    
    if (STATE.user) {
      startApp();
    } else {
      document.getElementById('auth-screen').classList.remove('hidden');
    }
  }, 2600);
}

window.addEventListener('load', () => {
  console.log('%c⚛️ KVANT AI', 'font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #0a84ff, #bf5af2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: Inter;');
  console.log('%c✨ Sistema initialized', 'color: #10b981; font-size: 16px; font-weight: 600;');
  
  loadState();
  initLoadingScreen();
  initAuthParticles();
});

document.addEventListener('keydown', (event) => {
  if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
    event.preventDefault();
    if (!document.getElementById('app').classList.contains('hidden')) createNewChat();
  }
  
  if (event.key === 'Escape') {
    const settingsModal = document.getElementById('settings-modal');
    if (!settingsModal.classList.contains('hidden')) toggleSettings();
    if (window.innerWidth <= 768) closeSidebar();
  }
});

// =============================================================================
// НОВЫЕ ФУНКЦИИ - Копирование, редактирование, открытие HTML
// =============================================================================

// Копирование кода из блока
function copyCode(codeId) {
  const codeElement = document.getElementById(codeId);
  if (!codeElement) return;
  
  const code = codeElement.textContent;
  navigator.clipboard.writeText(code).then(() => {
    showToast('Код скопирован!', 'success');
    
    // Меняем кнопку на "Скопировано"
    const button = event.target.closest('.code-action-btn');
    if (button) {
      const originalHTML = button.innerHTML;
      button.classList.add('success');
      button.innerHTML = `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        Скопировано
      `;
      
      setTimeout(() => {
        button.classList.remove('success');
        button.innerHTML = originalHTML;
      }, 2000);
    }
  }).catch(err => {
    showToast('Ошибка копирования', 'error');
  });
}

// Открытие HTML в браузере
function openHtmlInBrowser(codeId) {
  const codeElement = document.getElementById(codeId);
  if (!codeElement) return;
  
  const htmlCode = codeElement.textContent;
  const blob = new Blob([htmlCode], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  
  window.open(url, '_blank');
  showToast('HTML открыт в новой вкладке', 'success');
  
  // Очищаем URL через 1 минуту
  setTimeout(() => URL.revokeObjectURL(url), 60000);
}

// Копирование всего сообщения
function copyMessageToClipboard(content) {
  navigator.clipboard.writeText(content).then(() => {
    showToast('Сообщение скопировано!', 'success');
  }).catch(err => {
    showToast('Ошибка копирования', 'error');
  });
}

// Редактирование сообщения
function editMessage(messageIndex) {
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat || !chat.messages[messageIndex]) return;
  
  const message = chat.messages[messageIndex];
  if (message.role !== 'user') return; // Редактируем только свои сообщения
  
  // Создаем модальное окно
  const modal = document.createElement('div');
  modal.className = 'edit-modal';
  modal.innerHTML = `
    <div class="edit-modal-content">
      <div class="edit-modal-header">Редактировать сообщение</div>
      <textarea class="edit-textarea" id="edit-textarea">${escapeHtml(message.content)}</textarea>
      <div class="edit-modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Отмена</button>
        <button class="btn btn-primary" onclick="saveEditedMessage(${messageIndex})">Сохранить</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Фокус на textarea
  setTimeout(() => {
    const textarea = document.getElementById('edit-textarea');
    if (textarea) {
      textarea.focus();
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
  }, 100);
  
  // Закрытие по клику вне модального окна
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeEditModal();
    }
  });
  
  // Закрытие по Escape
  const escapeHandler = (e) => {
    if (e.key === 'Escape') {
      closeEditModal();
      document.removeEventListener('keydown', escapeHandler);
    }
  };
  document.addEventListener('keydown', escapeHandler);
}

function closeEditModal() {
  const modal = document.querySelector('.edit-modal');
  if (modal) {
    modal.remove();
  }
}

function saveEditedMessage(messageIndex) {
  const textarea = document.getElementById('edit-textarea');
  if (!textarea) return;
  
  const newContent = textarea.value.trim();
  if (!newContent) {
    showToast('Сообщение не может быть пустым', 'error');
    return;
  }
  
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat || !chat.messages[messageIndex]) return;
  
  // Удаляем все сообщения после отредактированного
  chat.messages = chat.messages.slice(0, messageIndex);
  
  // Добавляем отредактированное сообщение
  chat.messages.push({
    role: 'user',
    content: newContent,
    timestamp: new Date().toISOString()
  });
  
  chat.updatedAt = new Date().toISOString();
  
  saveState();
  renderMessages();
  renderChatsList();
  closeEditModal();
  
  showToast('Сообщение отредактировано. Отправьте новый запрос.', 'success');
}

</script>

</body>
</html>
<!-- =============================================================================
     ДОПОЛНИТЕЛЬНЫЙ ФУНКЦИОНАЛ
     ============================================================================= -->

<script>
// =============================================================================
// РАСШИРЕННЫЕ ФУНКЦИИ РАБОТЫ С ЧАТАМИ
// =============================================================================

function renameChat(chatId) {
  const chat = STATE.chats.find(c => c.id === chatId);
  if (!chat) return;
  
  const newTitle = prompt('Введите новое название чата:', chat.title);
  if (newTitle && newTitle.trim()) {
    chat.title = newTitle.trim();
    chat.updatedAt = new Date().toISOString();
    saveState();
    renderChatsList();
    if (chatId === STATE.currentChatId) {
      document.getElementById('chat-title').textContent = chat.title;
    }
    showToast('Чат переименован', 'success');
  }
}

function deleteChat(chatId) {
  if (!confirm('Удалить этот чат?')) return;
  
  STATE.chats = STATE.chats.filter(c => c.id !== chatId);
  
  if (STATE.currentChatId === chatId) {
    if (STATE.chats.length > 0) {
      loadChat(STATE.chats[0].id);
    } else {
      createNewChat();
    }
  }
  
  saveState();
  renderChatsList();
  showToast('Чат удален', 'success');
}

function duplicateChat(chatId) {
  const chat = STATE.chats.find(c => c.id === chatId);
  if (!chat) return;
  
  const duplicatedChat = {
    id: Date.now().toString(),
    title: chat.title + ' (копия)',
    messages: JSON.parse(JSON.stringify(chat.messages)),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  
  STATE.chats.unshift(duplicatedChat);
  saveState();
  renderChatsList();
  showToast('Чат скопирован', 'success');
}

function exportChat(chatId) {
  const chat = STATE.chats.find(c => c.id === chatId);
  if (!chat) return;
  
  const data = {
    title: chat.title,
    messages: chat.messages,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat-${chat.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Чат экспортирован', 'success');
}

function searchChats(query) {
  const lowerQuery = query.toLowerCase();
  const filtered = STATE.chats.filter(chat => 
    chat.title.toLowerCase().includes(lowerQuery) ||
    chat.messages.some(m => m.content.toLowerCase().includes(lowerQuery))
  );
  
  const container = document.getElementById('chats-list');
  container.innerHTML = '';
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: rgba(255,255,255,0.3);"><p>Ничего не найдено</p></div>';
    return;
  }
  
  filtered.forEach(chat => {
    const item = document.createElement('div');
    item.className = 'chat-item';
    if (chat.id === STATE.currentChatId) item.classList.add('active');
    
    const lastMessage = chat.messages[chat.messages.length - 1];
    const preview = lastMessage ? (lastMessage.content.substring(0, 40) + '...') : 'Нет сообщений';
    const timeStr = formatTime(new Date(chat.updatedAt));
    
    item.innerHTML = `
      <div class="chat-icon">AI</div>
      <div class="chat-info">
        <div class="chat-title">${escapeHtml(chat.title)}</div>
        <div class="chat-preview">${escapeHtml(preview)}</div>
      </div>
      <div class="chat-time">${timeStr}</div>
    `;
    
    item.onclick = () => loadChat(chat.id);
    container.appendChild(item);
  });
}

// =============================================================================
// РАБОТА С СООБЩЕНИЯМИ
// =============================================================================

function copyMessage(content) {
  navigator.clipboard.writeText(content).then(() => {
    showToast('Сообщение скопировано', 'success');
  }).catch(() => {
    showToast('Ошибка при копировании', 'error');
  });
}

function editMessage(messageIndex) {
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat || !chat.messages[messageIndex]) return;
  
  const message = chat.messages[messageIndex];
  if (message.role !== 'user') return;
  
  const newContent = prompt('Редактировать сообщение:', message.content);
  if (newContent && newContent.trim()) {
    message.content = newContent.trim();
    chat.messages = chat.messages.slice(0, messageIndex + 1);
    chat.updatedAt = new Date().toISOString();
    
    saveState();
    renderMessages();
    showToast('Сообщение отредактировано', 'success');
  }
}

function deleteMessage(messageIndex) {
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat || !chat.messages[messageIndex]) return;
  
  if (!confirm('Удалить это сообщение?')) return;
  
  chat.messages.splice(messageIndex, 1);
  chat.updatedAt = new Date().toISOString();
  
  saveState();
  renderMessages();
  showToast('Сообщение удалено', 'success');
}

function regenerateResponse() {
  const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
  if (!chat || chat.messages.length < 2) return;
  
  const lastMessage = chat.messages[chat.messages.length - 1];
  if (lastMessage.role === 'assistant') {
    chat.messages.pop();
  }
  
  saveState();
  renderMessages();
  sendMessage();
}

// =============================================================================
// СИСТЕМНЫЕ ПРОМПТЫ
// =============================================================================

const SYSTEM_PROMPTS = {
  default: 'Вы - KVANT AI, умный и полезный ассистент. Отвечайте кратко, четко и профессионально.',
  creative: 'Вы - творческий ассистент, который помогает генерировать креативные идеи, истории и контент.',
  technical: 'Вы - технический эксперт, специализирующийся на программировании, DevOps и системной архитектуре.',
  teacher: 'Вы - терпеливый учитель, который объясняет сложные концепции простым языком с примерами.',
  analyzer: 'Вы - аналитик данных, который помогает анализировать информацию и делать обоснованные выводы.',
  translator: 'Вы - профессиональный переводчик, который точно переводит тексты с сохранением стиля и контекста.'
};

function selectSystemPrompt(type) {
  STATE.config.systemPrompt = SYSTEM_PROMPTS[type] || SYSTEM_PROMPTS.default;
  document.getElementById('system-prompt').value = STATE.config.systemPrompt;
  saveState();
  showToast('Системный промпт обновлен', 'success');
}

// =============================================================================
// ТЕМЫ ОФОРМЛЕНИЯ
// =============================================================================

const THEMES = {
  cosmic: {
    name: 'Космическая',
    background: 'radial-gradient(ellipse at bottom, #1a1f35 0%, #0a0e1a 100%)',
    primary: '#0a84ff',
    secondary: '#bf5af2'
  },
  forest: {
    name: 'Лесная',
    background: 'radial-gradient(ellipse at bottom, #1a2f1a 0%, #0a140a 100%)',
    primary: '#10b981',
    secondary: '#059669'
  },
  ocean: {
    name: 'Океанская',
    background: 'radial-gradient(ellipse at bottom, #1a2f3f 0%, #0a1419 100%)',
    primary: '#06b6d4',
    secondary: '#0891b2'
  },
  sunset: {
    name: 'Закат',
    background: 'radial-gradient(ellipse at bottom, #3f1a2f 0%, #190a14 100%)',
    primary: '#f43f5e',
    secondary: '#e11d48'
  }
};

function changeTheme(themeName) {
  const theme = THEMES[themeName];
  if (!theme) return;
  
  document.querySelector('.space-background').style.background = theme.background;
  document.documentElement.style.setProperty('--color-primary', theme.primary);
  document.documentElement.style.setProperty('--color-secondary', theme.secondary);
  
  STATE.config.theme = themeName;
  saveState();
  showToast(`Тема "${theme.name}" применена`, 'success');
}

// =============================================================================
// СТАТИСТИКА
// =============================================================================

function getStatistics() {
  const totalChats = STATE.chats.length;
  const totalMessages = STATE.chats.reduce((sum, chat) => sum + chat.messages.length, 0);
  const userMessages = STATE.chats.reduce((sum, chat) => 
    sum + chat.messages.filter(m => m.role === 'user').length, 0);
  const aiMessages = STATE.chats.reduce((sum, chat) => 
    sum + chat.messages.filter(m => m.role === 'assistant').length, 0);
  
  const totalWords = STATE.chats.reduce((sum, chat) => 
    sum + chat.messages.reduce((msgSum, m) => 
      msgSum + m.content.split(/\s+/).length, 0), 0);
  
  const avgMessagesPerChat = totalChats > 0 ? (totalMessages / totalChats).toFixed(1) : 0;
  
  return {
    totalChats,
    totalMessages,
    userMessages,
    aiMessages,
    totalWords,
    avgMessagesPerChat
  };
}

function showStatistics() {
  const stats = getStatistics();
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Статистика</h2>
        <button class="btn-close" onclick="this.closest('.modal').remove()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3 class="section-title">Общая информация</h3>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Всего чатов</div>
            </div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-primary);">${stats.totalChats}</div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Всего сообщений</div>
            </div>
            <div style="font-size: 24px; font-weight: 700; color: var(--color-primary);">${stats.totalMessages}</div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Ваших сообщений</div>
            </div>
            <div style="font-size: 20px; font-weight: 600; color: rgba(255,255,255,0.7);">${stats.userMessages}</div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Ответов AI</div>
            </div>
            <div style="font-size: 20px; font-weight: 600; color: rgba(255,255,255,0.7);">${stats.aiMessages}</div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Всего слов</div>
            </div>
            <div style="font-size: 20px; font-weight: 600; color: rgba(255,255,255,0.7);">${stats.totalWords.toLocaleString()}</div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-label">Среднее сообщений на чат</div>
            </div>
            <div style="font-size: 20px; font-weight: 600; color: rgba(255,255,255,0.7);">${stats.avgMessagesPerChat}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// =============================================================================
// ЭКСПОРТ В РАЗЛИЧНЫХ ФОРМАТАХ
// =============================================================================

function exportChatAsText(chatId) {
  const chat = STATE.chats.find(c => c.id === chatId);
  if (!chat) return;
  
  let text = `Чат: ${chat.title}\n`;
  text += `Дата создания: ${new Date(chat.createdAt).toLocaleString('ru-RU')}\n`;
  text += `\n${'='.repeat(60)}\n\n`;
  
  chat.messages.forEach((message, index) => {
    const role = message.role === 'user' ? 'Вы' : 'KVANT AI';
    const timestamp = new Date(message.timestamp).toLocaleTimeString('ru-RU');
    text += `[${timestamp}] ${role}:\n${message.content}\n\n`;
  });
  
  const blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat-${chat.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Чат экспортирован в TXT', 'success');
}

function exportChatAsMarkdown(chatId) {
  const chat = STATE.chats.find(c => c.id === chatId);
  if (!chat) return;
  
  let markdown = `# ${chat.title}\n\n`;
  markdown += `**Дата создания:** ${new Date(chat.createdAt).toLocaleString('ru-RU')}\n\n`;
  markdown += `---\n\n`;
  
  chat.messages.forEach((message, index) => {
    const role = message.role === 'user' ? '**Вы**' : '**KVANT AI**';
    const timestamp = new Date(message.timestamp).toLocaleTimeString('ru-RU');
    markdown += `### ${role} (${timestamp})\n\n`;
    markdown += `${message.content}\n\n`;
  });
  
  const blob = new Blob([markdown], { type: 'text/markdown; charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `chat-${chat.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.md`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('Чат экспортирован в Markdown', 'success');
}

// =============================================================================
// ГОЛОСОВОЙ ВВОД
// =============================================================================

let recognition = null;
let isRecording = false;

function initSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    return false;
  }
  
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'ru-RU';
  
  recognition.onstart = () => {
    isRecording = true;
    showToast('Слушаю...', 'info');
  };
  
  recognition.onresult = (event) => {
    const transcript = Array.from(event.results)
      .map(result => result[0])
      .map(result => result.transcript)
      .join('');
    
    document.getElementById('chat-input').value = transcript;
  };
  
  recognition.onerror = (event) => {
    isRecording = false;
    showToast('Ошибка распознавания речи', 'error');
  };
  
  recognition.onend = () => {
    isRecording = false;
  };
  
  return true;
}

function toggleSpeechRecognition() {
  if (!recognition) {
    if (!initSpeechRecognition()) {
      showToast('Голосовой ввод не поддерживается', 'error');
      return;
    }
  }
  
  if (isRecording) {
    recognition.stop();
  } else {
    recognition.start();
  }
}

// =============================================================================
// АВТОСОХРАНЕНИЕ
// =============================================================================

let autoSaveInterval = null;

function startAutoSave() {
  if (autoSaveInterval) return;
  
  autoSaveInterval = setInterval(() => {
    saveState();
  }, 30000); // Каждые 30 секунд
}

function stopAutoSave() {
  if (autoSaveInterval) {
    clearInterval(autoSaveInterval);
    autoSaveInterval = null;
  }
}

// =============================================================================
// ГОРЯЧИЕ КЛАВИШИ
// =============================================================================

const SHORTCUTS = {
  'Ctrl+K': createNewChat,
  'Ctrl+D': () => deleteChat(STATE.currentChatId),
  'Ctrl+E': () => exportChat(STATE.currentChatId),
  'Ctrl+/': toggleSettings,
  'Ctrl+F': () => {
    const query = prompt('Поиск по чатам:');
    if (query) searchChats(query);
  },
  'Escape': () => {
    closeSidebar();
    const modal = document.querySelector('.modal:not(.hidden)');
    if (modal) modal.classList.add('hidden');
  }
};

function handleShortcut(event) {
  const key = `${event.ctrlKey || event.metaKey ? 'Ctrl+' : ''}${event.key}`;
  const handler = SHORTCUTS[key];
  
  if (handler) {
    event.preventDefault();
    handler();
  }
}

// =============================================================================
// КЭШИРОВАНИЕ
// =============================================================================

const CACHE = {
  models: null,
  prompts: null,
  lastUpdate: null
};

function updateCache(key, value) {
  CACHE[key] = value;
  CACHE.lastUpdate = Date.now();
}

function getCachedData(key, maxAge = 3600000) { // 1 час по умолчанию
  if (!CACHE.lastUpdate || Date.now() - CACHE.lastUpdate > maxAge) {
    return null;
  }
  return CACHE[key];
}

// =============================================================================
// ВАЛИДАЦИЯ
// =============================================================================

function validateMessage(content) {
  if (!content || content.trim().length === 0) {
    return { valid: false, error: 'Сообщение не может быть пустым' };
  }
  
  if (content.length > 10000) {
    return { valid: false, error: 'Сообщение слишком длинное (макс. 10000 символов)' };
  }
  
  return { valid: true };
}

function validateChatTitle(title) {
  if (!title || title.trim().length === 0) {
    return { valid: false, error: 'Название не может быть пустым' };
  }
  
  if (title.length > 100) {
    return { valid: false, error: 'Название слишком длинное (макс. 100 символов)' };
  }
  
  return { valid: true };
}

// =============================================================================
// ДОПОЛНИТЕЛЬНЫЕ УТИЛИТЫ
// =============================================================================

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function throttle(func, limit) {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function sanitizeFilename(filename) {
  return filename.replace(/[^a-z0-9]/gi, '-').toLowerCase();
}

function truncateText(text, maxLength) {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// =============================================================================
// ИНИЦИАЛИЗАЦИЯ ДОПОЛНИТЕЛЬНЫХ ФУНКЦИЙ
// =============================================================================

document.addEventListener('DOMContentLoaded', () => {
  startAutoSave();
  initSpeechRecognition();
  
  document.addEventListener('keydown', handleShortcut);
  
  const searchInput = document.getElementById('search-input');
  if (searchInput) {
    searchInput.addEventListener('input', debounce((e) => {
      searchChats(e.target.value);
    }, 300));
  }
  
  // Мобильная адаптация - обработка фокуса на input
  const chatInput = document.getElementById('chat-input');
  if (chatInput) {
    // Предотвращаем скролл при фокусе на iOS
    chatInput.addEventListener('focus', () => {
      setTimeout(() => {
        chatInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
    
    // Автоматическая подстройка высоты textarea
    chatInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
  }
  
  // Обработка изменения размера окна (ориентация на мобильных)
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      // Закрываем сайдбар при изменении ориентации на мобильных
      if (window.innerWidth <= 768) {
        closeSidebar();
      }
    }, 250);
  });
  
  // Обработка кнопки отправки для мобильных устройств
  const sendButton = document.getElementById('send-button');
  if (sendButton) {
    // Добавляем touchstart для лучшей отзывчивости на мобильных
    sendButton.addEventListener('touchstart', (e) => {
      e.preventDefault(); // Предотвращаем двойное срабатывание
      if (!STATE.isGenerating) {
        sendMessage();
      }
    }, { passive: false });
    
    // Оставляем click для desktop
    sendButton.addEventListener('click', (e) => {
      if (!STATE.isGenerating) {
        sendMessage();
      }
    });
  }
  
  // Закрытие сайдбара при клике вне его на мобильных
  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
      const sidebar = document.getElementById('sidebar');
      const menuBtn = document.getElementById('menu-btn');
      
      if (sidebar && sidebar.classList.contains('open') && 
          !sidebar.contains(e.target) && 
          !menuBtn.contains(e.target)) {
        closeSidebar();
      }
    }
  });
});
